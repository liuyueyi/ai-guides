---
order: 5
title: D05.ä»0åˆ°1å®ç°ä¸€ä¸ªå¾®ä¿¡çº¢åŒ…å°é¢è®¾è®¡Agent
tag:
  - Spring
  - SpringAI
category:
  - SpringAI
date: 2026-02-10 12:15:07
keywords: SpringAI
---

# æˆ‘ç”¨SpringAIå®ç°äº†ä¸ªã€Œå¾®ä¿¡çº¢åŒ…å°é¢è®¾è®¡Agentã€

å¹´åº•æ”¶åˆ°äº†å¾®ä¿¡ç»™å…¬ä¼—å·å…è´¹å‘çš„ä¸€æ³¢çº¢åŒ…å°é¢å…‘æ¢å¡ï¼Œæ­£å¥½ä¸Šæ¬¡åœ¨å­¦ä¹ SpringAIçš„æ—¶å€™ï¼Œçœ‹åˆ°äº†ä¸€ä¸ªæœ‰è¶£çš„æœºåˆ¶â€”â€”å¤§æ¨¡å‹çš„å“åº”å‰é—®è¯¢ï¼Œè¿™ä¸æ˜¯å°±æ˜¯ä¸€ä¸ªç»ä½³çš„åº”ç”¨åœºæ™¯å˜›~

è®©AIæ¥æ‰®æ¼”ä¸€ä¸ªè®¾è®¡å¸ˆï¼Œé€šè¿‡ä¸æˆ‘çš„å¯¹è¯æ¥æ•²å®šæˆ‘æƒ³è¦çš„çº¢åŒ…å°é¢ï¼Œç„¶ååŸºäºè¿™ä¸ªè®¾è®¡æ–¹æ¡ˆæ¥ç”Ÿæˆå¯¹åº”çš„çº¢åŒ…å°é¢ï¼Œæ¥ä¸ªä¸€ç«™å¼çš„å¾®ä¿¡çº¢åŒ…å°é¢ç”ŸæˆAgent



## ä¸€ã€æ•ˆæœä½“éªŒ

çº¿ä¸Šä½“éªŒåœ°å€ï¼š [https://api.ppai.top/](https://api.ppai.top/)

é»˜è®¤è¿›å…¥ä¹‹åé•¿è¿™æ ·ï¼ˆå‰ç«¯é¡µé¢ç”±Kimiç”Ÿæˆï¼‰,é€šè¿‡ç‚¹å‡»å³å°è§’çš„å¯¹è¯æŒ‰é’®å”¤å‡ºè®¾è®¡æ¡†

![](/imgs/column/springai/D05-1.webp)

æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡å¯¹è¯æ¥æ¼”ç¤ºä¸€ä¸‹å…·ä½“çš„æ•ˆæœ

> å…¬ä¼—å·æŸ¥çœ‹ï¼š [æˆ‘ç”¨SpringAIå®ç°äº†ä¸ªã€Œå¾®ä¿¡çº¢åŒ…å°é¢è®¾è®¡Agentã€ | ä¸€ç°ç°blog](https://mp.weixin.qq.com/s/QyuWZ4EZ32pbcWn3fVphHQ)



## äºŒã€æ™ºèƒ½çº¢åŒ…å°é¢è®¾è®¡

### 2.1 æ•´ä½“ä»‹ç»

è¿™æ˜¯ä¸€ä¸ªåŸºäºSpring AIå¼€å‘çš„å®Œæ•´åº”ç”¨ï¼Œå®ƒèƒ½è®©AIåƒä¸“ä¸šè®¾è®¡å¸ˆä¸€æ ·ï¼Œé€šè¿‡å¤šè½®å¯¹è¯ç†è§£ä½ çš„éœ€æ±‚ï¼Œç„¶åç›´æ¥ç”Ÿæˆç¬¦åˆè¦æ±‚çš„çº¢åŒ…å°é¢ã€‚æ•´ä¸ªè¿‡ç¨‹å°±åƒå’Œä¸€ä¸ªæ‡‚è®¾è®¡çš„æœ‹å‹èŠå¤©ï¼Œä½ è¯´æƒ³æ³•ï¼Œå®ƒæ¥å®ç°ã€‚

ç³»ç»Ÿçš„æ ¸å¿ƒäº®ç‚¹æ˜¯"ä¼šæé—®çš„AI"ã€‚å½“ä½ è¯´"å¸®æˆ‘åšä¸ªçº¢åŒ…å°é¢"æ—¶ï¼Œå®ƒä¸ä¼šç›²ç›®çŒœæµ‹ï¼Œè€Œæ˜¯ä¸»åŠ¨è¯¢é—®ï¼š"ä½ æƒ³è¦ä»€ä¹ˆé£æ ¼ï¼Ÿä¼ ç»Ÿå›½é£è¿˜æ˜¯ç°ä»£ç®€çº¦ï¼Ÿ""ä¸»è‰²è°ƒåå‘çº¢è‰²è¿˜æ˜¯é‡‘è‰²ï¼Ÿ"é€šè¿‡è¿™äº›é—®é¢˜ï¼ŒAIèƒ½å‡†ç¡®æŠŠæ¡ä½ çš„éœ€æ±‚ã€‚


### 2.2 æ¶æ„è®¾è®¡

é¡¹ç›®é‡‡ç”¨äº†ä¸‰å±‚æ¶æ„è®¾è®¡ï¼š

- å¯¹è¯å±‚ï¼šä½¿ç”¨AskUserQuestionToolå·¥å…·ï¼Œè®©AIå…·å¤‡ä¸»åŠ¨æé—®èƒ½åŠ›ã€‚å°±åƒè®¾è®¡å¸ˆä¼šé€šè¿‡æé—®äº†è§£å®¢æˆ·éœ€æ±‚ä¸€æ ·ï¼Œæˆ‘ä»¬çš„AIä¹Ÿä¼šä¸€æ­¥æ­¥æ¾„æ¸…è®¾è®¡è¦æ±‚ã€‚
- ç”Ÿæˆå±‚ï¼šé›†æˆé˜¿é‡Œäº‘åƒé—®çš„æ–‡ç”Ÿå›¾APIï¼Œå°†æ–‡å­—æè¿°è½¬æ¢ä¸ºè§†è§‰å›¾åƒã€‚ç‰¹åˆ«é’ˆå¯¹å¾®ä¿¡çº¢åŒ…å°é¢çš„3x4æ¯”ä¾‹(å¾®ä¿¡çº¢åŒ…å°é¢å°ºå¯¸=957Ã—1278)è¿›è¡Œäº†ä¼˜åŒ–ã€‚
- äº¤äº’å±‚ï¼šé€šè¿‡SSEï¼ˆæœåŠ¡å™¨å‘é€äº‹ä»¶ï¼‰æŠ€æœ¯å®ç°å®æ—¶å¯¹è¯ï¼Œç”¨æˆ·èƒ½çœ‹åˆ°AIæ€è€ƒå’Œå›åº”çš„å®Œæ•´è¿‡ç¨‹ï¼Œä½“éªŒéå¸¸æµç•…ã€‚

![](/imgs/column/springai/D05-2.webp)

```mermaid
graph TD
    %% ç»Ÿä¸€æ ·å¼å®šä¹‰ï¼ˆä¿ç•™åŸæœ‰ç¾åŒ–ä½“ç³»ï¼Œå¾®è°ƒç»†èŠ‚ï¼‰
    classDef uiLayer fill:#E1F5FE,color:#2D3748,stroke:#0288D1,stroke-width:2px,rx:8,ry:8,font-weight:500
    classDef chatLayer fill:#F3E5F5,color:#2D3748,stroke:#8E24AA,stroke-width:2px,rx:8,ry:8
    classDef prodLayer fill:#E8F5E8,color:#2D3748,stroke:#48BB78,stroke-width:2px,rx:8,ry:8
    classDef interLayer fill:#FFF3E0,color:#2D3748,stroke:#F57C00,stroke-width:2px,rx:8,ry:8
    classDef subNode fill:#FFFFFF,color:#4A5568,stroke:#CBD5E0,stroke-width:1px,rx:6,ry:6
    classDef linkNode fill:#FAFAFA,color:#2D3748,stroke:#718096,stroke-width:1px,rx:6,ry:6,dashed:true

    %% æ ¸å¿ƒå±‚çº§èŠ‚ç‚¹ï¼ˆé¡¶éƒ¨å…¥å£ï¼Œå±…ä¸­ï¼‰
    A["ğŸ–¥ï¸ ç”¨æˆ·ç•Œé¢å±‚<br/>ï¼ˆç”¨æˆ·äº¤äº’å…¥å£ï¼‰"]:::uiLayer
    


    %% ç¬¬ä¸€å±‚å­å›¾ï¼šå¯¹è¯å±‚ï¼ˆå‚ç›´å¸ƒå±€ç¬¬ä¸€ä¸ªï¼Œå­å›¾å†…å¸ƒå±€è§„æ•´ï¼‰
    subgraph SC["ğŸ’¬ å¯¹è¯å±‚ - éœ€æ±‚äº¤äº’æ¨¡å—"]
        style SC fill:#F3E5F520,stroke:#8E24AA,stroke-width:1px,rx:8,ry:8
        B["ğŸ’¬ å¯¹è¯å±‚<br/>ï¼ˆéœ€æ±‚äº¤äº’æ ¸å¿ƒï¼‰"]:::chatLayer
        %% å­èŠ‚ç‚¹å‚ç›´æ’åˆ—åœ¨é¡¶èŠ‚ç‚¹ä¸‹æ–¹ï¼Œç»Ÿä¸€ç¼©è¿›
        B1["â“ AskUserQuestionTool<br/>ï¼ˆç”¨æˆ·æé—®å·¥å…·ï¼‰"]:::subNode
        B2["ğŸ”„ å¤šè½®å¯¹è¯ç®¡ç†<br/>ï¼ˆä¸Šä¸‹æ–‡ç»´æŠ¤ï¼‰"]:::subNode
        B3["ğŸ“ éœ€æ±‚æ¾„æ¸…æœºåˆ¶<br/>ï¼ˆæ„å›¾è¯†åˆ«ï¼‰"]:::subNode
        
        %% å­å›¾å†…éƒ¨å‚ç›´è¿çº¿ï¼ˆè§„æ•´å¯¹é½ï¼‰
        B --> B1
        B1 --> B2
        B2 --> B3
    end

    %% å…³è”èŠ‚ç‚¹ï¼šå›ºå®šåœ¨å¯¹è¯å±‚å³ä¾§ï¼Œé¿å…å¸ƒå±€æ¼‚ç§»
    E["ğŸ’¬ ChatClient<br/>ï¼ˆå¯¹è¯å®¢æˆ·ç«¯ï¼‰"]:::linkNode

    %% è§†è§‰åˆ†éš”çº¿ï¼ˆåŒºåˆ†ä¸åŒå­å›¾ï¼‰

    %% ç¬¬äºŒå±‚å­å›¾ï¼šç”Ÿäº§å±‚ï¼ˆå‚ç›´å¸ƒå±€ç¬¬äºŒä¸ªï¼Œä¸å¯¹è¯å±‚å¸ƒå±€ä¸€è‡´ï¼‰
    subgraph SA["ğŸ¨ ç”Ÿäº§å±‚ - å›¾åƒç”Ÿæˆæ¨¡å—"]
        style SA fill:#E8F5E820,stroke:#48BB78,stroke-width:1px,rx:8,ry:8,margin:10px
        %% å­å›¾é¡¶èŠ‚ç‚¹
        C["ğŸ¨ ç”Ÿäº§å±‚<br/>ï¼ˆå›¾åƒç”Ÿæˆæ ¸å¿ƒï¼‰"]:::prodLayer
        %% å­èŠ‚ç‚¹å‚ç›´æ’åˆ—
        C1["ğŸ“¡ æ–‡ç”Ÿå›¾APIè°ƒç”¨<br/>ï¼ˆæ¥å£å°è£…ï¼‰"]:::subNode
        C2["â˜ï¸ é˜¿é‡Œäº‘åƒé—®é›†æˆ<br/>ï¼ˆæ¨¡å‹å¯¹æ¥ï¼‰"]:::subNode
        C3["âš™ï¸ å›¾åƒç”Ÿæˆå¼•æ“<br/>ï¼ˆæ ¸å¿ƒç”Ÿæˆé€»è¾‘ï¼‰"]:::subNode
        C4["âœ… è´¨é‡æ§åˆ¶æ¨¡å—<br/>ï¼ˆæ•ˆæœæ ¡éªŒï¼‰"]:::subNode
        
        %% å­å›¾å†…éƒ¨å‚ç›´è¿çº¿
        C --> C1
        C1 --> C2
        C2 --> C3
        C3 --> C4
    end

    %% å…³è”èŠ‚ç‚¹ï¼šå›ºå®šåœ¨ç”Ÿäº§å±‚å³ä¾§
    F["ğŸ¨ QwenImgGen<br/>ï¼ˆåƒé—®å›¾åƒç”Ÿæˆå™¨ï¼‰"]:::linkNode

    %% è§†è§‰åˆ†éš”çº¿

    %% ç¬¬ä¸‰å±‚å­å›¾ï¼šäº¤äº’å±‚ï¼ˆå‚ç›´å¸ƒå±€ç¬¬ä¸‰ä¸ªï¼Œå¸ƒå±€ç»Ÿä¸€ï¼‰
    subgraph SB["ğŸ”Œ äº¤äº’å±‚ - å®æ—¶é€šä¿¡æ¨¡å—"]
        style SB fill:#FFF3E020,stroke:#F57C00,stroke-width:1px,rx:8,ry:8,margin:10px
        %% å­å›¾é¡¶èŠ‚ç‚¹
        D["ğŸ”Œ äº¤äº’å±‚<br/>ï¼ˆå®æ—¶é€šä¿¡æ”¯æ’‘ï¼‰"]:::interLayer
        %% å­èŠ‚ç‚¹å‚ç›´æ’åˆ—
        D1["ğŸ“¢ SSEå®æ—¶é€šä¿¡<br/>ï¼ˆæœåŠ¡ç«¯æ¨é€ï¼‰"]:::subNode
        D2["ğŸ“Š æµå¼å“åº”å¤„ç†<br/>ï¼ˆåˆ†æ®µè§£æï¼‰"]:::subNode
        D3["ğŸ”„ å‰ç«¯çŠ¶æ€åŒæ­¥<br/>ï¼ˆæ•°æ®æ›´æ–°ï¼‰"]:::subNode
        D4["âœ¨ ç”¨æˆ·ä½“éªŒä¼˜åŒ–<br/>ï¼ˆåŠ è½½/åé¦ˆï¼‰"]:::subNode
        
        %% å­å›¾å†…éƒ¨å‚ç›´è¿çº¿
        D --> D1
        D1 --> D2
        D2 --> D3
        D3 --> D4
    end

    %% å…³è”èŠ‚ç‚¹ï¼šå›ºå®šåœ¨äº¤äº’å±‚å³ä¾§
    G["ğŸ”Œ WebSocket/SSE<br/>ï¼ˆé€šä¿¡åè®®ï¼‰"]:::linkNode

    %% æ ¸å¿ƒå±‚çº§å‚ç›´è¿çº¿ï¼ˆé¡¶å±‚â†’å„å­å›¾å±‚çº§æ ¸å¿ƒï¼Œè§†è§‰å¼•å¯¼æ¸…æ™°ï¼‰
    A --> B
    B --> C
    C --> D

    %% è™šçº¿å…³è”ï¼ˆå­å›¾å±‚çº§æ ¸å¿ƒâ†’å¯¹åº”å…³è”èŠ‚ç‚¹ï¼Œè¿çº¿æ›´çŸ­æ›´è§„æ•´ï¼‰
    B -.-> E
    C -.-> F
    D -.-> G
```

## ä¸‰ã€æ ¸å¿ƒå®ç°

æ•´ä½“çš„å®ç°æ€è·¯åŸºæœ¬ä¸Šå’Œä¸Šä¸€ç¯‡éå¸¸ç›¸ä¼¼ï¼ŒåŒºåˆ«æ˜¯æ”¹äº†äº¤äº’åƒæ˜¯ï¼Œä»æ§åˆ¶å°æ¨¡å¼æ”¹æˆäº†webæ–¹å¼ï¼Œå…·ä½“ç»†èŠ‚è¯·æŸ¥çœ‹ [Spring AIä¸­çš„å¤šè½®å¯¹è¯è‰ºæœ¯ï¼šè®©å¤§æ¨¡å‹ä¸»åŠ¨æé—®è·å–æ˜ç¡®éœ€æ±‚](https://mp.weixin.qq.com/s/LcvmiIERs6aOIlRAKGGnFg)  æ¥ä¸‹æ¥å°†ä¸»è¦ä»‹ç»ä¸€äº›æ ¸å¿ƒçš„æŠ€æœ¯ç‚¹

### 3.1 å¤šè½®é—®è¯¢æœºåˆ¶

å¦‚ä½•è¯†åˆ«ç”¨æˆ·çš„æ„å›¾ï¼Ÿè¿™å¥½åƒæ˜¯æ¯ä¸ªAgentå¼€å‘å¿…é¡»è§£å†³çš„é—®é¢˜ï¼Œè¿™é‡Œå¯ä»¥è¯´æ˜¯ç»™å‡ºäº†ä¸€ä¸ªç»å…¸çš„è§£å†³æ–¹æ¡ˆï¼Œé‚£å°±æ˜¯ä¸»åŠ¨é—®è¯¢ï¼Œè®©ç”¨æˆ·ä¸»åŠ¨è¿›è¡Œæ¾„æ¸…ï¼Œè¿™é‡Œçš„ä¸»è¦å®ç°åŸç†å¦‚ä¸‹å›¾

![](/imgs/column/springai/A07-0.webp)


è¿™ä¸€å¥—è®¾è®¡å“²å­¦éµå¾ªé—®ç­”å¼å·¥ä½œæµç¨‹ï¼š

1. AIç”Ÿæˆé—®é¢˜
	- æ™ºèƒ½ä½“åˆ¤æ–­éœ€è¦è¾“å…¥å¹¶æ„å»ºé—®é¢˜ï¼ˆæ¯ä¸ªé—®é¢˜åŒ…å«é—®é¢˜æ–‡æœ¬ã€æ ‡é¢˜ã€2-4ä¸ªé€‰é¡¹å’Œå¤šé€‰æ ‡å¿—ï¼‰ï¼Œç„¶åè°ƒç”¨`AskUserQuestionTool`å‡½æ•°
2. ç”¨æˆ·æä¾›ç­”æ¡ˆ 
	- ç”±ä¸šåŠ¡ä»£ç å®ç°æ¥æ”¶è¿™äº›é—®é¢˜ï¼Œç„¶åé€šè¿‡åˆé€‚çš„å½¢å¼ï¼ˆæ§åˆ¶å°/webé¡µé¢ç­‰ï¼‰å±•ç¤ºç»™ç”¨æˆ·ï¼Œç„¶åæ”¶é›†ç”¨æˆ·çš„å›ç­”ï¼Œå¹¶å°†ç­”æ¡ˆè¿”å›ç»™LLMã€‚
3. æå‡ºæ›´å¤šé—®é¢˜
	- å¦‚æœ‰å¿…è¦ï¼Œé‡å¤æ­¥éª¤1ã€2ï¼Œä»¥æ”¶é›†æ›´å¤šç”¨æˆ·åé¦ˆ
4. äººå·¥æ™ºèƒ½æŒç»­å…³æ³¨ä¸Šä¸‹æ–‡
	- LLMåˆ©ç”¨è¿™äº›ç­”æ¡ˆæ¥æä¾›é‡èº«å®šåˆ¶çš„è§£å†³æ–¹æ¡ˆ


éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œæ¯ä¸ªé—®é¢˜çš„å›ç­”å¹¶ä¸æ˜¯å†™æ­»çš„ï¼š

- æ”¯æŒå•é€‰æˆ–å¤šé€‰: é€‰æ‹©ä¸€ä¸ªé€‰é¡¹æˆ–ç»„åˆå¤šä¸ªé€‰é¡¹
- æ”¯æŒé€‰é¡¹å¤–çš„æ–‡æœ¬è¾“å…¥: ç”¨æˆ·å¯ä»¥éšæ—¶æä¾›è¶…å‡ºé¢„å®šä¹‰é€‰é¡¹èŒƒå›´çš„è‡ªå®šä¹‰æ–‡æœ¬
- ä¸°å¯Œçš„ä¸Šä¸‹æ–‡: æ¯ä¸ªé€‰é¡¹éƒ½åŒ…å«ä¸€ä¸ªæè¿°ï¼Œè§£é‡Šå…¶å«ä¹‰å’Œæƒè¡¡

### 3.2 WEBäº¤äº’æ–¹æ¡ˆ

å¯¹äºwebå±‚çš„ç”¨æˆ·äº¤äº’ï¼Œæˆ‘ä»¬é‡‡ç”¨SSEçš„äº¤äº’æ–¹å¼ï¼Œå…·ä½“æµç¨‹æ˜¯

```
ç”¨æˆ·å¼€å¯ä¼šè¯ï¼Œè¾“å…¥ç¬¬ä¸€æ¬¡è®¾è®¡è¦æ±‚
	â¬‡ï¸
åç«¯å»ºç«‹SSEé“¾æ¥ï¼Œå¹¶é€šè¿‡å¼‚æ­¥æ–¹å¼å°†è®¾è®¡è¦æ±‚å‘é€ç»™LLMï¼Œ
	â¬‡ï¸
å¤§æ¨¡å‹è¿”å›é—®è¯¢å†…å®¹
	â¬‡ï¸
åç«¯é€æ¡å°†é—®è¯¢å†…å®¹é€šè¿‡SSEå‘é€ç»™ç”¨æˆ·
	â¬‡ï¸
ç”¨æˆ·å›ç­”å†…å®¹ï¼Œé€šè¿‡send/{chatId}å‘é€ç»™åç«¯
	â¬‡ï¸
é—®è¯¢ç»“æŸï¼Œåç«¯ç»„è£…å›ç­”å‘é€ç»™LLM
	â¬‡ï¸
LLMè¿”å›å®Œæ•´è®¾è®¡æ–¹æ¡ˆ
```


ä»¥æ—¶åºå›¾çš„è§†è§’æ¥çœ‹ä¸€ä¸‹å®Œæ•´çš„äº¤äº’æ–¹æ¡ˆ

![](/imgs/column/springai/D05-3.webp)

```mermaid
sequenceDiagram

    %% 2. å‚ä¸è€…å®šä¹‰ï¼ˆæ·»åŠ è¯­ä¹‰å›¾æ ‡ï¼Œä¼˜åŒ–å‘½åå±•ç¤ºï¼‰
    participant User as ğŸ§‘â€ğŸ’» ç”¨æˆ·
    participant Frontend as ğŸ–¥ï¸ å‰ç«¯(redpacket.html)
    participant Backend as ğŸ”Œ åç«¯(ChatApiController)
    participant LLM as ğŸ¤– å¤§æ¨¡å‹
    participant ImgGen as ğŸ¨ å›¾åƒç”ŸæˆæœåŠ¡


    %% 3. é˜¶æ®µ1ï¼šé¡µé¢åˆå§‹åŒ–
    note over User,Frontend: ğŸ“Œ é˜¶æ®µ1ï¼šé¡µé¢åˆå§‹åŒ–
    User->>+Frontend: æ‰“å¼€çº¢åŒ…è®¾è®¡é¡µé¢
    Frontend->>Frontend: åˆå§‹åŒ–é¡µé¢ï¼Œç”Ÿæˆå”¯ä¸€chatIdï¼ˆä¼šè¯æ ‡è¯†ï¼‰
    deactivate Frontend

    %% 4. é˜¶æ®µ2ï¼šéœ€æ±‚æäº¤ä¸å¤šè½®æ¾„æ¸…
    note over User,LLM: ğŸ“Œ é˜¶æ®µ2ï¼šéœ€æ±‚æäº¤ & å¤šè½®æ¾„æ¸…
    User->>+Frontend: è¾“å…¥è®¾è®¡éœ€æ±‚å¹¶å‘é€
    Frontend->>+Backend: GET /api/chat/{chatId}?question={ç”¨æˆ·é—®é¢˜}<br/>ã€æäº¤è®¾è®¡éœ€æ±‚ã€‘
    Backend->>+LLM: å¼‚æ­¥è°ƒç”¨å¤§æ¨¡å‹ï¼ˆè§£æéœ€æ±‚ï¼‰
    LLM-->>Backend: è§¦å‘AskUserQuestionToolã€éœ€æ±‚æ¾„æ¸…é—®è¯¢ã€‘
    deactivate LLM
    
    Backend->>Frontend: SSEæ¨é€é—®è¯¢é—®é¢˜ã€å®æ—¶æ¨é€ï¼Œæ— éœ€ç­‰å¾…ã€‘
    deactivate Backend
    activate Frontend
    
    Frontend->>User: æ˜¾ç¤ºé—®è¯¢é—®é¢˜ç»™ç”¨æˆ·
    User->>Frontend: å›ç­”é—®é¢˜
    Frontend->>+Backend: GET /api/send/{chatId}?msg={ç”¨æˆ·ç­”æ¡ˆ}<br/>ã€æäº¤æ¾„æ¸…ç­”æ¡ˆã€‘
    deactivate Frontend
    activate Backend
    
    Backend->>+LLM: å°†ç”¨æˆ·ç­”æ¡ˆä¼ ç»™å¤§æ¨¡å‹
    %% å¤šè½®é—®è¯¢å¾ªç¯ï¼ˆä¼˜åŒ–æ³¨é‡Šï¼Œæ˜ç¡®é€»è¾‘ï¼‰
    loop å¤šè½®éœ€æ±‚æ¾„æ¸…ã€ç›´åˆ°éœ€æ±‚æ˜ç¡®ã€‘
        LLM-->>Backend: å¯èƒ½è¿”å›æ–°çš„é—®è¯¢ï¼ˆè¡¥å……éœ€æ±‚ï¼‰
        Backend->>Frontend: SSEæ¨é€æ–°é—®è¯¢
        Frontend->>User: æ˜¾ç¤ºæ–°é—®è¯¢
        User->>Frontend: å›ç­”æ–°é—®è¯¢
        Frontend->>Backend: å‘é€æ–°ç­”æ¡ˆ
        Backend->>LLM: ä¼ é€’æ–°ç­”æ¡ˆ
    end
    
    LLM-->>Backend: è¿”å›æœ€ç»ˆè®¾è®¡æ–¹æ¡ˆï¼ˆæ–‡å­—ç‰ˆï¼‰
    deactivate LLM
    
    Backend->>Frontend: SSEæ¨é€æœ€ç»ˆè®¾è®¡æ–¹æ¡ˆ
    deactivate Backend
    activate Frontend
    
    Frontend->>User: æ˜¾ç¤ºè®¾è®¡æ–¹æ¡ˆï¼ˆæ–‡å­—ç‰ˆï¼‰
    deactivate Frontend

    %% 5. é˜¶æ®µ3ï¼šçº¢åŒ…å›¾ç‰‡ç”Ÿæˆ
    note over User,ImgGen: ğŸ“Œ é˜¶æ®µ3ï¼šçº¢åŒ…å›¾ç‰‡ç”Ÿæˆ
    User->>+Frontend: ç‚¹å‡»ç”Ÿæˆå›¾ç‰‡æŒ‰é’®
    Frontend->>+Backend: GET /api/genImg?msg={è®¾è®¡æ–¹æ¡ˆ}<br/>ã€è§¦å‘å›¾ç‰‡ç”Ÿæˆã€‘
    deactivate Frontend
    activate Backend
    
    Backend->>+ImgGen: è°ƒç”¨å›¾åƒç”ŸæˆAPIã€ä¼ é€’è®¾è®¡æ–¹æ¡ˆå‚æ•°ã€‘
    ImgGen-->>Backend: è¿”å›ç”Ÿæˆçš„å›¾ç‰‡(Base64æ ¼å¼)ã€å«å›¾ç‰‡äºŒè¿›åˆ¶æ•°æ®ã€‘
    deactivate ImgGen
    
    Backend->>Frontend: è¿”å›å›¾ç‰‡Base64æ•°æ®
    deactivate Backend
    activate Frontend
    
    Frontend->>User: æ¸²æŸ“å¹¶æ˜¾ç¤ºç”Ÿæˆçš„çº¢åŒ…å°é¢
    deactivate Frontend
```


åœ¨è¿™å¥—æ–¹æ¡ˆçš„å…·ä½“å®ç°ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä¸Šä¸‹æ–‡æ¥æŒæœ‰ `ä¼šè¯ä¸SSE` ä¹‹é—´çš„å…³ç³»ï¼Œè¿™æ ·æ‰å¯ä»¥å°†ç”¨æˆ·çš„å›ç­”å†…å®¹ä¸ä¹‹å‰çš„å¤§æ¨¡å‹ä¼šè¯è¿›è¡Œç»‘å®š

```java
public class ReqContextHolder {

    private static final ThreadLocal<ReqInfo> reqId = new InheritableThreadLocal<>();

    public static void setReqId(ReqInfo reqId) {
        ReqContextHolder.reqId.set(reqId);
    }

    public static ReqInfo getReqId() {
        return reqId.get();
    }

    public static void clear() {
        reqId.remove();
    }

    public record ReqInfo(String chatId, SseEmitter sse) {
    }
}
```

é€šè¿‡ä¸€ä¸ªä¸´æ—¶çš„Mapæ¥å­˜å‚¨ç”¨æˆ·çš„é—®è¯¢ç»“æœï¼Œè¿™é‡Œå€ŸåŠ©`BlockingQueue`æ¥å®ç°ä¸€ä¸ªç®€æ˜“çš„æ¶ˆæ¯é©±åŠ¨æ¨¡å¼

```java
private Map<String, BlockingQueue<String>> chatHistory = new ConcurrentHashMap<>();
```

åŸºäºä¸Šé¢è¿™ä¸¤ä¸ªä¸­é—´å­˜å‚¨ç®¡é“ï¼Œæ‰€ä»¥æˆ‘ä»¬æ ¸å¿ƒçš„é—®è¯¢å›è°ƒ`WebQuestionHandler`çš„å…·ä½“å®ç°å¦‚ä¸‹ (ä¸‹é¢çš„å®ç°ç»™äº†å®Œæ•´çš„æ³¨é‡Šï¼Œåº”è¯¥ä¸éš¾ç†è§£ğŸ˜Š)

```java
public class WebQuestionHandler implements AskUserQuestionTool.QuestionHandler {
        @Override
        /**
         * å¤„ç†ç”¨æˆ·é—®é¢˜åˆ—è¡¨ï¼Œå‘ç”¨æˆ·å‘é€é—®é¢˜å¹¶ç­‰å¾…ç”¨æˆ·å›ç­”
         *
         * @param questions ç”¨æˆ·é—®é¢˜åˆ—è¡¨
         * @return åŒ…å«é—®é¢˜å’Œå¯¹åº”ç­”æ¡ˆçš„æ˜ å°„
         */
        public Map<String, String> handle(List<AskUserQuestionTool.Question> questions) {
            // åˆ›å»ºç”¨äºå­˜å‚¨é—®é¢˜å’Œç­”æ¡ˆçš„æ˜ å°„
            Map<String, String> answers = new HashMap<>();
            // è·å–å½“å‰è¯·æ±‚çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
            ReqContextHolder.ReqInfo req = ReqContextHolder.getReqId();
            // è·å–SSEå‘å°„å™¨ç”¨äºå‘å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯
            SseEmitter sseEmitter = req.sse();

            // éå†æ‰€æœ‰éœ€è¦è¯¢é—®ç”¨æˆ·çš„é—®é¢˜
            for (AskUserQuestionTool.Question q : questions) {
                // å‘ç”¨æˆ·å‘é€é—®é¢˜æ ‡é¢˜å’Œå†…å®¹
                sendMsg(sseEmitter, "\n" + q.header() + ": " + q.question());

                // è·å–é—®é¢˜çš„é€‰é¡¹åˆ—è¡¨
                List<AskUserQuestionTool.Question.Option> options = q.options();
                // éå†é€‰é¡¹å¹¶å‘é€ç»™ç”¨æˆ·
                for (int i = 0; i < options.size(); i++) {
                    AskUserQuestionTool.Question.Option opt = options.get(i);
                    sendMsg(sseEmitter, String.format("  %d. %s - %s%n", i + 1, opt.label(), opt.description()));
                }

                // æ ¹æ®æ˜¯å¦æ”¯æŒå¤šé€‰å‘é€ä¸åŒçš„æç¤ºä¿¡æ¯
                if (q.multiSelect()) {
                    sendMsg(sseEmitter, "  (Enter numbers separated by commas, or type custom text)");
                } else {
                    sendMsg(sseEmitter, "  (Enter a number, or type custom text)");
                }

                // é˜»å¡ç­‰å¾…ç”¨æˆ·è¾“å…¥
                BlockingQueue<String> queue = chatHistory.get(req.chatId());
                // å¦‚æœé˜Ÿåˆ—ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–°çš„é˜Ÿåˆ—
                if (queue == null) {
                    queue = new LinkedBlockingQueue<>();
                    chatHistory.put(req.chatId(), queue);
                }
                
                String response = null;
                try {
                    // ç­‰å¾…æœ€å¤š5åˆ†é’Ÿè·å–ç”¨æˆ·å“åº”ï¼Œè¶…æ—¶åˆ™è¿”å›ç©ºå­—ç¬¦ä¸²
                    response = queue.poll(5, TimeUnit.MINUTES);
                    if (response == null) {
                        response = ""; // è¶…æ—¶æƒ…å†µä¸‹çš„é»˜è®¤å“åº”
                    }
                } catch (InterruptedException e) {
                    // çº¿ç¨‹è¢«ä¸­æ–­æ—¶è®¾ç½®ä¸­æ–­çŠ¶æ€å¹¶è¿”å›ç©ºå­—ç¬¦ä¸²
                    Thread.currentThread().interrupt();
                    response = "";
                }

                // è§£æç”¨æˆ·å“åº”å¹¶å­˜å…¥ç­”æ¡ˆæ˜ å°„
                answers.put(q.question(), parseResponse(response, options));
            }

            // è¿”å›åŒ…å«æ‰€æœ‰é—®é¢˜å’Œç­”æ¡ˆçš„æ˜ å°„
            return answers;
        }

        private void sendMsg(SseEmitter sseEmitter, String msg) {
            try {
                sseEmitter.send(msg);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
}
```

### 3.3 å›¾ç‰‡ç”Ÿæˆ

å›¾æ–‡ç”Ÿæˆæˆ‘ä»¬è¿™é‡Œç»™å‡ºäº†ä¸¤ç§ï¼Œä¸€ä¸ªæ˜¯åŸºäºæ™ºè°±çš„ä¸€ä¸ªæ˜¯åŸºäºåƒé—®çš„(å› ä¸ºæ™ºè°±çš„å…è´¹æ¨¡å‹æœ‰ç‚¹æ‹‰è·¨)ï¼›

æ–‡ç”Ÿå›¾çš„å…·ä½“å®ç°æ²¡æœ‰å¤ªå¤šå¥½è¯´çš„ï¼Œè¿™é‡Œå•ç‹¬æŒ‡å‡ºæ¥æ˜¯æƒ³æé†’ï¼Œè¿™é‡Œå®é™…ä¸Šè¿˜å¯ä»¥ç»§ç»­æ‰©å±•ä¸€ä¸‹ï¼Œé™¤äº†ç”Ÿæˆé™æ€å›¾ç‰‡ä¹‹å¤–ï¼Œè¿˜å¯ä»¥è€ƒè™‘æ”¯æŒç”ŸæˆåŠ¨æ€çš„è§†é¢‘ï¼›é™¤äº†ç”Ÿæˆå°é¢å›¾ä¹‹å¤–ï¼Œè¿˜å¯ä»¥è€ƒè™‘æ‰©å±•ç”ŸæˆæŒ‚ä»¶

```java
@GetMapping(path = "/genImg")
public String genImg(@RequestParam String msg) throws IOException {
    if ("true".equals(environment.getProperty("spring.ai.dashboard.enable"))) {
        return QwenImgGen.call(environment.getProperty("spring.ai.dashboard.api-key"), msg);
    } else {
        // è¿™é‡Œä½¿ç”¨çš„æ˜¯æ™ºè°±çš„æ–‡ç”Ÿå›¾æ¨¡å‹ï¼Œæ•ˆæœè¾ƒå·®
        ImageResponse response = imgModel.call(new ImagePrompt(msg,
                ImageOptionsBuilder.builder()
                        .height(1344)
                        .width(768)
                        .model("CogView-3-Flash")
                        // è¿”å›å›¾ç‰‡ç±»å‹
                        .responseFormat("png")
                        // å›¾åƒé£æ ¼ï¼Œå¦‚ vivid ç”ŸåŠ¨é£æ ¼ï¼Œ natural è‡ªç„¶é£æ ¼
                        .style("natural")
                        .build())
        );
        Image img = response.getResult().getOutput();
        BufferedImage image = ImageIO.read(new URL(img.getUrl()));

        // å°†å›¾ç‰‡è½¬æ¢ä¸ºBase64ç¼–ç 
        java.io.ByteArrayOutputStream baos = new java.io.ByteArrayOutputStream();
        ImageIO.write(image, "png", baos);
        byte[] imageBytes = baos.toByteArray();
        return java.util.Base64.getEncoder().encodeToString(imageBytes);
    }
}
```

## å››ã€å°ç»“

è¿™ä¸€ç¯‡å†…å®¹å¯ä»¥è¯´æ˜¯ä¸Šä¸€ç¯‡SpringAIæ™ºèƒ½ä½“è®¾è®¡ä¸­é—®è¯¢æœºåˆ¶çš„å…·ä½“ä½¿ç”¨åœºæ™¯ï¼Œæ•´ä¸ªç³»ç»Ÿå±•ç°äº†AIåº”ç”¨å¼€å‘çš„æ–°æ€è·¯ï¼šä¸æ˜¯è®©äººé€‚åº”æœºå™¨ï¼Œè€Œæ˜¯è®©æœºå™¨ç†è§£äººçš„è¡¨è¾¾æ–¹å¼ã€‚é€šè¿‡å¤šè½®å¯¹è¯è·å–å‡†ç¡®éœ€æ±‚ï¼Œå†é€šè¿‡AIç”Ÿæˆèƒ½åŠ›ç›´æ¥äº§ç”Ÿæˆæœï¼ŒçœŸæ­£å®ç°äº†ä»æƒ³æ³•åˆ°ä½œå“çš„è½¬æ¢ã€‚å½“ç„¶æ•´ä½“çš„å®ç°è¿˜æ¯”è¾ƒåˆçº§ï¼Œè¿˜æœ‰ä¸å°‘çš„æŒ–æ˜ç©ºé—´ï¼Œæ¯”å¦‚ä¸€æ¬¡ç”Ÿæˆå®Œæ•´çš„å¾®ä¿¡çº¢åŒ…æ–¹æ¡ˆï¼ˆåŒ…æ‹¬å°é¢ç®€ç§°ã€å°é¢å›¾ã€æŒ‚ä»¶ã€æ°”æ³¡æŒ‚ä»¶ã€å°é¢æ•…äº‹ç­‰ï¼‰æ¬¢è¿æœ‰å…´è¶£çš„å°ä¼™ä¼´è¿›è¡Œè¡¥å…¨



é¡¹ç›®æºç ï¼š

- [https://github.com/liuyueyi/spring-ai-demo/tree/master/v2/T03-manual-qa-web-robot](https://github.com/liuyueyi/spring-ai-demo/tree/master/v2/T03-manual-qa-web-robot)


é›¶åŸºç¡€å…¥é—¨ï¼š

- [LLM åº”ç”¨å¼€å‘æ˜¯ä»€ä¹ˆï¼šé›¶åŸºç¡€ä¹Ÿå¯ä»¥è¯»æ‡‚çš„ç§‘æ™®æ–‡(æç®€ç‰ˆ)](https://mp.weixin.qq.com/s/qCn8x2XO2shA8MheYbHq0w)
- [å¤§æ¨¡å‹åº”ç”¨å¼€å‘ç³»åˆ—æ•™ç¨‹ï¼šåº-ä¸ºä»€ä¹ˆä½ â€œä¼šç”¨ LLMâ€ï¼Œä½†åšä¸å‡ºå¤æ‚åº”ç”¨ï¼Ÿ](https://mp.weixin.qq.com/s/2GXBNOUq3jlysipftz8TpA)
- [å¤§æ¨¡å‹åº”ç”¨å¼€å‘ç³»åˆ—æ•™ç¨‹ï¼šç¬¬ä¸€ç«  LLMåˆ°åº•åœ¨åšä»€ä¹ˆï¼Ÿ](https://mp.weixin.qq.com/s/v-z6EHY300ElOxdGPdzc0w)
- [å¤§æ¨¡å‹åº”ç”¨å¼€å‘ç³»åˆ—æ•™ç¨‹ï¼šç¬¬äºŒç«  æ¨¡å‹ä¸æ˜¯é‡ç‚¹ï¼Œå‚æ•°æ‰æ˜¯ä½ çœŸæ­£çš„æ§åˆ¶é¢æ¿](https://mp.weixin.qq.com/s/t_BuAW9i0npcaJdua3Am2Q)
- [å¤§æ¨¡å‹åº”ç”¨å¼€å‘ç³»åˆ—æ•™ç¨‹ï¼šç¬¬ä¸‰ç«  ä¸ºä»€ä¹ˆæˆ‘çš„Promptè¡¨ç°å¾ˆç³Ÿï¼Ÿ](https://mp.weixin.qq.com/s/vzt0bGwcfnASOiBa0Kc7VQ)
- [å¤§æ¨¡å‹åº”ç”¨å¼€å‘ç³»åˆ—æ•™ç¨‹ï¼šç¬¬å››ç«  Prompt çš„å·¥ç¨‹åŒ–ç»“æ„è®¾è®¡](https://mp.weixin.qq.com/s/Nk-N34TLJVCTI5F4k5rGaQ)
- [å¤§æ¨¡å‹åº”ç”¨å¼€å‘ç³»åˆ—æ•™ç¨‹ï¼šç¬¬äº”ç«  ä» Prompt åˆ° Prompt æ¨¡æ¿ä¸å·¥ç¨‹æ²»ç†](https://mp.weixin.qq.com/s/ZQbztqBq7_PzynG06N4-mg)
- [å¤§æ¨¡å‹åº”ç”¨å¼€å‘ç³»åˆ—æ•™ç¨‹ï¼šç¬¬å…­ç«  ä¸Šä¸‹æ–‡çª—å£çš„çœŸå®è¾¹ç•Œ](https://mp.weixin.qq.com/s/nnKspRO87xbrn4-LBV3RNA)
- [å¤§æ¨¡å‹åº”ç”¨å¼€å‘ç³»åˆ—æ•™ç¨‹ï¼šç¬¬ä¸ƒç«  ä» â€œå †ä¸Šä¸‹æ–‡â€ åˆ° â€œç®¡ç†ä¸Šä¸‹æ–‡â€](https://mp.weixin.qq.com/s/_5D2tF6CPnafj5mlmlwLNw)
- [å¤§æ¨¡å‹åº”ç”¨å¼€å‘ç³»åˆ—æ•™ç¨‹ï¼šç¬¬å…«ç«  è®°å¿†ç­–ç•¥çš„å·¥ç¨‹åŒ–é€‰æ‹©](https://mp.weixin.qq.com/s/z5qaLtjChsvjhWNs8Nw05Q)

---

å®æˆ˜

- [å®æˆ˜ | ä¸¤ç™¾è¡Œå®ç°ä¸€ä¸ªè‡ªç„¶è¯­è¨€åœ°å€æå–æ™ºèƒ½ä½“](https://mp.weixin.qq.com/s/96rHyp_gBUgmA2dhSbzNww)
- [å®æˆ˜ | åŸºäºSpringAIä¸å¤§æ¨¡å‹çš„é›¶é…ç½®å‘ç¥¨æ™ºèƒ½æå–æ¶æ„](https://mp.weixin.qq.com/s/SnXdTB6tYqAzG7HgbnTSAQ)
- [å®æˆ˜ | é›¶åŸºç¡€æ­å»ºçŸ¥è¯†åº“é—®ç­”æœºå™¨äººï¼šåŸºäºSpringAI+RAGçš„å®Œæ•´å®ç°](https://mp.weixin.qq.com/s/NHqLJbos-_nrxNNmhg7IBQ)
- [å‘Šåˆ«ä¼ ç»ŸAIå¼€å‘ï¼SpringAI Agent + Skillsé‡æ–°å®šä¹‰æ™ºèƒ½åº”ç”¨](https://mp.weixin.qq.com/s/ujxVleNhjxzUgL-rjfFcVA)
- [Spring AIä¸­çš„å¤šè½®å¯¹è¯è‰ºæœ¯ï¼šè®©å¤§æ¨¡å‹ä¸»åŠ¨æé—®è·å–æ˜ç¡®éœ€æ±‚](https://mp.weixin.qq.com/s/LcvmiIERs6aOIlRAKGGnFg)

