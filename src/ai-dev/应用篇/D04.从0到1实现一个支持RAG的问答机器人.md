---
order: 4
title: D04.ä»0åˆ°1å®ç°ä¸€ä¸ªæ”¯æŒRAGçš„é—®ç­”æœºå™¨äºº
tag:
  - Spring
  - SpringAI
category:
  - SpringAI
date: 2026-01-22 17:15:07
keywords: SpringAI
---

# åŸºäºSpring AIå®ç°RAGçŸ¥è¯†åº“é—®ç­”æœºå™¨äººï¼šä»é›¶åˆ°ä¸€çš„å®Œæ•´æ•™ç¨‹

## ä¸€ã€å¼•è¨€

éšç€å¤§è¯­è¨€æ¨¡å‹çš„å¿«é€Ÿå‘å±•ï¼ŒRAGï¼ˆRetrieval-Augmented Generationï¼‰æŠ€æœ¯å·²æˆä¸ºæ„å»ºçŸ¥è¯†åº“é—®ç­”ç³»ç»Ÿçš„æ ¸å¿ƒæŠ€æœ¯ä¹‹ä¸€ã€‚æœ¬æ–‡å°†å¸¦é¢†å¤§å®¶ä»é›¶å¼€å§‹ï¼Œä½¿ç”¨Spring AIæ¡†æ¶æ„å»ºä¸€ä¸ªæ”¯æŒæ–‡æ¡£ä¸Šä¼ çš„çŸ¥è¯†åº“é—®ç­”æœºå™¨äººï¼Œå¸®åŠ©å¤§å®¶æ·±å…¥ç†è§£RAGæŠ€æœ¯çš„æ ¸å¿ƒåŸç†å’Œå®è·µåº”ç”¨ã€‚

### 1.1 ä»€ä¹ˆæ˜¯RAGï¼Ÿ

RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰æ˜¯ä¸€ç§ç»“åˆäº†ä¿¡æ¯æ£€ç´¢å’Œæ–‡æœ¬ç”Ÿæˆçš„æŠ€æœ¯ã€‚å®ƒçš„åŸºæœ¬å·¥ä½œæµç¨‹æ˜¯ï¼š
1. ç”¨æˆ·æå‡ºé—®é¢˜
2. ç³»ç»Ÿä»çŸ¥è¯†åº“ä¸­æ£€ç´¢ç›¸å…³ä¿¡æ¯
3. å¤§è¯­è¨€æ¨¡å‹åŸºäºæ£€ç´¢åˆ°çš„ä¿¡æ¯ç”Ÿæˆç­”æ¡ˆ


ä»ç³»ç»Ÿè®¾è®¡è§’åº¦è§¦å‘ï¼ŒRAG çš„æ ¸å¿ƒä½œç”¨å¯ä»¥è¢«æè¿°ä¸ºï¼š

> **åœ¨LLMè°ƒç”¨ç”Ÿæˆå“åº”ä¹‹å‰ï¼Œç”±ç³»ç»ŸåŠ¨æ€æ„é€ ä¸€ä¸ªâ€œæœ€å°ä¸”ç›¸å…³çš„çŸ¥è¯†ä¸Šä¸‹æ–‡â€ã€‚**

è¯·æ³¨æ„ä¸¤ä¸ªå…³é”®è¯ï¼š

- **åŠ¨æ€**ï¼šæ¯æ¬¡é—®é¢˜éƒ½ä¸åŒï¼Œæ£€ç´¢çš„çŸ¥è¯†ä¹Ÿä¸åŒï¼ˆæ¯”å¦‚ç”¨æˆ·é—® A äº§å“æ—¶æ‰¾ A çš„æ–‡æ¡£ï¼Œé—® B äº§å“æ—¶æ‰¾ B çš„æ–‡æ¡£ï¼‰
- **æœ€å°**ï¼šåªæ³¨å…¥å¿…è¦ä¿¡æ¯ï¼ˆæ¯”å¦‚ç”¨æˆ·é—® â€œA äº§å“çš„å®šä»·â€ï¼Œå°±åªå¡å®šä»·ç›¸å…³çš„ç‰‡æ®µï¼Œè€Œéæ•´ä»½äº§å“æ‰‹å†Œï¼‰

RAGå¯ä»¥æœ‰æ•ˆçš„å¼¥è¡¥ä¸Šä¸‹æ–‡çª—å£çš„å…ˆå¤©ä¸è¶³ï¼šä¸å†éœ€è¦æŠŠæ‰€æœ‰çŸ¥è¯†å¡è¿›çª—å£ï¼Œè€Œæ˜¯åªåœ¨éœ€è¦æ—¶ â€œä¸´æ—¶è°ƒå–â€ ç›¸å…³éƒ¨åˆ†ï¼Œæ—¢é¿å…äº†çª—å£æº¢å‡ºï¼Œåˆå‡å°‘äº†æ³¨æ„åŠ›ç«äº‰ã€‚

### 1.2 RAGåœ¨äº¤äº’é“¾è·¯ä¸­çš„ä½ç½®

æ¥ä¸‹æ¥æˆ‘ä»¬ä»¥RAGçš„ç»å…¸åº”ç”¨åœºæ™¯â€”â€”ä¼ä¸šçŸ¥è¯†åº“ä¸ºä¾‹ï¼Œæ¥çœ‹ä¸€ä¸‹RAGåœ¨è¿™ä¸ªæµç¨‹ä¸­æ‰€å¤„çš„ä½ç½®

![](/imgs/column/llm/17-1.webp)

åœ¨è¿™ä¸ªç»“æ„ä¸­ï¼ŒRAGä¸»è¦å°±æ˜¯åœ¨ç”¨æˆ·æé—®ä¸å‘LLMå‘èµ·è¯·æ±‚è¿™ä¸ªä¸­é—´æ®µï¼Œç”¨äºæ£€ç´¢å…³è”çš„æ–‡æ¡£æ„å»ºä¸Šä¸‹æ–‡

### 1.3 RAGå·¥ä½œåŸç†

æˆ‘ä»¬ä»¥ä¸€å¼ å›¾æ¥ä»‹ç»RAGçš„å·¥ä½œåŸç†ï¼Œå…·ä½“çš„RAGè¯¦ç»†ä»‹ç»ï¼Œè¯·å‚ç…§æ–‡æœ«å¼•ç”¨

![](/imgs/column/llm/D04-1.png)

```mermaid
flowchart TD
    %% æ ·å¼å…¨å±€é…ç½®ï¼šç»Ÿä¸€åœ†è§’ã€å­—ä½“ã€è¾¹æ¡†
    classDef stageTitle fill:#2E4057,color:#FFFFFF,font-weight:bold,font-size:14px,rx:8,ry:8
    classDef dataNode fill:#E8F4F8,color:#2D3748,stroke:#4299E1,stroke-width:2,rx:6,ry:6
    classDef processNode fill:#F0F8FB,color:#2D3748,stroke:#38B2AC,stroke-width:2,rx:6,ry:6
    classDef dbNode fill:#FDF2F8,color:#2D3748,stroke:#9F7AEA,stroke-width:2,rx:6,ry:6
    classDef queryNode fill:#F5F5F5,color:#2D3748,stroke:#ED8936,stroke-width:2,rx:6,ry:6
    classDef llmNode fill:#F7FAFC,color:#2D3748,stroke:#48BB78,stroke-width:2,rx:6,ry:6
    classDef noteText fill:#6A5ACD5f,color:#222,font-size:16px,italic:true,stroke-dasharray:4px 8px

    %% ç¬¬ä¸€éƒ¨åˆ†ï¼šä¸ŠåŠåŒº - RAG çŸ¥è¯†åº“æ„å»ºé˜¶æ®µï¼ˆæ•°æ®é¢„å¤„ç†+å‘é‡å…¥åº“ï¼‰
    subgraph RAG["ğŸ”§ RAG çŸ¥è¯†åº“æ„å»ºé˜¶æ®µï¼ˆç¦»çº¿ï¼‰"]
        style RAG fill:#e6f4ff,stroke:#1976d2,stroke-width:2,opacity:0.6
        direction TB
        A[åŸå§‹æ–‡æ¡£é›†<br/>ã€PDF/Word/ç½‘é¡µç­‰ã€‘]:::dataNode 
        B[æ–‡æ¡£é¢„å¤„ç†<br/>ã€æ¸…æ´—/å»å™ª/æ ¼å¼æ ‡å‡†åŒ–ã€‘]:::processNode
        C[æ™ºèƒ½åˆ†å—<br/>ã€æŒ‰è¯­ä¹‰/é•¿åº¦æ‹†åˆ†ï¼Œé¿å…ä¿¡æ¯å‰²è£‚ã€‘]:::processNode
        D[å…ƒæ•°æ®æå–<br/>ã€æ ‡é¢˜/ä½œè€…/é¡µç /å…³é”®è¯ã€‘]:::processNode
        E[æ„å»ºå¯æ£€ç´¢å•å…ƒ<br/>ã€åˆ†å—+å…ƒæ•°æ®ç»„åˆã€‘]:::processNode
        F[ç»Ÿä¸€åµŒå…¥æ¨¡å‹<br/>ã€å°†æ–‡æœ¬è½¬ä¸º768/1024ç»´å‘é‡ã€‘]:::processNode
        G[æ–‡æœ¬å‘é‡åŒ–<br/>ã€è¯­ä¹‰ç¼–ç ï¼Œä¿ç•™ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‘]:::processNode
        H[å‘é‡æ•°æ®åº“<br/>ã€å­˜å‚¨å‘é‡ï¼Œæ”¯æŒç›¸ä¼¼æ€§æ£€ç´¢ã€‘]:::dbNode

        %% æµç¨‹è¿çº¿ + è¾…åŠ©è¯´æ˜æ ‡æ³¨
        A --> B
        B --> C
        C --> D
        C --> E
        D --> E
        D --> F
        E --> G
        F -.-> G
        G --> H
        
        %% å…³é”®è¯´æ˜æ³¨é‡Š
        note1[æ³¨ï¼šåˆ†å—æ˜¯RAGæ•ˆæœçš„æ ¸å¿ƒï¼Œè¿‡ç»†ä¸¢å¤±ä¸Šä¸‹æ–‡ï¼Œè¿‡ç²—æ£€ç´¢ç²¾åº¦ä½]:::noteText
        C -.-> note1
        note2[æ³¨ï¼šåµŒå…¥æ¨¡å‹éœ€ä¸LLMé€‚é…ï¼Œå¸¸ç”¨BGE/Text-Embedding-ADA]:::noteText
        F -.-> note2
    end
    


    %% ç¬¬äºŒéƒ¨åˆ†ï¼šä¸‹åŠåŒº - RAG é—®ç­”æ¨ç†é˜¶æ®µï¼ˆåœ¨çº¿äº¤äº’ï¼‰
    subgraph SB["ğŸ’¬ RAG é—®ç­”æ¨ç†é˜¶æ®µï¼ˆåœ¨çº¿ï¼‰"]
        style SB fill:#e8f5e8, stroke:#2e7d32, color:#005005, opacity:0.6
        direction TB
        I[ç”¨æˆ·æŸ¥è¯¢<br/>ã€è‡ªç„¶è¯­è¨€é—®é¢˜ã€‘]:::queryNode
        J{æŸ¥è¯¢ç±»å‹åˆ¤æ–­<br/>ã€æ™ºèƒ½é—®ç­”/åŸºç¡€æœç´¢ã€‘}:::processNode
        K[æŸ¥è¯¢å¢å¼ºç­–ç•¥<br/>ã€æå‡æ£€ç´¢å¬å›ç‡ã€‘]:::processNode
        L[ç”Ÿæˆå‡è®¾æ€§ç­”æ¡ˆï¼ˆHyDEï¼‰<br/>ã€ç”¨å‡ç­”æ¡ˆæå‡è¯­ä¹‰åŒ¹é…ã€‘]:::processNode
        M[ç”Ÿæˆå¤šä¸ªå­æŸ¥è¯¢ï¼ˆMQEï¼‰<br/>ã€æ‹†åˆ†å¤æ‚é—®é¢˜ã€‘]:::processNode
        N[æŸ¥è¯¢å‘é‡åŒ–<br/>ã€ä¸çŸ¥è¯†åº“åŒæ¨¡å‹ç¼–ç ã€‘]:::processNode
        O[å‘é‡ç›¸ä¼¼åº¦æœç´¢<br/>ã€Top-N ç²—æ’ã€‘]:::processNode
        P[å€™é€‰æ–‡æ¡£é‡æ’<br/>ã€Cross-BERTç²¾æ’ï¼Œæå‡ç›¸å…³æ€§ã€‘]:::processNode
        Q[Top-K ç²¾å‡†æ–‡æ¡£ç‰‡æ®µ<br/>ã€ä»…ä¿ç•™é«˜ç›¸å…³å†…å®¹ã€‘]:::processNode
        %% æµç¨‹è¿çº¿
        I --> J
        J -->|æ™ºèƒ½é—®ç­”| K
        J -->|åŸºç¡€æœç´¢| N
        K -->|HyDE| L
        K -->|MQE| M
        K -->|ç›´æ¥æŸ¥è¯¢| N
        L --> N
        M --> N
        N --> O
        O -.-> H
        O --> P
        P --> Q
        Q --> R
        
        subgraph LLM[ğŸ¤–ç”Ÿæˆä¸è¾“å‡º]
            style LLM fill:#fce4ec, stroke:#c2185b, color:#880e4f, opacity:0.6
            direction TB
            R[æ™ºèƒ½ä¸Šä¸‹æ–‡æ„å»º<br/>ã€é—®é¢˜+æ–‡æ¡£+æç¤ºè¯ç»„åˆã€‘]:::processNode
            S[HelloAgents LLM ç”Ÿæˆ<br/>ã€åŸºäºä¸Šä¸‹æ–‡ç”Ÿæˆç­”æ¡ˆã€‘]:::llmNode
            T[ç­”æ¡ˆåå¤„ç†ä¸æ ¡éªŒ<br/>ã€æ ¼å¼è§„æ•´/äº‹å®æ ¸æŸ¥ã€‘]:::processNode
            U[è¿”å›æœ€ç»ˆç­”æ¡ˆ<br/>ã€å¸¦å¼•ç”¨/æ¥æºã€‘]:::queryNode
            R --> S
            S --> T
            T --> U
        end
        classDef ss1 fill:#f5c8c8,color:#333,stroke:#ffcecf,stroke-width:1.5
        classDef ss2 color:#333,stroke:#ffcecf,stroke-width:1.5
        class R,T ss1
        class S,U ss2
        
        %% å…³é”®è¯´æ˜æ³¨é‡Š
        note3[æ³¨ï¼šæŸ¥è¯¢å¢å¼ºå¯ä½¿å¬å›ç‡æå‡10%-30%]:::noteText
        K -.-> note3q
        note4[æ³¨ï¼šé‡æ’æ˜¯è§£å†³â€œæ£€ç´¢åˆ°ä¸ç›¸å…³å†…å®¹â€çš„æ ¸å¿ƒæ‰‹æ®µ]:::noteText
        P -.-> note4
    end
```

## äºŒã€æ ¸å¿ƒå®ç°

### 2.1 é¡¹ç›®ç»“æ„æ¦‚è§ˆ

é¡¹ç›®æºç å¯ä»¥åœ¨ [https://github.com/liuyueyi/spring-ai-demo](https://github.com/liuyueyi/spring-ai-demo/tree/master/app-projects/D05-rag-qa-bot) è·å–ï¼Œæ–‡æœ«æœ‰æ‰€æœ‰ç›¸å…³çš„å‚è€ƒä¿¡æ¯

```
D05-rag-qa-bot/
â”œâ”€â”€ src/main/java/com/git/hui/springai/app/
â”‚   â”œâ”€â”€ D05Application.java          # å¯åŠ¨ç±»
â”‚   â”œâ”€â”€ mvc/
â”‚   â”‚   â”œâ”€â”€ QaApiController.java     # APIæ§åˆ¶å™¨
â”‚   â”‚   â””â”€â”€ QaController.java        # é¡µé¢æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ qa/QaBoltService.java        # é—®ç­”æœåŠ¡
â”‚   â””â”€â”€ vectorstore/
â”‚       â”œâ”€â”€ DocumentChunker.java       # æ–‡æ¡£åˆ†å—å·¥å…·
â”‚       â”œâ”€â”€ DocumentQuantizer.java     # æ–‡æ¡£é‡åŒ–å™¨
â”‚       â””â”€â”€ TextBasedVectorStore.java  # æ–‡æœ¬å‘é‡å­˜å‚¨
â”œâ”€â”€ src/main/resources/
â”‚   â”œâ”€â”€ application.yml              # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ prompts/qa-prompts.pt        # æç¤ºè¯æ¨¡æ¿
â”‚   â””â”€â”€ templates/chat.html          # å‰ç«¯é¡µé¢
â””â”€â”€ pom.xml                          # ä¾èµ–é…ç½®
```


### 2.2 é¡¹ç›®åˆå§‹åŒ–

#### 2.2.1 Mavenä¾èµ–é…ç½®

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨`pom.xml`ä¸­é…ç½®å¿…è¦çš„ä¾èµ–ï¼š

- å…¶ä¸­å…³äºå‘é‡æ•°æ®åº“ã€tikaçš„æ–‡æ¡£è§£æå±äºæ ¸å¿ƒä¾èµ–é¡¹
- hanlpé€‚ç”¨äºæ— æ³•ç›´æ¥ä½¿ç”¨EmbeddingModelçš„åœºæ™¯ï¼Œåœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œä¼šå®ç°ä¸€ä¸ªåŸºç¡€çš„æ–‡æ¡£å‘é‡åŒ–æ–¹æ¡ˆï¼Œå…¶ä¸­ä¼šé‡‡ç”¨Hanlpæ¥åšä¸­æ–‡åˆ†è¯
- ä½¿ç”¨æ™ºè°±çš„å…è´¹å¤§æ¨¡å‹æ¥ä½“éªŒæˆ‘ä»¬çš„RAGçŸ¥è¯†åº“é—®ç­”ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥åŸºäºOpenAI-Starteræ¥åˆ‡æ¢å…¶ä»–çš„å¤§æ¨¡å‹ï¼Œä½¿ç”¨å±‚é¢å¹¶æ²¡æœ‰æ”¹å˜ï¼Œåªéœ€è¦æ›¿æ¢ä¾èµ–ã€apié…ç½®å³å¯ï¼‰

```xml
<dependencies>
    <!-- å‘é‡æ•°æ®åº“ -->
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-advisors-vector-store</artifactId>
    </dependency>
    <!-- æ–‡æ¡£æå–ï¼Œä½¿ç”¨apache-tikaæ¥å®ç° -->
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-tika-document-reader</artifactId>
    </dependency>
    <!-- pdfæ–‡æ¡£æå–ï¼Œå®é™…ä¹Ÿå¯ä»¥ç”¨ä¸Šé¢çš„tikaæ¥å®ç° -->
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-pdf-document-reader</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-rag</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <!-- ä½¿ç”¨æ™ºè°±å¤§æ¨¡å‹ -->
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-starter-model-zhipuai</artifactId>
    </dependency>
    <!-- ç”¨äºå‰ç«¯é¡µé¢çš„æ”¯æŒ -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-thymeleaf</artifactId>
    </dependency>
    <!-- ä¸­æ–‡åˆ†è¯ï¼Œç”¨åœ¨æ–‡æ¡£å‘é‡åŒ– -->
    <dependency>
        <groupId>com.hankcs</groupId>
        <artifactId>hanlp</artifactId>
        <version>portable-1.8.4</version>
    </dependency>
</dependencies>
```


è¿™é‡Œæˆ‘ä»¬å¼•å…¥äº†Spring AIçš„æ ¸å¿ƒä¾èµ–ï¼Œä»¥åŠç”¨äºæ–‡æ¡£å¤„ç†çš„Tikaå’ŒPDFè¯»å–å™¨ï¼Œè¿˜ç‰¹åˆ«åŠ å…¥äº†HanLPä¸­æ–‡åˆ†è¯åº“æ¥ä¼˜åŒ–ä¸­æ–‡å¤„ç†æ•ˆæœã€‚

#### 2.2.2 åº”ç”¨é…ç½®

åœ¨`application.yml`ä¸­é…ç½®APIå¯†é’¥å’Œç›¸å…³å‚æ•°ï¼š

```yaml
spring:
  ai:
    zhipuai:
      api-key: ${zhipuai-api-key}
      chat:
        options:
          model: GLM-4-Flash
          temperature: 0.1
  thymeleaf:
    cache: false
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 50MB

logging:
  level:
    org.springframework.ai.chat.client.advisor.SimpleLoggerAdvisor: debug
    org.springframework.ai.chat.client: DEBUG

server:
  port: 8080
```


### 2.3 è‡ªå®šä¹‰å‘é‡å­˜å‚¨å®ç°

é€šå¸¸RAGä¼šä½¿ç”¨ä¸€äº›æˆç†Ÿçš„å‘é‡æ•°æ®åº“ï¼ˆå¦‚Pineconeã€weaviateã€qdrantã€milvusæˆ–è€…esã€redisç­‰ï¼‰ï¼Œä½†æ˜¯è€ƒè™‘åˆ°å®‰è£…ã€ç¯å¢ƒé…ç½®ç­‰æˆæœ¬ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ä¼šå®ç°ä¸€ä¸ªåŸºç¡€çš„è‡ªå®šä¹‰çš„æ–‡æœ¬å‘é‡åº“ `TextBasedVectorStore`ï¼ŒåŸºäºå†…å­˜å®ç°ï¼Œæ— éœ€é¢å¤–çš„å¤–éƒ¨ä¾èµ–ï¼Œå•çº¯çš„ç”¨æ¥ä½“éªŒRAGå¹¶æ²¡æœ‰å¤ªå¤§é—®é¢˜

SpringAIåŸç”Ÿæä¾›äº†ä¸€ä¸ªåŸºäºå†…å­˜çš„å‘é‡æ•°æ®åº“`SimpleVectorStore`ï¼Œåœ¨å®ƒçš„å®ç°ä¸­ï¼Œå‘é‡æ•°æ®å†™å…¥ï¼Œä¾èµ–å‘é‡æ¨¡å‹ï¼Œå› æ­¤å¦‚æœæœ‰é¢åº¦ä½¿ç”¨å¤§æ¨¡å‹å‚å®¶æä¾›çš„EmbeddingModelæ—¶ï¼Œç›´æ¥ç”¨å®ƒè¿›è¡Œæµ‹è¯•å³å¯ï¼›

å½“ç„¶å¦‚æœä½ ç°åœ¨å¹¶æ²¡æœ‰æ¸ é“(ğŸ’°)ä½¿ç”¨å‘é‡æ¨¡å‹çš„ï¼Œé‚£ä¹Ÿæ²¡å…³ç³»ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†å‚ç…§SpringAIçš„`SimpleVectorStore`å®ç°çš„ä¸€ä¸ªè‡ªå®šä¹‰çš„å‘é‡åº“`TextBasedVectorStore`ï¼Œæä¾›ä¸€å¥—ä¸ä¾èµ–å‘é‡æ¨¡å‹çš„è§£å†³æ–¹æ¡ˆï¼Œç‰¹åˆ«é€‚åˆå¿«é€ŸåŸå‹å¼€å‘ï¼Œæ ¸å¿ƒå®ç°å¦‚ä¸‹ï¼ˆå½“ç„¶ä½ ä¹Ÿå®Œå…¨å¯ä»¥å¿½ç•¥å®ƒï¼Œå®ƒä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼‰


#### 2.3.1 TextBasedVectorStore - æ–‡æœ¬åŒ¹é…å‘é‡å­˜å‚¨

åœ¨ä¸‹é¢çš„å®ç°ä¸­ï¼Œé‡ç‚¹ä½“ç°äº†ä¸¤ä¸ªæ–¹æ³•

- doAdd: å°†æ–‡æ¡£ä¿å­˜åˆ°å‘é‡æ•°æ®åº“ä¸­ï¼ˆæ–‡æ¡£åˆ†ç‰‡ -> å‘é‡åŒ– -> å­˜å‚¨ï¼‰
- doSimilaritySearch: åŸºäºç›¸ä¼¼åº¦çš„æœç´¢

> éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œæ–‡æ¡£çš„å‘é‡åŒ–ä¸æœç´¢æ—¶ä¼ å…¥æ–‡æœ¬çš„å‘é‡åŒ–ï¼Œéœ€è¦é‡‡ç”¨åŒä¸€å¥—å‘é‡åŒ–æ–¹æ¡ˆï¼ˆwhy?ï¼‰


```java
public class TextBasedVectorStore extends AbstractObservationVectorStore {
    @Getter
    protected Map<String, SimpleVectorStoreContent> store = new ConcurrentHashMap();
    /**
     * å·²ç»å­˜å‚¨åˆ°å‘é‡åº“çš„documentï¼Œç”¨äºå¹‚ç­‰
     */
    private Set<String> persistMd5 = new CopyOnWriteArraySet<>();

    /**
     * æ·»åŠ æ–‡æ¡£åˆ°å‘é‡æ•°æ®åº“
     *
     * @param documents
     */
    @Override
    public void doAdd(List<Document> documents) {
        if (CollectionUtils.isEmpty(documents)) {
            return;
        }

        // åˆ›å»ºä¸€ä¸ªæ–°çš„å¯å˜åˆ—è¡¨å‰¯æœ¬
        List<Document> mutableDocuments = new ArrayList<>();
        for (Document document : documents) {
            // è¿‡æ»¤æ‰é‡å¤çš„æ–‡æ¡£ï¼Œé¿å…äºŒæ¬¡å†™å…¥ï¼Œæµªè´¹ç©ºé—´
            if (!persistMd5.contains((String) document.getMetadata().get("md5"))) {
                mutableDocuments.add(document);
            }
        }

        if (CollectionUtils.isEmpty(mutableDocuments)) {
            return;
        }

        // æ–‡æ¡£åˆ†ç‰‡
        List<Document> chunkers = DocumentChunker.DEFAULT_CHUNKER.chunkDocuments(mutableDocuments);
        // å­˜å‚¨æœ¬åœ°å‘é‡åº“
        chunkers.forEach(document -> {
            float[] embedding = DocumentQuantizer.quantizeDocument(document);
            if (embedding.length == 0) {
                return;
            }
            SimpleVectorStoreContent storeContent = new SimpleVectorStoreContent(
                document.getId(), 
                document.getText(), 
                document.getMetadata(), 
                embedding
            );
            this.store.put(document.getId(), storeContent);
        });
        mutableDocuments.forEach(document -> persistMd5.add((String) document.getMetadata().get("md5")));
    }

    /**
     * æœç´¢å‘é‡æ•°æ®åº“ï¼Œæ ¹æ®ç›¸ä¼¼åº¦è¿”å›ç›¸å…³æ–‡æ¡£
     *
     * @param request
     * @return
     */
    @Override
    public List<Document> doSimilaritySearch(SearchRequest request) {
        Predicate<SimpleVectorStoreContent> documentFilterPredicate = this.doFilterPredicate(request);
        final float[] userQueryEmbedding = this.getUserQueryEmbedding(request.getQuery());
        return this.store.values().stream()
            .filter(documentFilterPredicate)
            .map((content) -> content.toDocument(
                DocumentQuantizer.calculateCosineSimilarity(userQueryEmbedding, content.getEmbedding())
            ))
            .filter((document) -> document.getScore() >= request.getSimilarityThreshold())
            .sorted(Comparator.comparing(Document::getScore).reversed())
            .limit((long) request.getTopK())
            .toList();
    }

    private float[] getUserQueryEmbedding(String query) {
        return DocumentQuantizer.quantizeQuery(query);
    }
}
```

#### 2.3.2 DocumentChunker - æ–‡æ¡£åˆ†å—å™¨

> åˆç†åœ°å°†é•¿æ–‡æ¡£åˆ†å—æ˜¯RAGç³»ç»Ÿçš„å…³é”®ç¯èŠ‚ï¼Œåˆç†çš„åˆ†å—å¤§å°ï¼Œå¯ä»¥æœ‰æ•ˆçš„å¢åŠ æ£€ç´¢æ•ˆç‡ã€æé«˜å‡†ç¡®ç‡ã€å‡å°‘ä¸Šä¸‹æ–‡é•¿åº¦

åœ¨çœŸå®çš„RAGåº”ç”¨ä¸­ï¼Œè¿™ä¸€å—å…·ä½“çš„æ–¹æ¡ˆæŒºå¤šçš„ï¼Œæ¯”å¦‚å›ºå®šå°ºå¯¸ï¼ˆä¸‹é¢çš„æ–¹æ¡ˆï¼‰ã€åœ°æŸœæ‹†åˆ†ã€è¯­ä¹‰æ‹†åˆ†ã€ç»“æ„åŒ–æ‹†åˆ†ï¼ˆå¦‚ç»“æ„åŒ–çš„markdownæ–‡æ¡£å°±å¾ˆé€‚åˆï¼‰ã€å»¶è¿Ÿæ‹†åˆ†ã€è‡ªé€‚åº”æ‹†åˆ†ã€å±‚çº§æ‹†åˆ†ã€LLMé©±åŠ¨æ‹†åˆ†ã€æ™ºèƒ½ä½“æ‹†åˆ†ç­‰ï¼ˆå…·ä½“è¿™ä¸€å—æˆ‘ä¹Ÿæ²¡æœ‰æ·±å…¥å­¦ä¹ ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´é—®ä¸‹AIå§~ğŸ¤£ï¼‰


```java
public class DocumentChunker {
    private final int maxChunkSize;
    private final int overlapSize;

    public DocumentChunker() {
        this(500, 50); // é»˜è®¤å€¼ï¼šæœ€å¤§å—å¤§å°500ä¸ªå­—ç¬¦ï¼Œé‡å 50ä¸ªå­—ç¬¦
    }

    public List<Document> chunkDocument(Document document) {
        String content = document.getText();
        if (content == null || content.trim().isEmpty()) {
            return List.of(document);
        }

        List<String> chunks = splitText(content);
        List<Document> chunkedDocuments = new ArrayList<>();

        for (int i = 0; i < chunks.size(); i++) {
            String chunk = chunks.get(i);
            String chunkId = document.getId() + "_chunk_" + i;

            Document chunkDoc = new Document(chunkId, chunk, new HashMap<>(document.getMetadata()));
            chunkDoc.getMetadata().put("chunk_index", i);
            chunkDoc.getMetadata().put("total_chunks", chunks.size());
            chunkDoc.getMetadata().put("original_document_id", document.getId());

            chunkedDocuments.add(chunkDoc);
        }

        return chunkedDocuments;
    }

    private List<String> splitText(String text) {
        List<String> chunks = new ArrayList<>();
        // æŒ‰å¤šç§åˆ†éš”ç¬¦åˆ†å‰²ï¼Œä¼˜å…ˆåœ¨è¯­ä¹‰è¾¹ç•Œå¤„åˆ†å‰²
        String[] sentences = text.split("(?<=ã€‚)|(?<=ï¼)|(?<=!)|(?<=ï¼Ÿ)|(?<=\\?)|(?<=\\n\\n)");

        StringBuilder currentChunk = new StringBuilder();

        for (String sentence : sentences) {
            if (sentence.trim().isEmpty()) {
                continue; // è·³è¿‡ç©ºå¥å­
            }

            if (currentChunk.length() + sentence.length() <= maxChunkSize) {
               // å¦‚æœå½“å‰å—åŠ ä¸Šæ–°å¥å­ä¸è¶…è¿‡æœ€å¤§å¤§å°ï¼Œå°±æ·»åŠ åˆ°å½“å‰å—
                if (currentChunk.length() > 0) {
                    currentChunk.append(sentence);
                } else {
                    currentChunk.append(sentence);
                }
            } else {
                // å¦‚æœå½“å‰å—ä¸ºç©ºï¼Œä½†æ˜¯å•ä¸ªå¥å­å¤ªé•¿ï¼Œéœ€è¦å¼ºåˆ¶åˆ†å‰²
                if (currentChunk.length() == 0) {
                    List<String> subChunks = forceSplit(sentence, maxChunkSize);
                    for (int i = 0; i < subChunks.size(); i++) {
                        String subChunk = subChunks.get(i);
                        if (i < subChunks.size() - 1) {
                            chunks.add(subChunk);
                        } else {
                            currentChunk.append(subChunk);
                        }
                    }
                } else {
                    chunks.add(currentChunk.toString());
                    currentChunk = new StringBuilder();

                    // æ·»åŠ é‡å éƒ¨åˆ†ï¼Œå¦‚æœå¥å­é•¿åº¦å¤§äºé‡å å¤§å°ï¼Œåˆ™åªå–æœ«å°¾éƒ¨åˆ†
                    if (sentence.length() > overlapSize) {
                        String overlap = sentence.substring(Math.max(0, sentence.length() - overlapSize));
                        currentChunk.append(overlap);
                        currentChunk.append(sentence);
                    } else {
                        currentChunk.append(sentence);
                    }
                }
            }
        }

        if (currentChunk.length() > 0) {
            chunks.add(currentChunk.toString());
        }

        return chunks;
    }
}
```

#### 2.3.3 DocumentQuantizer - æ–‡æ¡£é‡åŒ–å™¨

ä½¿ç”¨HanLPè¿›è¡Œä¸­æ–‡åˆ†è¯ï¼Œå®ç°äº†ä¸€ä¸ªç®€å•çš„æ–‡æ¡£å‘é‡åŒ–å·¥å…·ç±»ï¼ˆåŒæ ·çš„ä½ ä¹Ÿå®Œå…¨å¯ä»¥å¿½ç•¥å®ƒçš„å…·ä½“å®ç°ï¼Œå› ä¸ºå®ƒçš„æ•ˆæœæ˜¾ç„¶æ¯”ä½¿ç”¨EmbedingModelè¦å·®å¾ˆå¤šå¾ˆå¤šï¼Œä½†ç”¨äºå­¦ä¹ ä½“éªŒRAGä¹ŸåŸºæœ¬å¤Ÿç”¨ï¼‰

```java
public class DocumentQuantizer {
    private static final Segment SEGMENT = HanLP.newSegment();

    public static float[] quantizeText(String text) {
        if (text == null || text.trim().isEmpty()) {
            return new float[0];
        }

        String[] words = preprocessText(text);
        Map<String, Integer> wordFreq = countWordFrequency(words);
        // ç”Ÿæˆå›ºå®šé•¿åº¦çš„å‘é‡è¡¨ç¤ºï¼ˆè¿™é‡Œä½¿ç”¨å‰128ä¸ªé«˜é¢‘è¯ï¼‰
        return generateFixedLengthVector(wordFreq, 128);
    }

    /**
     * å°†æ–‡æœ¬è½¬æ¢ä¸ºæ•°å€¼å‘é‡è¡¨ç¤ºï¼ˆç®€åŒ–ç‰ˆï¼‰
     * ä½¿ç”¨TF-IDFçš„åŸºæœ¬æ€æƒ³ï¼Œä½†ç®€åŒ–ä¸ºè¯é¢‘ç»Ÿè®¡
     *
     * @param text è¾“å…¥æ–‡æœ¬
     * @return æ•°å€¼å‘é‡
     */
    private static String[] preprocessText(String text) {
        List<Term> termList = SEGMENT.seg(text);
        return termList.stream()
            .filter(term -> !isStopWord(term.word)) // è¿‡æ»¤åœç”¨è¯
            .filter(term -> !term.nature.toString().startsWith("w")) // è¿‡æ»¤æ ‡ç‚¹ç¬¦å·
            .map(term -> term.word.toLowerCase()) // è½¬æ¢ä¸ºå°å†™
            .toArray(String[]::new);
    }

    /**
     * ç”Ÿæˆå›ºå®šé•¿åº¦çš„å‘é‡è¡¨ç¤º
     *
     * @param wordFreq è¯é¢‘æ˜ å°„
     * @param length   å‘é‡é•¿åº¦
     * @return å›ºå®šé•¿åº¦çš„å‘é‡
     */
    private static float[] generateFixedLengthVector(Map<String, Integer> wordFreq, int length) {
        float[] vector = new float[length];

        // è·å–é¢‘ç‡æœ€é«˜çš„è¯æ±‡
        List<Map.Entry<String, Integer>> sortedEntries = wordFreq.entrySet()
                .stream()
                .sorted(Map.Entry.<String, Integer>comparingByValue().reversed())
                .limit(length)
                .collect(Collectors.toList());

        // å°†è¯é¢‘å¡«å…¥å‘é‡
        for (int i = 0; i < Math.min(sortedEntries.size(), length); i++) {
            vector[i] = sortedEntries.get(i).getValue();
        }

        return vector;
    }

    public static double calculateCosineSimilarity(float[] vectorA, float[] vectorB) {
        if (vectorA == null || vectorB == null || vectorA.length == 0 || vectorB.length == 0) {
            return 0.0;
        }

        int minLength = Math.min(vectorA.length, vectorB.length);
        float[] adjustedA = Arrays.copyOf(vectorA, minLength);
        float[] adjustedB = Arrays.copyOf(vectorB, minLength);

        double dotProduct = 0.0;
        double normA = 0.0;
        double normB = 0.0;

        for (int i = 0; i < minLength; i++) {
            dotProduct += adjustedA[i] * adjustedB[i];
            normA += Math.pow(adjustedA[i], 2);
            normB += Math.pow(adjustedB[i], 2);
        }

        normA = Math.sqrt(normA);
        normB = Math.sqrt(normB);

        if (normA == 0 || normB == 0) {
            return 0.0;
        }

        return dotProduct / (normA * normB);
    }
}
```

#### 2.3.4 æ³¨å†Œå‘é‡åº“

æ¥ä¸‹æ¥å°±æ˜¯æ³¨å†Œä½¿ç”¨è¿™ä¸ªå‘é‡åº“ï¼Œåœ¨é…ç½®ç±»orå¯åŠ¨ç±»ä¸­ï¼Œæ·»åŠ ä¸‹é¢è¿™ä¸ªå£°æ˜å³å¯

```java
@Bean
public VectorStore vectorStore() {
    return TextBasedVectorStore.builder().build();
}
```


### 2.4 SpringAIå‘é‡å­˜å‚¨

ä¸Šé¢2.3é€‚ç”¨äºæ— æ³•ç›´æ¥ä½¿ç”¨å¤§æ¨¡å‹å‚å®¶çš„å‘é‡æ¨¡å‹çš„åœºæ™¯ï¼Œå¦‚æœå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œé‚£ä¹ˆä¸Šé¢çš„å…¨éƒ¨å¯ä»¥ç›´æ¥å¿½ç•¥æ‰ï¼Œç›´æ¥ä½¿ç”¨ä¸‹é¢çš„æ–¹å¼è¿›è¡Œå£°æ˜å‘é‡åº“å³å¯

```java
@Bean
public VectorStore vectorStore(EmbeddingModel embeddingModel) {
    return SimpleVectorStore.builder(embeddingModel).build();
}
```


### 2.5 é—®ç­”æœåŠ¡å®ç°

æ¥ä¸‹æ¥æˆ‘ä»¬è¿›å…¥æ ¸å¿ƒçš„åŸºäºRAGçš„QAé—®ç­”æœºå™¨äººçš„å®ç°

#### 2.5.1 QaBoltService - æ ¸å¿ƒé—®ç­”æœåŠ¡

##### Pre. é—®ç­”æœåŠ¡æµç¨‹

æˆ‘ä»¬å…ˆä»æ—¶åºçš„è§’åº¦æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªé—®ç­”æœåŠ¡çš„æ ¸å¿ƒäº¤äº’æµç¨‹

![](/imgs/column/llm/D04-2.png)

```mermaid
sequenceDiagram

    %% è§’è‰²å®šä¹‰ï¼šåŠ å›¾æ ‡+é…è‰²ï¼ŒåŒºåˆ†ä¸åŒæ¨¡å—ç±»å‹
    participant U as ğŸ§‘â€ğŸ’» ç”¨æˆ·
    participant F as ğŸ–¥ï¸ å‰ç«¯ç•Œé¢
    participant API as ğŸ”Œ APIæ§åˆ¶å™¨
    participant Service as ğŸ§  é—®ç­”æœåŠ¡(æ ¸å¿ƒ)
    participant Chunker as âœ‚ï¸ æ–‡æ¡£åˆ†å—å™¨
    participant Quantizer as ğŸ“Š æ–‡æ¡£é‡åŒ–å™¨(Embedding)
    participant VectorStore as ğŸ—‚ï¸ å‘é‡å­˜å‚¨(Qdrant)
    participant LLM as ğŸ¤– å¤§è¯­è¨€æ¨¡å‹

    %% ç¬¬ä¸€é˜¶æ®µï¼šæ–‡æ¡£ä¸Šä¼ ä¸å‘é‡åº“æ„å»ºï¼ˆæ ‡æ³¨é˜¶æ®µæ ‡é¢˜ï¼‰
    note over U,LLM: ğŸ“¤ é˜¶æ®µ1ï¼šæ–‡æ¡£ä¸Šä¼  & å‘é‡åº“æ„å»º
    U->>+F: ä¸Šä¼ æœ¬åœ°æ–‡æ¡£(PDF/Wordç­‰)
    F->>+API: POST /api/chat/{chatId} <br/>æºå¸¦æ–‡ä»¶äºŒè¿›åˆ¶æ•°æ®
    API->>+Service: è°ƒç”¨ask()æ–¹æ³•ï¼ˆè§¦å‘æ–‡æ¡£å¤„ç†æµç¨‹ï¼‰
    Service->>Service: processFiles() <br/>ã€æ–‡ä»¶è§£æ/æ ¼å¼æ ¡éªŒã€‘
    Service->>+Chunker: åˆ†å—æ–‡æ¡£ <br/>ã€æŒ‰è¯­ä¹‰æ‹†åˆ†ï¼Œé¿å…ä¿¡æ¯å‰²è£‚ã€‘
    Chunker-->>-Service: è¿”å›æ–‡æ¡£å—åˆ—è¡¨ï¼ˆå«å…ƒæ•°æ®ï¼‰
    Service->>+Quantizer: å‘é‡åŒ–æ–‡æ¡£å— <br/>ã€è½¬ä¸º128ç»´å‘é‡ï¼Œè¯­ä¹‰ç¼–ç ã€‘
    Quantizer-->>-Service: è¿”å›æ–‡æ¡£å—å‘é‡è¡¨ç¤ºã€æ•°ç»„ã€‘
    Service->>+VectorStore: æ·»åŠ æ–‡æ¡£å‘é‡åˆ°å‘é‡åº“
    VectorStore-->>-Service: ç¡®è®¤æ·»åŠ æˆåŠŸ <br/>ï¼ˆè¿”å›å…¥åº“ID/æ•°é‡ï¼‰
    Service-->>-API: æ–‡æ¡£å¤„ç†å®Œæˆå“åº”
    API-->>-F: è¿”å›å¤„ç†ç»“æœï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
    F-->>U: æç¤º"æ–‡æ¡£ä¸Šä¼ å®Œæˆï¼Œå¯å¼€å§‹æé—®"

    %% åˆ†éš”çº¿ï¼šè§†è§‰åŒºåˆ†ä¸¤ä¸ªé˜¶æ®µ

    %% ç¬¬äºŒé˜¶æ®µï¼šç”¨æˆ·æé—®ä¸ç­”æ¡ˆç”Ÿæˆï¼ˆæ ‡æ³¨é˜¶æ®µæ ‡é¢˜ï¼‰
    note over U,LLM: â“ é˜¶æ®µ2ï¼šç”¨æˆ·æé—® & ç­”æ¡ˆç”Ÿæˆ
    U->>+F: è¾“å…¥è‡ªç„¶è¯­è¨€é—®é¢˜
    F->>+API: POST /api/chat/{chatId} <br/>æºå¸¦ç”¨æˆ·é—®é¢˜æ–‡æœ¬
    API->>+Service: è°ƒç”¨ask()æ–¹æ³•ï¼ˆè§¦å‘é—®ç­”æµç¨‹ï¼‰
    Service->>+Quantizer: å‘é‡åŒ–æŸ¥è¯¢æ–‡æœ¬ <br/>ã€ä¸æ–‡æ¡£åŒæ¨¡å‹ç¼–ç ã€‘
    Quantizer-->>-Service: è¿”å›æŸ¥è¯¢å‘é‡ã€æ•°ç»„ã€‘
    Service->>+VectorStore: æ£€ç´¢ç›¸ä¼¼æ–‡æ¡£ <br/>ã€ä½™å¼¦ç›¸ä¼¼åº¦Top-Kæ£€ç´¢ã€‘
    VectorStore-->>-Service: è¿”å›é«˜ç›¸å…³æ–‡æ¡£ç‰‡æ®µ
    Service->>+LLM: æ„å»ºæç¤ºè¯å¹¶å‘é€è¯·æ±‚
    Note over Service,LLM: ğŸ“ æç¤ºè¯ç»“æ„ï¼š<br/>1. ç³»ç»ŸæŒ‡ä»¤ï¼ˆç­”æ¡ˆåŸºäºæ–‡æ¡£ï¼‰<br/>2. æ£€ç´¢åˆ°çš„æ–‡æ¡£ç‰‡æ®µ<br/>3. ç”¨æˆ·åŸå§‹é—®é¢˜
    LLM-->>-Service: æµå¼è¿”å›ç”Ÿæˆçš„ç­”æ¡ˆ
    Service-->>-API: SSE(Server-Sent Events)æµå¼è¿”å›ç­”æ¡ˆ
    API-->>-F: SSEå®æ—¶æ¨é€ç­”æ¡ˆç‰‡æ®µ
    F-->>U: é€æ®µæ¸²æŸ“æ˜¾ç¤ºæœ€ç»ˆç­”æ¡ˆ
```

åœ¨è¿™ä¸ªæ—¶åºè¿‡ç¨‹ä¸­ï¼Œä¸ºäº†ç®€åŒ–å¤§å®¶çš„ç†è§£ï¼Œæˆ‘ä»¬å°†æ–‡æ¡£çš„å‘é‡åŒ–å­˜å‚¨ä¸é—®ç­”è¿›è¡Œäº†æ‹†åˆ†

**ç¬¬ä¸€æ­¥ï¼šæ–‡æ¡£å‘é‡åŒ–**

è¿™ä¸€éƒ¨åˆ†åŒ…å«RAGåº”ç”¨æ•°æ®å‡†å¤‡é˜¶æ®µçš„å®Œæ•´è¿‡ç¨‹

- æ•°æ®æå–
- æ–‡æœ¬åˆ†å‰²
- å‘é‡åŒ–

**ç¬¬äºŒæ­¥ï¼šé—®ç­”**

- åº”ç”¨å±‚å“åº”ç”¨æˆ·æé—®
- ä»å‘é‡æ•°æ®åº“æ£€ç´¢ç›¸ä¼¼åº¦é«˜çš„æ–‡æ¡£ä¿¡æ¯
- æ³¨å…¥æç¤ºè¯
- è®¿é—®å¤§æ¨¡å‹ï¼Œè·å–ç­”æ¡ˆ

##### Impl. æ ¸å¿ƒå®ç°

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹å…·ä½“çš„å®ç°ï¼ˆä¸Šé¢çš„æ­¥éª¤åˆ†å‰²å¾—å¾ˆæ¸…æ¥šï¼Œä½†æ˜¯å®é™…ä½¿ç”¨æ—¶ï¼Œç”¨æˆ·å¯ä»¥åœ¨é—®ç­”ä¸­ä¸Šä¼ é™„ä»¶ï¼Œè¿™ä¸ªé™„ä»¶ä¹Ÿä¼šä½œä¸ºæˆ‘ä»¬çŸ¥è¯†åº“çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤å…·ä½“çš„å®ç°ä¸­ï¼Œä½ ä¼šå‘ç°è¿™ä¸¤éƒ¨è€¦åˆåœ¨ä¸€èµ·äº†ï¼Œè¯·ä¸è¦æƒŠè®¶ï¼‰

**step1: åˆå§‹åŒ–ChatClient**

åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆå‚ç…§SpringAIçš„å®˜æ–¹æ•™ç¨‹ï¼Œé€šè¿‡Advisoræ¥åˆå§‹åŒ–æ”¯æŒRAGçš„`ChatClient`

> å®˜æ–¹æ–‡æ¡£ï¼š[https://docs.spring.io/spring-ai/reference/api/retrieval-augmented-generation.html](https://docs.spring.io/spring-ai/reference/api/retrieval-augmented-generation.html)


```java
@Service
public class QaBoltService {
    private final ChatClient chatClient;
    private final ChatMemory chatMemory;
    private final VectorStore vectorStore;

    @Value("classpath:/prompts/qa-prompts.pt")
    private Resource boltPrompts;

    public QaBoltService(ChatClient.Builder builder, VectorStore vectorStore, ChatMemory chatMemory) {
        this.vectorStore = vectorStore;
        this.chatMemory = chatMemory;
        this.chatClient = builder.defaultAdvisors(
            new SimpleLoggerAdvisor(ModelOptionsUtils::toJsonStringPrettyPrinter, 
                                   ModelOptionsUtils::toJsonStringPrettyPrinter, 0),
            // ç”¨äºæ”¯æŒå¤šè½®å¯¹è¯
            MessageChatMemoryAdvisor.builder(chatMemory).build(),
            // ç”¨äºæ”¯æŒRAG
            RetrievalAugmentationAdvisor.builder()
                .queryTransformers(
                    // ä½¿ç”¨å¤§å‹è¯­è¨€æ¨¡å‹é‡å†™ç”¨æˆ·æŸ¥è¯¢ï¼Œä»¥ä¾¿åœ¨æŸ¥è¯¢ç›®æ ‡ç³»ç»Ÿæ—¶æä¾›æ›´å¥½çš„ç»“æœã€‚
                    RewriteQueryTransformer.builder().chatClientBuilder(builder.build().mutate()).build()
                )
                .queryAugmenter(
                    // ContextualQueryAugmenter ä½¿ç”¨æ¥è‡ªæ‰€æä¾›æ–‡æ¡£å†…å®¹çš„ä¸Šä¸‹æ–‡æ•°æ®æ¥å¢å¼ºç”¨æˆ·æŸ¥è¯¢ã€‚
                    // é»˜è®¤ä¸æ”¯æŒä¸Šä¸‹æ–‡ä¸ºç©ºçš„åœºæ™¯ï¼Œå‡ºç°ä¹‹åå¤§æ¨¡å‹ä¼šä¸è¿”å›ç”¨æˆ·æŸ¥è¯¢ï¼›è¿™é‡Œè°ƒæ•´ä¸ºæ”¯æŒä¸ºç©º
                    ContextualQueryAugmenter.builder().allowEmptyContext(true).build()
                )
                .documentRetriever(
                    VectorStoreDocumentRetriever.builder()
                        .similarityThreshold(0.50)
                        .vectorStore(vectorStore)
                        .build()
                )
                .build()
        ).build();
    }
}
```

æ¥ä¸‹æ¥å°±æ˜¯å“åº”é—®ç­”çš„å®ç°ï¼Œè¿™é‡Œåˆ†ä¸¤æ­¥

**step2: æ–‡æ¡£å¤„ç†**

å¤„ç†ç”¨æˆ·ä¸Šä¼ çš„é™„ä»¶ï¼Œå³ä¸Šé¢æ—¶åºå›¾ä¸­çš„ç¬¬ä¸€æ­¥ï¼Œè§£ææ–‡æ¡£ã€åˆ‡åˆ†ã€å‘é‡åŒ–ã€ä¿å­˜åˆ°å‘é‡åº“;

ä¸‹é¢çš„å®ç°ä¸­ä¸»è¦ä½“ç°çš„æ˜¯åŸºäºSpringAIå°è£…çš„tikaä¸pdfæ–‡æ¡£è§£æstarterï¼Œæ¥æå–ä¸Šä¼ çš„æ–‡æ¡£ï¼Œç”Ÿæˆä¾›å‘é‡æ•°æ®åº“ä½¿ç”¨çš„`List<Document>`; è€Œå…·ä½“çš„æ–‡æ¡£åˆ‡åˆ†ã€å‘é‡åŒ–ç­‰åˆ™æ˜¯åœ¨ä¸Šé¢çš„`TextBasedVectorStore`å®ç°

> æ³¨ï¼šä¸ºäº†ä¸€ä¸ªæ–‡æ¡£ï¼Œé‡å¤è¿›è¡Œæ•°æ®å¤„ç†ï¼Œæˆ‘ä»¬åœ¨å…ƒæ•°æ®ä¸­ç»´æŠ¤äº†æ–‡æ¡£çš„ md5ï¼Œè¿™æ ·å½“æ·»åŠ åˆ°å‘é‡åº“ä¸­æ—¶ï¼Œå°±å¯ä»¥åŸºäºè¿™ä¸ªmd5æ¥è¿›è¡Œå»é‡äº†ï¼ˆä¸€ä¸ªå·¥ç¨‹åŒ–å®ç°æ–¹é¢çš„å°æŠ€å·§~ï¼‰

```java
private ProceedInfo processFiles(String chatId, Collection<MultipartFile> files) {
    StringBuilder context = new StringBuilder("\n\n");
    List<Media> mediaList = new ArrayList<>();
    files.forEach(file -> {
        try {
            var data = new ByteArrayResource(file.getBytes());
            var md5 = calculateHash(chatId, file.getBytes());
            MimeType mime = MimeType.valueOf(file.getContentType());
            if (mime.equalsTypeAndSubtype(MediaType.APPLICATION_PDF)) {
                PagePdfDocumentReader pdfReader = new PagePdfDocumentReader(data,
                        PdfDocumentReaderConfig.builder()
                                .withPageTopMargin(0)
                                .withPageExtractedTextFormatter(ExtractedTextFormatter.builder()
                                        .withNumberOfTopTextLinesToDelete(0)
                                        .build())
                                .withPagesPerDocument(1)
                                .build());
                List<Document> documents = pdfReader.read();
                documents.forEach(document -> {
                    document.getMetadata().put("md5", md5);
                    if (document.getMetadata().containsKey("file_name") && 
                        document.getMetadata().get("file_name") == null) {
                        document.getMetadata().put("file_name", file.getName());
                    }
                });
                vectorStore.add(documents);

                var content = String.join("\n", documents.stream().map(Document::getText).toList());
                context.append(String.format(ATTACHMENT_TEMPLATE, file.getName(), content));
            } else if ("text".equalsIgnoreCase(mime.getType())) {
                List<Document> documents = new TikaDocumentReader(data).read();
                documents.forEach(document -> document.getMetadata().put("md5", md5));
                vectorStore.add(documents);

                var content = String.join("\n", documents.stream().map(Document::getText).toList());
                context.append(String.format(ATTACHMENT_TEMPLATE, file.getName(), content));
            }
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    });
    return new ProceedInfo(context.toString(), mediaList);
}
```

**step3: é—®ç­”å®ç°**

ç„¶åå°±æ˜¯å…·ä½“çš„é—®ç­”å®ç°ï¼Œè¿™é‡Œä¸»è¦æ˜¯å€ŸåŠ© `QuestionAnswerAdvisor` æ¥å°è£…RAGç›¸å…³çš„ä¿¡æ¯

> è¯´æ˜ï¼šåœ¨ä¸‹é¢çš„å®ç°ä¸­ï¼Œä½¿ç”¨äº†è‡ªå®šä¹‰çš„æç¤ºè¯æ¨¡æ¿ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨SpringAIé»˜è®¤çš„æ–¹æ¡ˆ

```java
public Flux<String> ask(String chatId, String question, Collection<MultipartFile> files) {
    processFiles(chatId, files);

    // è‡ªå®šä¹‰çš„æç¤ºè¯æ¨¡æ¿ï¼Œæ›¿æ¢é»˜è®¤çš„æ£€ç´¢å‚è€ƒèµ„æ–™çš„æç¤ºè¯æ¨¡æ¿
    // å…¶ä¸­ <query> å¯¹åº”çš„æ˜¯ç”¨æˆ·çš„æé—® question
    // <question_answer_context> å¯¹åº”çš„æ˜¯å¢å¼ºæ£€ç´¢çš„documentï¼Œå³æ£€ç´¢åˆ°çš„å‚è€ƒèµ„æ–™
    PromptTemplate customPromptTemplate = PromptTemplate.builder()
        .renderer(StTemplateRenderer.builder().startDelimiterToken('<').endDelimiterToken('>').build())
        .template("""
            <query>

            Context information is below.

             ---------------------
             <question_answer_context>
             ---------------------

             Given the context information and no prior knowledge, answer the query.

             Follow these rules:

             1. If the answer is not in the context, just say that you don't know.
             2. Avoid statements like "Based on the context..." or "The provided information...".
                      """).build();

    var qaAdvisor = QuestionAnswerAdvisor.builder(vectorStore)
        .searchRequest(SearchRequest.builder().similarityThreshold(0.5d).topK(3).build())
        .promptTemplate(customPromptTemplate)
        .build();
    var requestSpec = chatClient.prompt()
        .system(boltPrompts)
        .user(question)
        .advisors(qaAdvisor)
        .advisors(a -> a.param(ChatMemory.CONVERSATION_ID, chatId));
    return requestSpec.stream().content().map(s -> s.replaceAll("\n", "<br/>"));
}
```

åˆ°è¿™é‡Œï¼Œä¸€ä¸ªåŸºäºRAGçš„é—®ç­”æœºå™¨äººçš„æ ¸å¿ƒé€»è¾‘ï¼Œå·²ç»å…¨éƒ¨å®Œæˆï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¿›å…¥ä½“éªŒé˜¶æ®µ

#### 2.5.2 æ§åˆ¶å™¨å®ç°

QaApiController - APIæ§åˆ¶å™¨

```java
@RestController
@RequestMapping("/api")
public class QaApiController {
    @Autowired
    private QaBoltService qaBolt;

    @GetMapping(path = "/chat/{chatId}", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public Flux<String> qaGet(@PathVariable("chatId") String chatId,
                              @RequestParam("question") String question) {
        return qaBolt.ask(chatId, question, Collections.emptyList());
    }

    @PostMapping(path = "/chat/{chatId}", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public Flux<String> qaPost(@PathVariable("chatId") String chatId,
                               @RequestParam("question") String question,
                               @RequestParam(value = "files", required = false) Collection<MultipartFile> files) {
        if (files == null) {
            files = Collections.emptyList();
        }
        return qaBolt.ask(chatId, question, files);
    }
}
```


### 2.6 å‰ç«¯ç•Œé¢

äº¤äº’å¼èŠå¤©ç•Œé¢ï¼Œå‰ç«¯ç•Œé¢æä¾›äº†æ–‡ä»¶ä¸Šä¼ å’Œé—®ç­”äº¤äº’åŠŸèƒ½ï¼Œå…·ä½“çš„ä»£ç å®ç°è¯·å‚è€ƒæ–‡æœ«çš„é¡¹ç›®æºç åœ°å€ï¼Œè¿™é‡Œå°±ä¸è´´äº†ï¼ˆä¸»è¦æ˜¯å¤ªé•¿äº†~ï¼‰


## ä¸‰ã€ä½“éªŒä¸å°ç»“

### 3.1 å¯åŠ¨ç±»

```java
@SpringBootApplication
public class D05Application {
    @Bean
    public VectorStore vectorStore() {
        return TextBasedVectorStore.builder().build();
    }

    public static void main(String[] args) {
        SpringApplication.run(D05Application.class, args);
        System.out.println("å¯åŠ¨æˆåŠŸï¼Œå‰ç«¯æµ‹è¯•è®¿é—®åœ°å€ï¼š http://localhost:8080/chat");
    }
}
```

### 3.2 é—®ç­”æç¤ºè¯

åœ¨ `resources/prompts/qa-prompts.pt` ä¸­ç»´æŠ¤æˆ‘ä»¬çš„qaæœºå™¨äººçš„ç³»ç»Ÿæç¤ºè¯ï¼ˆDeepSeekç”Ÿæˆçš„ï¼‰

```pt
## è§’è‰²è®¾å®š
ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½é—®ç­”åŠ©æ‰‹ï¼Œä¸“é—¨è´Ÿè´£æ ¹æ®ç”¨æˆ·æä¾›çš„æ–‡æ¡£å†…å®¹è¿›è¡Œå‡†ç¡®çš„å›ç­”å’Œä¿¡æ¯æå–ã€‚

## æ ¸å¿ƒä»»åŠ¡
- ä»”ç»†é˜…è¯»å¹¶ç†è§£ç”¨æˆ·ä¸Šä¼ çš„æ–‡æ¡£å†…å®¹
- åŸºäºæ–‡æ¡£ä¸­çš„ä¿¡æ¯å›ç­”ç”¨æˆ·çš„é—®é¢˜
- æä¾›å‡†ç¡®ã€ç›¸å…³ä¸”åŸºäºæ–‡æ¡£çš„ç­”æ¡ˆ
- å½“é—®é¢˜è¶…å‡ºæ–‡æ¡£èŒƒå›´æ—¶ï¼Œæ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·è¯¥ä¿¡æ¯æœªåœ¨æ–‡æ¡£ä¸­æåŠ

## å·¥ä½œæµç¨‹
1. é¦–å…ˆåˆ†æç”¨æˆ·ä¸Šä¼ çš„æ–‡æ¡£ï¼Œæå–å…³é”®ä¿¡æ¯
2. ç†è§£ç”¨æˆ·æå‡ºçš„é—®é¢˜
3. åœ¨æ–‡æ¡£ä¸­æŸ¥æ‰¾ä¸é—®é¢˜ç›¸å…³çš„ä¿¡æ¯
4. æ•´åˆç›¸å…³ä¿¡æ¯å¹¶å½¢æˆç»“æ„åŒ–ç­”æ¡ˆ
5. å¦‚æ— æ³•ä»æ–‡æ¡£ä¸­æ‰¾åˆ°ç›¸å…³ä¿¡æ¯ï¼Œåˆ™è¯´æ˜æƒ…å†µ

## å›ç­”è§„èŒƒ
- ä¸¥æ ¼åŸºäºæ–‡æ¡£å†…å®¹ä½œç­”ï¼Œä¸å¾—ç¼–é€ ä¿¡æ¯
- å¼•ç”¨æ–‡æ¡£ä¸­çš„å…·ä½“ä¿¡æ¯æ—¶ï¼Œè¯·ä¿æŒåŸæ–‡å‡†ç¡®æ€§
- å¦‚æœé—®é¢˜æ¶‰åŠå¤šä¸ªçŸ¥è¯†ç‚¹ï¼Œåœ¨ç­”æ¡ˆä¸­æ¸…æ™°åˆ†ç‚¹è¯´æ˜
- å¯¹äºä¸ç¡®å®šçš„å†…å®¹ï¼Œåº”è¯šå®è¡¨è¾¾ä¸ç¡®å®šæ€§ï¼Œè€ŒéçŒœæµ‹
- ä¿æŒå›ç­”ç®€æ´æ˜äº†ï¼ŒåŒæ—¶ç¡®ä¿ä¿¡æ¯å®Œæ•´

## æ³¨æ„äº‹é¡¹
- ä¸å¾—è„±ç¦»æ–‡æ¡£å†…å®¹è¿›è¡Œå›ç­”
- é‡åˆ°æ¨¡ç³Šæˆ–ä¸æ˜ç¡®çš„é—®é¢˜æ—¶ï¼Œå¯ä»¥è¯·æ±‚ç”¨æˆ·æä¾›æ›´è¯¦ç»†çš„ä¿¡æ¯
- å¦‚æœæ–‡æ¡£ä¸­æ²¡æœ‰ç›¸å…³å†…å®¹ï¼Œå¿…é¡»æ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·
- ä¿æŒä¸“ä¸šã€ç¤¼è²Œçš„æ²Ÿé€šæ€åº¦
```

### 3.3 è¿è¡Œä¸æµ‹è¯•

1. **å¯åŠ¨åº”ç”¨**ï¼šè¿è¡Œ`D05Application`ä¸»ç±»
2. **è®¿é—®é¡µé¢**ï¼šæ‰“å¼€`http://localhost:8080/chat`
3. **ä¸Šä¼ æ–‡æ¡£**ï¼šé€‰æ‹©PDFã€Wordæˆ–æ–‡æœ¬æ–‡ä»¶
4. **æé—®æµ‹è¯•**ï¼šåœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥å…³äºæ–‡æ¡£çš„é—®é¢˜

å½“ç„¶åœ¨å¯åŠ¨æ—¶ï¼Œå¯ä»¥åœ¨å¯åŠ¨å‚æ•°ä¸­æŒ‡å®šå¤§æ¨¡å‹çš„ApiKeyï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä¿®æ”¹`applicatino.yml`ï¼Œç›´æ¥ç»´æŠ¤ä¸ŠapiKeyä¹Ÿå¯ä»¥å“¦

![](/imgs/column/llm/D04-3.gif)

åœ¨ä¸Šé¢è¿™ä¸ªç¤ºæ„å›¾ä¸­ï¼Œæˆ‘ä¸Šä¼ çš„æ˜¯ [åƒExcelä¸€æ ·é€‰æ‹©ç½‘é¡µè¡¨æ ¼ & æ”¯æŒé€‰ä¸­è¡¨å•ç”Ÿæˆsqlçš„ç¥å™¨ï¼šTableHelper](https://mp.weixin.qq.com/s/1s8NC-dCNIfqTXAHyN2e1g) çš„å®£ä¼ æ–‡æ¡£ï¼Œæ˜¾ç„¶æ˜¯æ²¡æœ‰è¢«å¤§æ¨¡å‹æ£€ç´¢ã€è®­ç»ƒè¿‡çš„ï¼Œä»é—®ç­”æ¥çœ‹ï¼Œæ•ˆæœè¿˜æ˜¯ä¸é”™çš„


ä½†æ˜¯è¯·æ³¨æ„ï¼Œè¿™ä¸ªåªæ˜¯ç»™å¤§å®¶ç”¨æ¥ä½“éªŒRAGçš„ï¼Œç”¨æ¥å­¦ä¹ éªŒè¯è¿˜æ˜¯ä¸é”™çš„ï¼›ä½†æ˜¯çœŸå®åœºæ™¯æ˜¾ç„¶æ¯”æˆ‘ä»¬æåˆ°çš„å†…å®¹è¿˜å¤šå¾ˆå¤šï¼Œæ¯”å¦‚

- å®‰å…¨éšç§ï¼šä¸åŒç”¨æˆ·çš„çŸ¥è¯†åº“æ–‡ä»¶éœ€è¦éš”ç¦»
- å­˜å‚¨ä¼˜åŒ–ï¼šä¸Šä¸‹æ–‡çª—å£çš„ç®¡ç†ã€å¯¹è¯å†å²çš„ç®¡ç†
- æ£€ç´¢ä¼˜åŒ–ï¼šå¤šè·¯å¬å›ã€æŸ¥è¯¢è¯­ä¹‰ç†è§£ã€æŸ¥è¯¢æ”¹å†™ç­‰
- æ¨¡å‹ä¼˜åŒ–ï¼šæˆæœ¬ã€æ•ˆç‡çš„æƒè¡¡
- ç›‘æ§ä½“ç³»ï¼šé“¾è·¯è¿½è¸ªã€æ—¥å¿—åˆ†æã€å‘Šè­¦ç­‰
- DevOps: CI/CDï¼Œå®¹å™¨ç¼–æ’
- ä½“éªŒã€æ€§èƒ½ç­‰


### 3.4 æ ¸å¿ƒæŠ€æœ¯è¦ç‚¹å°ç»“

### 1. RAGå·¥ä½œæµç¨‹
- **æ£€ç´¢é˜¶æ®µ**ï¼šå½“ç”¨æˆ·æé—®æ—¶ï¼Œç³»ç»Ÿé¦–å…ˆå°†é—®é¢˜è½¬æ¢ä¸ºå‘é‡ï¼Œç„¶ååœ¨æ–‡æ¡£å‘é‡åº“ä¸­æŸ¥æ‰¾ç›¸ä¼¼çš„æ–‡æ¡£ç‰‡æ®µ
- **ç”Ÿæˆé˜¶æ®µ**ï¼šå°†æ£€ç´¢åˆ°çš„ç›¸å…³æ–‡æ¡£å†…å®¹ä¸ç”¨æˆ·é—®é¢˜ä¸€èµ·è¾“å…¥å¤§è¯­è¨€æ¨¡å‹ï¼Œç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ

### 2. æ–‡æ¡£å¤„ç†ä¼˜åŒ–
- **ä¸­æ–‡åˆ†è¯**ï¼šä½¿ç”¨HanLPè¿›è¡Œç²¾ç¡®çš„ä¸­æ–‡åˆ†è¯ï¼Œæé«˜è¯­ä¹‰ç†è§£å‡†ç¡®æ€§
- **æ–‡æ¡£åˆ†å—**ï¼šå°†é•¿æ–‡æ¡£åˆç†åˆ†å—ï¼Œä¿æŒè¯­ä¹‰å®Œæ•´æ€§çš„åŒæ—¶ä¾¿äºæ£€ç´¢
- **å»é‡æœºåˆ¶**ï¼šé€šè¿‡MD5å“ˆå¸Œé¿å…é‡å¤ä¸Šä¼ ç›¸åŒçš„æ–‡æ¡£

### 3. æ€§èƒ½ä¼˜åŒ–
- **ç›¸ä¼¼åº¦è®¡ç®—**ï¼šä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦ç®—æ³•è®¡ç®—æ–‡æœ¬ç›¸ä¼¼åº¦
- **ç¼“å­˜æœºåˆ¶**ï¼šå¯¹å·²å¤„ç†çš„æ–‡æ¡£è¿›è¡Œç¼“å­˜ï¼Œé¿å…é‡å¤å¤„ç†
- **æµå¼å“åº”**ï¼šä½¿ç”¨SSEå®ç°ç­”æ¡ˆçš„æµå¼è¿”å›ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

æœ¬æ–‡é€šè¿‡ä¸€ä¸ªæœ€å°æˆæœ¬ï¼ˆæŠ€æœ¯å’Œèµ„é‡‘æˆæœ¬éƒ½å¾ˆå°ï¼‰çš„æ–¹æ¡ˆï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªå®Œæ•´çš„RAGçŸ¥è¯†åº“é—®ç­”æœºå™¨äººã€‚

é€šè¿‡è¿™ä¸ªé¡¹ç›®ï¼Œç›¸ä¿¡å¯¹RAGæ„Ÿå…´è¶£ï¼Œæƒ³å¿«é€Ÿä½“éªŒä¸€ä¸‹å®Œæˆæµç¨‹çš„å°ä¼™ä¼´ï¼Œå¯ä»¥æœ‰ä¸€ä¸ªåŠ¨æ‰‹å®æ“çš„æœºä¼šã€‚


