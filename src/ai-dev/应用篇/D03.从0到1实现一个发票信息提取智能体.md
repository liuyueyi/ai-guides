---
order: 3
title: D03.ä»0åˆ°1å®ç°ä¸€ä¸ªå‘ç¥¨ä¿¡æ¯æå–æ™ºèƒ½ä½“
tag:
  - Spring
  - SpringAI
category:
  - SpringAI
date: 2026-01-15 17:15:07
keywords: SpringAI
---

å‘ç¥¨çš„OCRè¯†åˆ«å¯¹äºç°ä»Šè€Œè¨€ï¼Œå¯ä»¥è¯´æ¯”è¾ƒæˆç†Ÿäº†ï¼›ä»Šå¤©æˆ‘ä»¬æ¥ä»0åˆ°1å®ç°ä¸€ä¸ªåŸºäºå¤§æ¨¡å‹çš„å‘ç¥¨æå–æ™ºèƒ½ä½“ï¼Œä¹ŸåŸºäºæ­¤çœ‹çœ‹å¤§æ¨¡å‹å¼€å‘å’Œä¼ ç»Ÿçš„å¼€å‘ä¹‹é—´ï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«

## ä¸€ã€ç³»ç»Ÿæ¶æ„è®¾è®¡

### 1.1 è®¾è®¡ç›®æ ‡

å¤§æ¨¡å‹å‘ç¥¨ä¿¡æ¯æå–æ–¹æ¡ˆï¼Œä¸»è¦åŸºäºSpringAI+å¤šæ¨¡æ€å¤§æ¨¡å‹ï¼Œå®ç°é›¶é…ç½®ã€é«˜æ³›åŒ–ã€ç«¯åˆ°ç«¯çš„å‘ç¥¨æ™ºèƒ½æå–ç³»ç»Ÿï¼Œæ ¸å¿ƒä¼˜åŠ¿ï¼š

- æ— éœ€æ¨¡æ¿ï¼šç›´æ¥ç†è§£ä»»æ„ç‰ˆå¼å‘ç¥¨
- è¯­ä¹‰ç†è§£ï¼šç†è§£å‘ç¥¨å†…å®¹è€Œéå•çº¯OCR
- ç»“æ„åŒ–è¾“å‡ºï¼šç›´æ¥ç”Ÿæˆå¯å…¥åº“çš„æ•°æ®ç»“æ„

### 1.2 ç³»ç»Ÿæ•´ä½“æ¶æ„

å¯¹åº”çš„ç³»ç»Ÿæ¶æ„è®¾è®¡å¦‚ä¸‹

![](/imgs/column/springai/D03-01.webp)

ä»æ•´ä½“çš„åˆ†å±‚ç»“æ„æ¥çœ‹ï¼Œä¸€ä¸ªå®Œæ•´çš„å‘ç¥¨æå–åŒ…å«ï¼š

- æ¥å…¥å±‚ï¼šè´Ÿè´£æ¥æ”¶å¤–éƒ¨è¯·æ±‚ã€åšåˆæ­¥æµé‡æ²»ç†
  - å®šä½ï¼šå¯ä»¥ç†è§£ä¸ºå…¨å±€ç½‘å…³ï¼Œæ‰¿æ¥å¤–éƒ¨æµé‡å¹¶è¿‡æ»¤éæ³•è¯·æ±‚
- åº”ç”¨å±‚ï¼šåšå‘ç¥¨çš„å¤šæ¨¡æ€è§£æï¼ˆæ¯”å¦‚è¯†åˆ«ç¥¨æ®å›¾ç‰‡ã€è§£ææ–‡æœ¬ï¼‰ + æ•°æ®æ ‡å‡†åŒ–ï¼ˆç»Ÿä¸€å‘ç¥¨ä¿¡æ¯çš„æ ¼å¼ï¼‰ï¼›
  - å®šä½ï¼š â€œä¸šåŠ¡ä¸­æ¢â€ï¼Œä¸²è”ä¸‹æ¸¸æœåŠ¡ã€å®ç°å‘ç¥¨æå–çš„æ ¸å¿ƒæµç¨‹
- æœåŠ¡å±‚ï¼šæŠŠå…·ä½“æŠ€æœ¯èƒ½åŠ›å°è£…ä¸ºç‹¬ç«‹æœåŠ¡ï¼Œä¾›åº”ç”¨å±‚è°ƒç”¨
  - å®šä½ï¼šèƒ½åŠ›ç»„ä»¶åº“ï¼Œè§£è€¦ä¸šåŠ¡é€»è¾‘ä¸æŠ€æœ¯å®ç°ã€‚
- å­˜å‚¨å±‚ï¼šæŒ‰æ•°æ®ç‰¹æ€§åˆ†ä¸¤ç±»å­˜å‚¨ï¼šç¼“å­˜å­˜å‚¨ï¼ˆRedisï¼‰å­˜é«˜é¢‘è®¿é—®çš„å‘ç¥¨ä¿¡æ¯ï¼Œæå‡æŸ¥è¯¢æ•ˆç‡  + æŒä¹…åŒ–å­˜å‚¨ï¼ˆPostgreSQLï¼‰å­˜å…¨é‡å‘ç¥¨æ•°æ®ï¼Œåšé•¿æœŸå½’æ¡£ã€‚
  - å®šä½ï¼šæ•°æ®ä»“åº“ï¼Œä¿éšœæ•°æ®çš„é«˜æ•ˆè®¿é—®ä¸é•¿æœŸç•™å­˜ã€‚
- è¿ç»´å±‚ï¼šç›‘æ§ä¸å®¡è®¡
  - å®šä½ï¼šè¿ç»´ä¿éšœï¼Œç¡®ä¿å…¨æµç¨‹å¯è§‚æµ‹ã€é—®é¢˜å¯è¿½æº¯

```mermaid
%%{init: { "theme": "base", "themeVariables": { "primaryColor": "#ffffff", "secondaryColor": "#f9f9f9", "tertiaryColor": "#eeeeee", "textColor": "#333", "fontSize": "16px", "subgraph_border_color": "#666", "subgraph_fill": "#f0f0f0" } } }%%
flowchart TB
    %% å…¨å±€æ ·å¼ï¼šä¸“ä¸šæ— è¡¬çº¿å­—ä½“ï¼Œç»Ÿä¸€åœ†è§’å’Œè¾¹æ¡†
    classDef base   font-size:12px, rounded:8, stroke-width:1.5
    
    %% æŠ½è±¡å±‚çº§å®šä¹‰
    subgraph SA["ğŸ‘¥ æ¥å…¥å±‚ (Access Layer)"]
        direction TB
        AL1[å¤šç«¯æ¥å…¥ç½‘å…³<br/>API/SDK/æ‰¹é‡ä¸Šä¼ ]
        AL2[è¯·æ±‚æ ¡éªŒ&è·¯ç”±<br/>é‰´æƒ/é™æµ/é™çº§]
    end
    
    
    subgraph SB["ğŸ”§ åº”ç”¨å±‚ (Application Layer)"]
        direction TB
        AP1[æ ¸å¿ƒå¤„ç†ä¸­å¿ƒ<br/>å¤šæ¨¡æ€è§£æ/æ•°æ®æ ‡å‡†åŒ–]
        AP2[èƒ½åŠ›æ‰©å±•å±‚<br/>Function Call/ç¬¬ä¸‰æ–¹é›†æˆ]
    end
    
    subgraph SC["ğŸ› ï¸ æœåŠ¡å±‚ (Service Layer)"]
        direction TB
        SL1[AIæ¨¡å‹æœåŠ¡<br/>ä¸»æ¨¡å‹/å…œåº•OCR]
        SL2[æ•°æ®å¤„ç†æœåŠ¡<br/>æ ¡éªŒ/ç¼“å­˜/æ ¼å¼è½¬æ¢]
    end
    
    subgraph SD["ğŸ’¾ å­˜å‚¨å±‚ (Storage Layer)"]
        direction TB
        ST1[ç¼“å­˜å­˜å‚¨<br/>Redis]
        ST2[æŒä¹…åŒ–å­˜å‚¨<br/>PostgreSQL]
    end
    
    subgraph SE["ğŸ” è¿ç»´å±‚ (Ops Layer)"]
        direction TB
        OP1[ç›‘æ§å‘Šè­¦<br/>æŒ‡æ ‡/é“¾è·¯è¿½è¸ª]
        OP2[æ—¥å¿—å®¡è®¡<br/>æ“ä½œç•™ç—•/é—®é¢˜æ’æŸ¥]
    end
    
    %% æ ¸å¿ƒæµè½¬é€»è¾‘
    AL1 --> AL2
    AL2 --> AP1
    AP1 --> AP2
    AP2 --> SL1 & SL2
    SL2 --> ST1 & ST2
    AP1 --> OP1
    ST2 --> OP2
    
    %% ä¸“ä¸šé…è‰²ï¼šå±‚çº§å·®å¼‚æ˜¾è‘—ï¼Œä½é¥±å’Œåº¦ç§‘æŠ€æ„Ÿ
    classDef access fill:#bbdefb,stroke:#1976d2,stroke-width:1.5
    style SA fill:#e6f4ff,stroke:#1976d2,stroke-width:2,opacity:0.6
    classDef application fill:#c8e6c9,stroke:#31a354,stroke-width:1.5
    style SB fill:#e8f5e8, stroke:#2e7d32, color:#005005, opacity:0.6
    classDef service fill:#e1bee7,stroke:#7b1fa2,stroke-width:1.5
    style SC fill:#f3e5f5, stroke:#7b1fa2, color:#4a0072, opacity:0.6   
    classDef storage fill:#b2dfdb,stroke:#00897b,stroke-width:1.5
    style SD fill:#e8f5e8, stroke:#00897b, color:#880e4f, opacity:0.6
    classDef ops fill:#f8bbd0,stroke:#c2185b,stroke-width:1.5
    style SE fill:#fce4ec, stroke:#c2185b, color:#880e4f, opacity:0.6
    
    class AL1,AL2 access
    class AP1,AP2 application
    class SL1,SL2 service
    class ST1,ST2 storage
    class OP1,OP2 ops

    linkStyle 0 stroke:#1976d2,stroke-width:1.5px
    linkStyle 1 stroke:#31a354,stroke-width:1.5px
    linkStyle 2 stroke:#31a354,stroke-width:1.5px
    linkStyle 3 stroke:#31a354,stroke-width:1.5px
    linkStyle 4 stroke:#31a354,stroke-width:1.5px
    linkStyle 5 stroke:#7b1fa2,stroke-width:1.5px
    linkStyle 6 stroke:#7b1fa2,stroke-width:1.5px
    linkStyle 7 stroke:#00897b,stroke-width:1.5px
```

### 1.3 ä¸šåŠ¡æµç¨‹

åŸºäºä¸Šé¢çš„ç³»ç»Ÿæ¶æ„ï¼Œæˆ‘ä»¬å¯ä»¥ä¸²ä¸€ä¸‹å‘ç¥¨ä¿¡æ¯æå–çš„å…¨æµç¨‹

- ç”¨æˆ·ä¸Šä¼ å‘ç¥¨
- åç«¯åº”ç”¨æ¥å—è¯·æ±‚ï¼Œåšä¸€äº›åŸºæœ¬è¿‡æ»¤
- åº”ç”¨å±‚å¤„ç†å‘ç¥¨è¯†åˆ«é€»è¾‘
- æœåŠ¡å±‚ä¸å¤§æ¨¡å‹äº¤äº’ï¼Œæå–è¯†åˆ«ç»“æœï¼Œå¹¶å­˜å‚¨ç›¸å…³çš„æ•°æ®

![](/imgs/column/springai/D03-02.webp)

```
graph TD
    %% æ ·å¼å®šä¹‰ï¼šæŒ‰æ¶æ„åˆ†å±‚è®¾ç½®é…è‰²ï¼Œé€‚é…ç ”å‘è§†è§’
    classDef userLayer fill:#e6f7ff,stroke:#1890ff,stroke-width:2px,color:#000;
    classDef accessLayer fill:#b3e0ff,stroke:#096dd9,stroke-width:2px,color:#000;
    classDef appLayer fill:#b7eb8f,stroke:#52c41a,stroke-width:2px,color:#000;
    classDef serviceLayer fill:#fff7e6,stroke:#fa8c16,stroke-width:2px,color:#000;
    classDef storageLayer fill:#f9e5ff,stroke:#722ed1,stroke-width:2px,color:#000;
    classDef opsLayer fill:#f0f2f5,stroke:#8c8c8c,stroke-width:2px,color:#000;

    %% æµç¨‹èŠ‚ç‚¹
    A[ç”¨æˆ·ä¸Šä¼ å‘ç¥¨æ–‡ä»¶/å›¾ç‰‡]:::userLayer --> B[æ¥å…¥å±‚ï¼šæƒé™æ ¡éªŒ+é™æµæ§åˆ¶]:::accessLayer
    B --> C[æ¥å…¥å±‚ï¼šè¯·æ±‚è·¯ç”±åˆ†å‘]:::accessLayer
    C --> D[åº”ç”¨å±‚ï¼šæ¥æ”¶è¯·æ±‚å¹¶åˆå§‹åŒ–å¤„ç†æµç¨‹]:::appLayer
    D --> E[åº”ç”¨å±‚ï¼šè°ƒç”¨AIæ¨¡å‹æœåŠ¡]:::appLayer
    E --> F[æœåŠ¡å±‚ï¼šå‘ç¥¨OCRè¯†åˆ«+å¤§æ¨¡å‹ä¿¡æ¯æå–]:::serviceLayer
    F --> G[æœåŠ¡å±‚ï¼šæ•°æ®æ ¡éªŒ+æ ¼å¼æ ‡å‡†åŒ–]:::serviceLayer
    G --> H[å­˜å‚¨å±‚ï¼šç¼“å­˜é«˜é¢‘å‘ç¥¨æ•°æ®ï¼ˆRedisï¼‰]:::storageLayer
    G --> I[å­˜å‚¨å±‚ï¼šæŒä¹…åŒ–å…¨é‡å‘ç¥¨æ•°æ®ï¼ˆPGï¼‰]:::storageLayer
    H & I --> J[åº”ç”¨å±‚ï¼šæ•´åˆæå–ç»“æœå¹¶å°è£…]:::appLayer
    J --> K[æ¥å…¥å±‚ï¼šè¿”å›æ ‡å‡†åŒ–å‘ç¥¨ä¿¡æ¯ç»“æœ]:::accessLayer
    K --> L[ç”¨æˆ·æ¥æ”¶å‘ç¥¨æå–ç»“æœ]:::userLayer

    %% è¿ç»´å±‚å…¨æµç¨‹ç›‘æ§ï¼ˆå¹¶è¡Œï¼‰
    B -.-> M[è¿ç»´å±‚ï¼šè¯·æ±‚æµé‡ç›‘æ§]:::opsLayer
    F -.-> N[è¿ç»´å±‚ï¼šæ¨¡å‹è°ƒç”¨é“¾è·¯è¿½è¸ª]:::opsLayer
    G -.-> O[è¿ç»´å±‚ï¼šæ•°æ®å¤„ç†æ—¥å¿—å®¡è®¡]:::opsLayer
    K -.-> P[è¿ç»´å±‚ï¼šç»“æœè¿”å›å»¶è¿Ÿç»Ÿè®¡]:::opsLayer
    M & N & O & P --> Q[è¿ç»´å±‚ï¼šå¼‚å¸¸å‘Šè­¦ï¼ˆå¦‚æœ‰ï¼‰]:::opsLayer
```


## äºŒã€æ•°æ®ç»“æ„è®¾è®¡

ä¸€ä¸ªå®Œæ•´çš„åº”ç”¨å®ç°åº”è¯¥åŒ…å«æˆ‘ä»¬ä¸Šé¢æåˆ°çš„å…­å±‚ç»“æ„ï¼›å½“ç„¶ç”±äºç¯‡å¹…æœ‰é™ï¼Œæˆ‘ä»¬è¿™é‡Œåˆ™åªæŠ“é‡ç‚¹ï¼Œä¸»è¦å…³æ³¨ä¸‹å¤§æ¨¡å‹è¿™ä¸€å±‚çš„äº¤äº’å®ç°ä¸Šï¼›å¯¹äºæŒä¹…åŒ–ã€è¿ç»´ç›‘æ§è¿™å—å°±ä¸€ç¬”å¸¦è¿‡

### 2.1 å‘ç¥¨æ ¸å¿ƒæ•°æ®æ¨¡å‹

å‘ç¥¨æœ¬èº«çš„ç±»å‹è¾ƒå¤šï¼Œä¸åŒçš„å‘ç¥¨å¯¹åº”çš„ä¿¡æ¯ä¹Ÿä¸å¤ªä¸€æ ·ï¼Œè¿™å—çš„ä¸“ä¸šæ€§æœ‰ä¸€ç‚¹é«˜ï¼›å¦‚æœä¸å¤ªç†Ÿæ‚‰è¿™å—ä¸šåŠ¡èƒŒæ™¯çš„å°ä¼™ä¼´ï¼Œç›´æ¥å¯¹ç…§å‘ç¥¨æ¥éªŒè¯å³å¯ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ˜¯ä¸€å¼ ä»baiduä¸Šæ‰¾åˆ°çš„ä¸“ç¥¨

![æ¥æºäºç™¾åº¦](https://5b0988e595225.cdn.sohucs.com/images/20191017/c0cf274fec0141439a636ab0c353752a.jpeg)

ä»è¿™ä¸ªç¥¨é¢ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰é”€å”®æ–¹ã€è´­ä¹°æ–¹ä¿¡æ¯(æ ¸å¿ƒæ˜¯åç§° + çº³ç¨äººè¯†åˆ«å·)

```java
@JsonClassDescription(value = "å‘ç¥¨æ–¹ä¿¡æ¯")
public record PartyInfo(
        @JsonPropertyDescription(value = "åç§°")
        String name,
        @JsonPropertyDescription(value = "çº³ç¨äººè¯†åˆ«å·")
        String taxId,
        @JsonPropertyDescription(value = "åœ°å€")
        String address,
        @JsonPropertyDescription(value = "ç”µè¯")
        String phone,
        @JsonPropertyDescription(value = "å¼€æˆ·é“¶è¡Œ")
        String bank,
        @JsonPropertyDescription(value = "é“¶è¡Œè´¦å·")
        String account) {
}
```

å‘ç¥¨è¡Œä¿¡æ¯ï¼ˆå³å•†å“ã€æœåŠ¡åç§°ï¼‰

```java
@JsonClassDescription(value = "å‘ç¥¨å•†å“æ˜ç»†")
public record InvoiceItem(
        @JsonPropertyDescription(value = "å•†å“åç§°")
        String itemName,
        @JsonPropertyDescription(value = "å•†å“è§„æ ¼")
        String specification,
        @JsonPropertyDescription(value = "å•ä½")
        String unit,
        @JsonPropertyDescription(value = "æ•°é‡")
        BigDecimal quantity,
        @JsonPropertyDescription(value = "å•ä»·")
        BigDecimal unitPrice,
        @JsonPropertyDescription(value = "é‡‘é¢")
        BigDecimal amount,
        @JsonPropertyDescription(value = "ç¨ç‡")
        BigDecimal taxRate,
        @JsonPropertyDescription(value = "ç¨é¢")
        BigDecimal taxAmount,
        @JsonPropertyDescription(value = "ä»·ç¨åˆè®¡")
        BigDecimal totalAmount) {
}
```

å¯¹åº”çš„å‘ç¥¨ä¿¡æ¯

```java
@Data
@JsonClassDescription(value = "å‘ç¥¨å®Œæ•´ä¿¡æ¯")
public class InvoiceInfo {
    // å‘ç¥¨åŸºæœ¬ä¿¡æ¯
    @JsonPropertyDescription(value = "å‘ç¥¨ç±»å‹ï¼Œå¦‚ï¼šå¢å€¼ç¨ä¸“ç”¨å‘ç¥¨")
    private String invoiceType;

    @JsonPropertyDescription(value = "å‘ç¥¨ä»£ç ï¼Œå¦‚ï¼š044001800111")
    private String invoiceCode;

    @JsonPropertyDescription(value = "å‘ç¥¨å·ç ï¼Œå¦‚ï¼š12345678")
    private String invoiceNumber;

    // æœºå™¨ç¼–å·
    @JsonPropertyDescription(value = "æœºå™¨ç¼–å·ï¼Œå¦‚ï¼š66173206007")
    private String machineNumber;

    @JsonPropertyDescription(value = "å¯†ç åŒºï¼Œå¦‚ï¼š0-TZ099+/8<0*8+T98Z/<6T</L9>0-260<*L6/6T/S->>00998Â¥//<L82Z099*+/8<0*8+T9*/Z<Â¥<696<E9200-896+/8T*8-")
    private String passwordArea;

    @JsonPropertyDescription(value = "å¼€ç¥¨æ—¥æœŸï¼Œå¦‚ï¼š2024-01-15")
    private LocalDate issueDate;

    @JsonPropertyDescription(value = "æ ¡éªŒç ï¼Œå¦‚ï¼š12345 67890 12345 67890")
    private String checkCode;

    // è´­é”€åŒæ–¹ä¿¡æ¯
    @JsonPropertyDescription(value = "é”€å”®æ–¹ä¿¡æ¯")
    private PartyInfo seller;

    @JsonPropertyDescription(value = "è´­ä¹°æ–¹ä¿¡æ¯")
    private PartyInfo buyer;

    // é‡‘é¢ä¿¡æ¯
    @JsonPropertyDescription(value = "ä¸å«ç¨é‡‘é¢")
    private BigDecimal amountWithoutTax;

    @JsonPropertyDescription(value = "ç¨é¢")
    private BigDecimal taxAmount;

    @JsonPropertyDescription(value = "ä»·ç¨åˆè®¡")
    private BigDecimal totalAmount;

    @JsonPropertyDescription(value = "ç¨ç‡ï¼Œå¦‚ï¼š0.13")
    private BigDecimal taxRate;

    @JsonPropertyDescription(value = "å¤‡æ³¨")
    private String remark;

    @JsonPropertyDescription(value = "æ”¶æ¬¾äºº")
    private String payee;

    @JsonPropertyDescription(value = "å¤æ ¸äºº")
    private String reviewer;

    @JsonPropertyDescription(value = "å¼€ç¥¨äºº")
    private String issuer;

    // ç³»ç»Ÿä¿¡æ¯
    @JsonPropertyDescription(value = "å‘ç¥¨å›¾ç‰‡MD5")
    private String imageHash;

    @JsonPropertyDescription(value = "æå–ç½®ä¿¡åº¦ï¼Œå¦‚ï¼š0.95")
    private Double confidence;

    @JsonPropertyDescription(value = "æå–æ—¶é—´")
    private LocalDateTime extractTime;

    @JsonPropertyDescription(value = "å•†å“/æœåŠ¡æ˜ç»†åˆ—è¡¨")
    private List<InvoiceItem> items;
}
```


### 2.2 è¯·æ±‚å“åº”æ¨¡å‹

å¦‚æœæˆ‘ä»¬å¸Œæœ›æä¾›ä¸€ä¸ªåŠŸèƒ½é½å…¨çš„å‘ç¥¨æå–æœåŠ¡ï¼Œé‚£ä¹ˆæœ‰å¿…è¦å¥½å¥½è®¾è®¡ä¸€ä¸‹æä¾›REST APIï¼ˆæœ€å¥½æ˜¯åŸºäºçœŸå®çš„ä¸šåŠ¡è¯‰æ±‚æ¥è®¾è®¡ï¼‰ï¼Œæˆ‘ä»¬å…ˆåšä¸€ä¸ªéå¸¸åŸºç¡€ç®€å•çš„èƒ½åŠ›æä¾›


ä¸Šä¼ æ–¹å¼ï¼š

- ä¼ å‘ç¥¨æ–‡ä»¶
- ä¼ base64å›¾æ ¼å¼æ”¾ç¥¨
- ä¼ httpæ ¼å¼å‘ç¥¨
- æŒ‡å®šæ˜¯å¦éœ€è¦è§£æå‘ç¥¨çš„å•†å“è¡Œ


```java
@Data
@Schema(description = "å‘ç¥¨æå–è¯·æ±‚")
public class InvoiceExtractRequest {

    @Schema(description = "å‘ç¥¨å›¾ç‰‡,å¦‚æœæ˜¯httpå¼€å¤´è¡¨ç¤ºå‘ç¥¨è®¿é—®é“¾æ¥ï¼›å¦‚æœæ˜¯ data:image/png;base64, å¼€å¤´è¡¨ç¤ºä¸ºbase64æ ¼å¼å›¾ç‰‡")
    private String image;

    @Schema(description = "å›¾ç‰‡æ ¼å¼", example = "image/jpeg")
    private String imageType;

    @Schema(description = "æ˜¯å¦éœ€è¦å•†å“æ˜ç»†", example = "true")
    private boolean needItems = true;

    @Schema(description = "æç¤ºä¿¡æ¯")
    private String msg;
}
```

å¯¹åº”çš„è¿”å›æ¯”è¾ƒå¸¸è§äº†

```java
// å®šä¹‰ä¸€ä¸ªæšä¸¾çŠ¶æ€ï¼Œç”¨äºæ ‡è®°è¯†åˆ«ç»“æœ
public enum ProcessStatus {
    SUCCESS,
    PARTIAL_SUCCESS,
    VALIDATION_FAILED,
    OCR_FAILED,
    TIMEOUT,
    ERROR
}


// è¿”å›çš„åŒ…è£…ç»“æœ
@Data
@Accessors(chain = true)
@Schema(description = "å‘ç¥¨æå–å“åº”")
public class InvoiceExtractResponse {

    @Schema(description = "è¯·æ±‚ID")
    private String requestId;

    @Schema(description = "å¤„ç†çŠ¶æ€")
    private ProcessStatus status;

    @Schema(description = "æå–ç»“æœ")
    private InvoiceInfo invoiceInfo;

    @Schema(description = "å¤„ç†è€—æ—¶(ms)")
    private Long processTime;

    @Schema(description = "é”™è¯¯ä¿¡æ¯")
    private String errorMessage;
}

```

## ä¸‰ã€é¡¹ç›®æ­å»º

é¦–å…ˆæˆ‘ä»¬éœ€è¦æ­å»ºè¦ç»™SpringAIçš„é¡¹ç›®ï¼Œä¸å¤ªç†Ÿæ‚‰çš„å°ä¼™ä¼´å¯ä»¥å‚ç…§ [01.åˆ›å»ºä¸€ä¸ªSpringAIçš„ç¤ºä¾‹å·¥ç¨‹ | ä¸€ç°ç°çš„ç«™ç‚¹](https://hhui.top/tutorial/spring/springai/%E5%9F%BA%E7%A1%80%E7%AF%87/01.%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AASpringAI-Demo%E5%B7%A5%E7%A8%8B.html) æ¥å®Œæˆ

åœ¨ä¸‹é¢çš„å®ç°è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æ™ºè°±çš„å…è´¹å¤§æ¨¡å‹ä½œä¸ºæˆ‘ä»¬çš„å®é™…è½½ä½“ï¼›è‹¥å¸Œæœ›ä½¿ç”¨å…¶ä»–çš„æ¨¡å‹çš„å°ä¼™ä¼´ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ›¿æ¢ï¼ˆSpringAIå¯¹ä¸åŒå‚å•†çš„å¤§æ¨¡å‹é›†æˆå¾—ç›¸å½“å¯ä»¥ï¼Œåˆ‡æ¢æˆæœ¬è¾ƒä½ï¼‰

### 3.1 åŸºç¡€ç¯å¢ƒ

æˆ‘ä»¬ä½¿ç”¨çš„SpringAIçš„ç‰ˆæœ¬ä¸ºæœ€æ–°çš„ `1.1.2` ï¼Œæ­¤å¤–ç›´æ¥ä½¿ç”¨ zhipu çš„starteræ¥ä½œä¸ºå¤§æ¨¡å‹çš„äº¤äº’å®¢æˆ·ç«¯

```xml
<!-- pom.xml å…³é”®ä¾èµ– -->
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-starter-model-zhipuai</artifactId>
    </dependency>
    <dependency>
        <groupId>cn.hutool</groupId>
        <artifactId>hutool-http</artifactId>
        <version>5.8.38</version>
    </dependency>
</dependencies>
```

ç„¶ååœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œè®¾ç½®å¯¹åº”çš„é…ç½®ä¿¡æ¯ï¼Œå…¶ä¸­å…³é”®ç‚¹ä¸º 

- api-key: å¯ä»¥é€šè¿‡å¯åŠ¨å‚æ•°ã€ç³»ç»Ÿç¯å¢ƒå˜é‡ç­‰æ–¹å¼æ³¨å…¥keyï¼Œä»è€Œé¿å…ç¡¬ç¼–ç å¯¼è‡´çš„æ³„éœ²é—®é¢˜
- model: é€‰æ‹©çš„æ˜¯å…è´¹çš„ `GLM-4.1V-Thinking-Flash`ï¼Œ æ”¯æŒå›¾ç‰‡è¯†åˆ«ï¼ˆç›¸æ¯”è¾ƒäº `GLM-4V-Flash` ä¸Šä¸‹æ–‡çª—å£æ›´å¤§ï¼Œä½†æ˜¯å“åº”ä¹Ÿæ›´æ…¢ï¼‰
- temperature: 0.1 ä½æ¸©åº¦ï¼Œä¿è¯æå–çš„ç¨³å®šæ€§

```yaml
# application.yml
spring:
  ai:
    zhipuai:
      # api-key ä½¿ç”¨ä½ è‡ªå·±ç”³è¯·çš„è¿›è¡Œæ›¿æ¢ï¼›å¦‚æœä¸ºäº†å®‰å…¨è€ƒè™‘ï¼Œå¯ä»¥é€šè¿‡å¯åŠ¨å‚æ•°è¿›è¡Œè®¾ç½®
      api-key: ${zhipuai-api-key}
      chat:
        options:
          model: GLM-4.1V-Thinking-Flash  # è§†è§‰ç†è§£æ¨¡å‹, è¿™ä¸ªæ¨¡å‹çš„ä¸Šä¸‹æ–‡çª—å£ 64Kï¼Œæ¯” GLM-4V-Flash çš„ 4K å¯ä»¥è¿”å›æ›´å¤šçš„å†…å®¹
          temperature: 0.1 # ä½æ¸©åº¦ï¼Œä¿è¯æå–çš„ç¨³å®šæ€§


# ä¿®æ”¹æ—¥å¿—çº§åˆ«
logging:
  level:
    org.springframework.ai.chat.client.advisor.SimpleLoggerAdvisor: debug
```

### 3.2 å¯é€‰çš„å‘ç¥¨æå–å·¥å…·é¡µ

ä¸ºäº†æ›´å¥½çš„è¿›è¡Œäº¤äº’ä½“éªŒï¼Œæˆ‘ä»¬å®ç°ä¸€ä¸ªç½‘é¡µäº¤äº’é¡µé¢ï¼Œç”¨äºä¸Šä¼ å‘ç¥¨ã€æŸ¥çœ‹è¿”å›ç»“æœï¼Œç›´æ¥åŸºäº thymleaf æ¥å®ç°

å› æ­¤æ·»åŠ ä¾èµ– `spring-boot-starter-thymeleaf`

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-thymeleaf</artifactId>
</dependency>
```

å¦‚æœæœ¬åœ°å¼€å‘ï¼Œéœ€è¦ä¿®æ”¹å‰ç«¯é¡µé¢çš„å°ä¼™ä¼´ï¼Œå¯ä»¥è€ƒè™‘å…³é—­ç¼“å­˜ ï¼ˆå¯é€‰é…ç½®ï¼‰

```yaml
# application.yml
spring:
  thymeleaf:
    cache: false
```


## å››ã€æ ¸å¿ƒå®ç°ä»£ç 

### 4.1 æç¤ºè¯ç®¡ç†

é¦–å…ˆæˆ‘ä»¬éœ€è¦åˆ¶å®šå¤§æ¨¡å‹æ¥æå–ç»“æ„åŒ–å‘ç¥¨çš„æç¤ºè¯ï¼ŒåŒºåˆ«äº [å¤§æ¨¡å‹åº”ç”¨å¼€å‘å®æˆ˜ï¼šä¸¤ç™¾è¡Œå®ç°ä¸€ä¸ªè‡ªç„¶è¯­è¨€åœ°å€æå–æ™ºèƒ½ä½“](https://mp.weixin.qq.com/s/96rHyp_gBUgmA2dhSbzNww) ä¸­çš„ç¡¬ç¼–ç å®ç°æ–¹å¼ï¼Œæˆ‘ä»¬å°†æç¤ºè¯ç»Ÿä¸€æ”¾åœ¨èµ„æºç›®å½•ä¸‹ `resources/prompt` å‘½åä¸º `xxx.pt`çš„æ–‡æœ¬ä¸­ä¿å­˜æç¤ºè¯æ¨¡æ¿

ä¸€ä¸ªå¯ç”¨äºå¤§æ¨¡å‹æå–å‘ç¥¨çš„æç¤ºè¯å¦‚ä¸‹

```pt
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å‘ç¥¨ä¿¡æ¯æå–ä¸“å®¶ã€‚è¯·ä»ç”¨æˆ·æä¾›çš„å‘ç¥¨å›¾ç‰‡ä¸­æå–å®Œæ•´çš„ç»“æ„åŒ–ä¿¡æ¯ã€‚

å¿…é¡»éµå¾ªï¼š
1. å‡†ç¡®è¯†åˆ«å‘ç¥¨ç±»å‹ï¼ˆå¢å€¼ç¨ä¸“ç”¨å‘ç¥¨ã€å¢å€¼ç¨æ™®é€šå‘ç¥¨ã€ç”µå­æ™®é€šå‘ç¥¨ç­‰ï¼‰
2. æå–æ‰€æœ‰å…³é”®å­—æ®µï¼šå‘ç¥¨ä»£ç ã€å‘ç¥¨å·ç ã€å¼€ç¥¨æ—¥æœŸã€æ ¡éªŒç ç­‰
3. è¯†åˆ«è´­é”€åŒæ–¹å®Œæ•´ä¿¡æ¯ï¼ˆåç§°ã€çº³ç¨äººè¯†åˆ«å·ã€åœ°å€ç”µè¯ã€å¼€æˆ·è¡ŒåŠè´¦å·ï¼‰
4. æå–å•†å“æ˜ç»†ï¼ŒåŒ…æ‹¬å•†å“åç§°ã€è§„æ ¼ã€å•ä½ã€æ•°é‡ã€å•ä»·ã€é‡‘é¢ã€ç¨ç‡ã€ç¨é¢
5. è®¡ç®—å¹¶æ ¸å¯¹é‡‘é¢ï¼šä¸å«ç¨é‡‘é¢ã€ç¨é¢ã€ä»·ç¨åˆè®¡
6. è¯†åˆ«å¤‡æ³¨ã€æ”¶æ¬¾äººã€å¤æ ¸äººã€å¼€ç¥¨äººç­‰ä¿¡æ¯
7. å¯¹äºæ¨¡ç³Šæˆ–ä¸æ¸…æ™°æˆ–æ— æ³•è¯†åˆ«çš„å­—æ®µï¼Œè¯·ä½¿ç”¨nullå€¼ã€‚
8. è¯·ç¡®ä¿æ‰€æœ‰é‡‘é¢å­—æ®µä¸ºæ•°å­—ç±»å‹ï¼Œæ—¥æœŸä¸ºå­—ç¬¦ä¸²æ ¼å¼ã€‚
9. è¯·åŠ¡å¿…è¿”å›å®Œæ•´å†…å®¹ï¼Œä¸è¦æˆªæ–­JSONã€‚

è¾“å‡ºæ ¼å¼è¦æ±‚ï¼š
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼Œä¸è¦åŒ…å«ä»»ä½•é¢å¤–æ–‡æœ¬ï¼š
{
  "invoiceType": "å‘ç¥¨ç±»å‹",
  "invoiceCode": "å‘ç¥¨ä»£ç ",
  "invoiceNumber": "å‘ç¥¨å·ç ",
  "issueDate": "YYYY-MM-DD",
  "checkCode": "æ ¡éªŒç ",
  "seller": {
    "name": "é”€å”®æ–¹åç§°",
    "taxId": "çº³ç¨äººè¯†åˆ«å·",
    "address": "åœ°å€",
    "phone": "ç”µè¯",
    "bank": "å¼€æˆ·è¡Œ",
    "account": "è´¦å·"
  },
  "buyer": {
    "name": "è´­ä¹°æ–¹åç§°",
    "taxId": "çº³ç¨äººè¯†åˆ«å·",
    "address": "åœ°å€",
    "phone": "ç”µè¯",
    "bank": "å¼€æˆ·è¡Œ",
    "account": "è´¦å·"
  },
  "amountWithoutTax": 1000.00,
  "taxAmount": 130.00,
  "totalAmount": 1130.00,
  "taxRate": 0.13,
  "items": [
    {
      "itemName": "å•†å“åç§°",
      "specification": "è§„æ ¼å‹å·",
      "unit": "å•ä½",
      "quantity": 1.0,
      "unitPrice": 1000.00,
      "amount": 1000.00,
      "taxRate": 0.13,
      "taxAmount": 130.00,
      "totalAmount": 1130.00
    }
  ],
  "remark": "å¤‡æ³¨ä¿¡æ¯",
  "payee": "æ”¶æ¬¾äºº",
  "reviewer": "å¤æ ¸äºº",
  "issuer": "å¼€ç¥¨äºº",
  "confidence": 0.95
}
```

### 4.2 æç¤ºè¯æ³¨å…¥

ç„¶ååœ¨åº”ç”¨ä¸­ï¼Œå¯¹åº”çš„æç¤ºè¯å¯ä»¥ç›´æ¥ä½¿ç”¨ `@Value` æ³¨è§£è¿›è¡Œæ³¨å…¥ï¼Œå¦‚æå–æœåŠ¡çš„åˆå§‹åŒ–


```java
@Slf4j
@Service
public class InvoiceExtractionService {

    @Value("classpath:/prompts/invoice-extract.st")
    private Resource invoiceSystemPrompt;

    private final ChatModel chatModel;
    private final ChatClient chatClient;

    public InvoiceExtractionService(ChatModel chatModel) {
        this.chatModel = chatModel;
        this.chatClient = ChatClient.builder(chatModel)
                .defaultAdvisors(new SimpleLoggerAdvisor())
                .build();
    }
}
```

### 4.3 åŸºäºå¤§æ¨¡å‹çš„å‘ç¥¨ä¿¡æ¯æå–

æ¥ä¸‹æ¥å°±æ˜¯æ ¸å¿ƒçš„å€ŸåŠ©SpringAIå®ç°å¤§æ¨¡å‹çš„äº¤äº’ï¼ŒåŸºäºå¤šæ¨¡æ€çš„äº¤äº’æ–¹æ¡ˆï¼Œä¼ å…¥ç³»ç»Ÿæç¤ºè¯ã€ç”¨æˆ·æ¶ˆæ¯+å›¾ç‰‡ï¼Œå®šä¹‰ç»“æœåŒ–è¿”å›ï¼Œä»¥æ­¤æ¥è·å–å“åº”ç»“æœ

> ä¸åˆ°åè¡Œçš„ä»£ç ï¼Œå°±å¯ä»¥å®ç°æå–é€»è¾‘ï¼ˆå±å®æ˜¯æœ‰ç‚¹å¤¸å¼ äº†å•Š~ï¼‰

```java
/**
 * è¯†åˆ«å‘ç¥¨å†…å®¹
 *
 * @param imageBytes å›¾ç‰‡å­—èŠ‚
 * @param mimeType   å›¾ç‰‡ç±»å‹
 * @param msg        è¯†åˆ«æç¤ºä¿¡æ¯
 * @return
 */
public InvoiceInfo extractInvoice(byte[] imageBytes, MimeType mimeType, String msg) {
    long start = System.currentTimeMillis();
    Message systemMsg = new SystemMessage(invoiceSystemPrompt);
    Media media = Media.builder().mimeType(mimeType).data(imageBytes).build();
    Message userMsg = UserMessage.builder().text((msg != null && !msg.isEmpty()) ? msg : "è¯·å°†å‘ç¥¨å›¾ç‰‡å†…å®¹è¿›è¡Œè¯†åˆ«ï¼Œå¹¶è¿”å›ç»“æ„åŒ–çš„å‘ç¥¨ä¿¡æ¯").media(media).build();

    Prompt prompt = new Prompt(List.of(systemMsg, userMsg));
    InvoiceInfo invoiceInfo = chatClient.prompt(prompt).call().entity(InvoiceInfo.class);
    log.info("è§£æè€—æ—¶ï¼š{} è¿”å›: \n{}", System.currentTimeMillis() - start, toStr(invoiceInfo));
    return invoiceInfo;
}
```

### 4.4 éªŒè¯æ¥å£

æ¥ä¸‹æ¥ä¸ºäº†å¿«é€ŸéªŒè¯æ•ˆæœï¼Œæˆ‘ä»¬å¯ä»¥æ•´ä¸€ä¸ªç®€å•çš„éªŒè¯æ¥å£ï¼Œæ¥æ”¶ä¸Šä¼ çš„å‘ç¥¨ï¼Œè¿”å›æå–ç»“æœ

```java
@Controller
public class InvoiceExtractionController {
    private final InvoiceExtractionService invoiceExtractionService;

    public InvoiceExtractionController(InvoiceExtractionService invoiceExtractionService) {
        this.invoiceExtractionService = invoiceExtractionService;
    }

    /**
     * ä¸Šä¼ å‘ç¥¨å›¾ç‰‡å¹¶æå–å†…å®¹
     *
     * @param file ä¸Šä¼ çš„å‘ç¥¨å›¾ç‰‡æ–‡ä»¶
     * @param msg  è¯†åˆ«æç¤ºä¿¡æ¯
     * @return è¯†åˆ«ç»“æœ
     */
    @ResponseBody
    @PostMapping(path = "/extractInvoice")
    public InvoiceInfo extractInvoice(@RequestParam("file") MultipartFile file,
                                      @RequestParam(value = "msg", required = false) String msg
    ) throws IOException {
        byte[] imageBytes = file.getBytes();
        MimeType mimeType = MimeType.valueOf(file.getContentType());
        return invoiceExtractionService.extractInvoice(imageBytes, mimeType, msg);
    }


    /**
     * æ˜¾ç¤ºå‘ç¥¨è¯†åˆ«é¡µé¢
     *
     * @return HTMLé¡µé¢
     */
    @GetMapping("/invoicePage")
    public String invoicePage(Model model) {
        return "invoice_extraction";
    }
}
```


ç„¶åè®©AIå¸®æˆ‘ç”Ÿæˆä¸€ä¸ªäº¤äº’çš„å‰ç«¯é¡µé¢ï¼Œ `invoice_extraction.html`ï¼Œæ”¾åœ¨ `resources/template` ç›®å½•ä¸‹

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘ç¥¨ä¿¡æ¯æå–</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background-color: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }

        .main-layout {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .left-panel,  .right-panel {
            flex: 3;
            min-width: 0;
            min-height: 400px;
            border: 1px dashed #ccc;
            text-align: center;
        }
        .center-panel {
            flex: 1;
            text-align: center;
            min-height: 400px;
            border: 1px dashed #ccc;
            padding: 12px;
        }

        .panel {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        .upload-area.highlight {
            border-color: #007bff;
            background-color: #f0f8ff;
        }

        .upload-area p {
            margin: 0 0 15px 0;
            color: #666;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }

        .upload-btn:hover {
            background-color: #0056b3;
        }

        .checkbox-container {
            margin: 15px 0;
            text-align: center;
            display: block;
        }

        .checkbox-label-2 {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            user-select: none;
        }

        .checkbox-input {
            margin-right: 8px;
            width: 16px;
            height: 16px;
            cursor: pointer;
            vertical-align: middle;
        }

        .checkbox-text {
            vertical-align: middle;
        }



        .preview-container {
            text-align: center;
            margin-top: 15px;
            display: none;
        }

        .preview-container h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
        }

        .preview-image {
            max-width: 100%;
            max-height: 350px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: 1px solid #eee;
        }

        .controls {
            text-align: center;
            margin: 20px 0;
        }

        .identify-btn {
            background-color: #28a745;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: block;
            width: 100%;
            margin-bottom: 10px;
        }

        .identify-btn:hover {
            background-color: #218838;
        }

        .clear-btn {
            background-color: #dc3545;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: block;
            width: 100%;
        }

        .clear-btn:hover {
            background-color: #c82333;
        }

        .result-container {
            margin-top: 20px;
        }

        .result-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .result-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 500px;
            min-height: 300px;
            overflow-y: auto;
            background-color: white;
            margin: 10px;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .paste-area {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            background-color: #fafafa;
        }

        .paste-area p {
            margin: 0;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>å‘ç¥¨ä¿¡æ¯æå–ç³»ç»Ÿ</h1>
    <div class="top">
        <h3>é€‰æ‹©å‘ç¥¨å›¾ç‰‡</h3>
        <div class="upload-area" id="uploadArea">
            <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é€‰æ‹©å›¾ç‰‡ï¼Œæˆ–å°†å›¾ç‰‡æ‹–æ‹½åˆ°æ­¤åŒºåŸŸ</p>
            <input type="file" id="fileInput" class="file-input" accept="image/*">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">é€‰æ‹©å›¾ç‰‡</button>
            <div class="paste-area">
                <p>æˆ–è€…æŒ‰ Ctrl+V ç²˜è´´å‰ªè´´æ¿ä¸­çš„å›¾ç‰‡</p>
            </div>
        </div>
    </div>
    <div class="main-layout panel">
        <!-- å·¦ä¾§é¢æ¿ï¼šå›¾ç‰‡é€‰æ‹©å’Œé¢„è§ˆ -->
        <div class="left-panel">
            <h3>å›¾ç‰‡é¢„è§ˆ</h3>
            <div class="preview-container" id="previewContainer">
                <img id="previewImage" class="preview-image" alt="é¢„è§ˆå›¾">
            </div>
        </div>

        <!-- ä¸­é—´é¢æ¿ï¼šæ“ä½œæŒ‰é’® -->
        <div class="center-panel">
            <div>
                <h3>æ“ä½œåŒºåŸŸ</h3>
                <div class="controls" id="controls" style="display:none;">
                    <button class="identify-btn" id="identifyBtn">è¯†åˆ«å‘ç¥¨ä¿¡æ¯</button>
                    <div class="checkbox-container">
                        <label class="checkbox-label-2">
                            <input type="checkbox" id="needItemsCheckbox" class="checkbox-input">
                            <span class="checkbox-text">å‘ç¥¨è¡Œæ•°æå–</span>
                        </label>
                    </div>
                    <button class="clear-btn" id="clearBtn">æ¸…é™¤</button>
                </div>

                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <p>æ­£åœ¨è¯†åˆ«å‘ç¥¨ä¿¡æ¯ï¼Œè¯·ç¨å€™...</p>
                </div>
            </div>
        </div>

        <!-- å³ä¾§é¢æ¿ï¼šè¯†åˆ«ç»“æœ -->
        <div class="right-panel">
            <div>
                <h3>è¯†åˆ«ç»“æœ</h3>
                <div class="result-container" id="resultContainer">
                    <div id="resultContent" class="result-content"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const controls = document.getElementById('controls');
        const identifyBtn = document.getElementById('identifyBtn');
        const clearBtn = document.getElementById('clearBtn');
        const loading = document.getElementById('loading');
        const resultContainer = document.getElementById('resultContainer');
        const resultContent = document.getElementById('resultContent');

        // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        fileInput.addEventListener('change', handleFileSelect);

        // æ‹–æ‹½äº‹ä»¶
        uploadArea.addEventListener('dragover', function (e) {
            e.preventDefault();
            uploadArea.classList.add('highlight');
        });

        uploadArea.addEventListener('dragleave', function (e) {
            e.preventDefault();
            uploadArea.classList.remove('highlight');
        });

        uploadArea.addEventListener('drop', function (e) {
            e.preventDefault();
            uploadArea.classList.remove('highlight');
            if (e.dataTransfer.files.length > 0) {
                handleFiles(e.dataTransfer.files);
            }
        });

        // ç²˜è´´äº‹ä»¶
        document.addEventListener('paste', function (e) {
            if (e.clipboardData && e.clipboardData.items) {
                let items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        let blob = items[i].getAsFile();
                        handleFiles([blob]);
                        break;
                    }
                }
            }
        });

        // æ¸…é™¤æŒ‰é’®
        clearBtn.addEventListener('click', function () {
            fileInput.value = '';
            previewContainer.style.display = 'none';
            controls.style.display = 'none';
            resultContainer.style.display = 'none';
            uploadArea.classList.remove('highlight');
        });

        // è¯†åˆ«æŒ‰é’®
        identifyBtn.addEventListener('click', identifyInvoice);

        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                handleFiles(e.target.files);
            }
        }

        function handleFiles(files) {
            const file = files[0];
            if (!file.type.match('image.*')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
                return;
            }

            // è®¾ç½®fileInputçš„fileså±æ€§ï¼Œä»¥ä¾¿è¯†åˆ«æŒ‰é’®å¯ä»¥è®¿é—®
            if (fileInput.files !== files) {
                // åˆ›å»ºä¸€ä¸ªæ–°çš„FileListå¯¹è±¡
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                previewImage.src = e.target.result;
                previewContainer.style.display = 'block';
                controls.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        async function identifyInvoice() {
            if (!fileInput.files[0]) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡ï¼');
                return;
            }

            loading.style.display = 'block';
            resultContainer.style.display = 'none';

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('msg', 'è¯·å°†å‘ç¥¨å›¾ç‰‡å†…å®¹è¿›è¡Œè¯†åˆ«ï¼Œå¹¶è¿”å›ç»“æ„åŒ–çš„å‘ç¥¨ä¿¡æ¯');
            // æ–°å¢å‚æ•°ï¼šneedItems
            const needItemsCheckbox = document.getElementById('needItemsCheckbox');
            formData.append('needItems', needItemsCheckbox.checked);


            try {
                const response = await fetch('/extractInvoice', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.text();

                // å°è¯•è§£æJSONå¹¶æ ¼å¼åŒ–æ˜¾ç¤º
                try {
                    const jsonData = JSON.parse(result);
                    resultContent.innerHTML = formatInvoiceData(jsonData);
                } catch (e) {
                    // å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„JSONï¼Œåˆ™ç›´æ¥æ˜¾ç¤ºåŸå§‹æ–‡æœ¬
                    resultContent.textContent = result;
                }

                resultContainer.style.display = 'block';
            } catch (error) {
                console.error('è¯†åˆ«å¤±è´¥:', error);
                resultContent.textContent = 'è¯†åˆ«å¤±è´¥: ' + error.message;
                resultContainer.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }
    });

    // æ ¼å¼åŒ–å‘ç¥¨æ•°æ®çš„å‡½æ•°
    function formatInvoiceData(data) {
        if (typeof data !== 'object') {
            return '<p>æ— æ³•è§£æçš„æ•°æ®æ ¼å¼</p>';
        }

        let html = '<div class="formatted-result">';

        // å¦‚æœæ˜¯æ•°ç»„ï¼Œéå†æ¯ä¸ªé¡¹ç›®
        if (Array.isArray(data)) {
            html += '<h3>å‘ç¥¨åˆ—è¡¨</h3>';
            data.forEach((item, index) => {
                html += `<div class="invoice-item"><h4>å‘ç¥¨ ${index + 1}</h4>` + formatSingleInvoice(item) + '</div>';
            });
        } else {
            // å•ä¸ªå‘ç¥¨å¯¹è±¡
            html += formatSingleInvoice(data);
        }

        html += '</div>';
        return html;
    }

    function formatSingleInvoice(invoice) {
        if (typeof invoice !== 'object') return '';

        let html = '<table class="invoice-table" style="width: 100%; border-collapse: collapse; margin: 10px 0;">';

        for (const [key, value] of Object.entries(invoice)) {
            html += '<tr style="border-bottom: 1px solid #eee;">' +
                `<td style="padding: 8px; text-align: left; font-weight: bold; width: 30%; background-color: #f8f9fa;">
` +
                `${formatKey(key)}</td>
` +
                `<td style="padding: 8px; text-align: left; width: 70%;">
` +
                `${formatValue(value)}</td></tr>`;
        }

        html += '</table>';
        return html;
    }

    function formatKey(key) {
        const keyMap = {
            'invoiceType': 'å‘ç¥¨ç±»å‹',
            'invoiceCode': 'å‘ç¥¨ä»£ç ',
            'invoiceNumber': 'å‘ç¥¨å·ç ',
            'invoiceDate': 'å¼€ç¥¨æ—¥æœŸ',
            'checkCode': 'æ ¡éªŒç ',
            'machineNumber': 'æœºå™¨ç¼–å·',
            'purchaserName': 'è´­ä¹°æ–¹åç§°',
            'purchaserTaxNumber': 'è´­ä¹°æ–¹ç¨å·',
            'purchaserAddressPhone': 'è´­ä¹°æ–¹åœ°å€ç”µè¯',
            'purchaserBankAccount': 'è´­ä¹°æ–¹å¼€æˆ·è¡ŒåŠè´¦å·',
            'sellerName': 'é”€å”®æ–¹åç§°',
            'sellerTaxNumber': 'é”€å”®æ–¹ç¨å·',
            'sellerAddressPhone': 'é”€å”®æ–¹åœ°å€ç”µè¯',
            'sellerBankAccount': 'é”€å”®æ–¹å¼€æˆ·è¡ŒåŠè´¦å·',
            'totalAmountInWords': 'åˆè®¡é‡‘é¢å¤§å†™',
            'totalAmountInFigures': 'åˆè®¡é‡‘é¢å°å†™',
            'taxTotalAmountInWords': 'ä»·ç¨åˆè®¡å¤§å†™',
            'taxTotalAmountInFigures': 'ä»·ç¨åˆè®¡å°å†™',
            'remark': 'å¤‡æ³¨',
            'cashier': 'æ”¶æ¬¾äºº',
            'reviewer': 'å¤æ ¸',
            'checker': 'å¼€ç¥¨äºº',
            'goodsList': 'è´§ç‰©æˆ–åº”ç¨åŠ³åŠ¡æ¸…å•',
            'amount': 'é‡‘é¢',
            'taxRate': 'ç¨ç‡',
            'taxAmount': 'ç¨é¢'
        };

        return keyMap[key] || key.charAt(0).toUpperCase() + key.slice(1);
    }

    function formatValue(value) {
        if (value === null || value === undefined) {
            return '<span style="color: #999; font-style: italic;">æ— æ•°æ®</span>';
        }

        if (typeof value === 'object') {
            if (Array.isArray(value)) {
                if (value.length === 0) return 'æ— æ•°æ®';

                let listHtml = '<div style="margin: 5px 0;">';
                value.forEach((item, index) => {
                    if (typeof item === 'object') {
                        listHtml += `<div style="border: 1px solid #eee; margin: 5px 0; padding: 8px; border-radius: 4px;"><strong>é¡¹ç›® ${index + 1}:</strong>`;
                        for (const [k, v] of Object.entries(item)) {
                            listHtml += `<div style="margin-left: 10px;"><strong>${formatKey(k)}:</strong> ${formatValue(v)}</div>`;
                        }
                        listHtml += '</div>';
                    } else {
                        listHtml += `<div>${index + 1}. ${formatValue(item)}</div>`;
                    }
                });
                listHtml += '</div>';
                return listHtml;
            } else {
                // åµŒå¥—å¯¹è±¡é€’å½’å¤„ç†
                let objHtml = '<div style="margin: 5px 0; padding: 8px; border-left: 3px solid #007bff;">';
                for (const [k, v] of Object.entries(value)) {
                    objHtml += `<div><strong>${formatKey(k)}:</strong> ${formatValue(v)}</div>`;
                }
                objHtml += '</div>';
                return objHtml;
            }
        }

        return String(value);
    }
</script>
</body>
</html>
```

å®é™…ä½“éªŒå¦‚ä¸‹

![](/imgs/column/springai/D03-03.webp)


åˆ°è¿™é‡Œï¼Œå‘ç¥¨æå–çš„æ ¸å¿ƒæœåŠ¡å±‚å·²åŸºæœ¬æ»¡è¶³è¦æ±‚ï¼Œå…³äºå­˜å‚¨å±‚çš„ç¼“å­˜å’ŒæŒä¹…åŒ–ï¼Œç›¸å¯¹æ¥è¯´å±äºå¸¸è§çš„åç«¯å®ç°æŠ€æœ¯æ ˆï¼Œå°±ä¸è¯¦ç»†å±•å¼€äº†ï¼› é‚£ä¹ˆè¿™ä¸ªå®ç°æ˜¯å¦å¯ä»¥ç›´æ¥åº”ç”¨äºç”Ÿäº§ä½¿ç”¨å‘¢ï¼Ÿ

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹è‹¥ç”¨äºç”Ÿäº§ï¼Œè¿˜éœ€è¦åšå“ªäº›ä¼˜åŒ–


## äº”ã€ç”Ÿäº§ä¼˜åŒ–

### 5.1 å‘ç¥¨è¡Œæ•°æ®è¶…è¿‡å¤§æ¨¡å‹ä¸Šä¸‹æ–‡çª—å£

#### 5.1.1 é—®é¢˜æè¿°

å‘ç¥¨ä¸Šçš„åŸºæœ¬ç¥¨é¢ä¿¡æ¯æ•°æ®é‡è¿˜ç®—å¯æ§ï¼Œä½†æ˜¯å¼€ç¥¨è¡Œï¼ˆå³å•†å“ã€æœåŠ¡æ˜ç»†ï¼‰è¿™é‡Œå¯èƒ½å°±éå¸¸å¤šäº†ï¼Œæ¯”å¦‚æˆ‘ä¸€å•ä¹°äº†äº”å…­åä¸ªå•†å“ã€è€Œè¿™äº›å•†å“å…¨éƒ¨æ”¾åœ¨ä¸€å¼ å‘ç¥¨ä¸Šï¼Œå½“æˆ‘ä»¬æå–å‘ç¥¨ä¿¡æ¯æ—¶ï¼Œä¼šå‘ç°å¤§æ¨¡å‹æ— æ³•è¿”å›å®Œæ•´çš„æ•°æ®ç»“æ„ï¼ˆè¶…å‡ºå†…å®¹è¢«æˆªæ–­äº†â€”â€”â€”â€”å³ä¾¿æˆ‘çš„æç¤ºè¯æ˜ç¡®è¦æ±‚äº†ï¼Œä¸è¦æˆªæ–­ä¹Ÿæ²¡æœ‰æ•ˆæœï¼‰

å¦‚ä½¿ç”¨`GLM-4V-Flash` å¯¹ä¸€å¼ æœ‰åä¸ªå¼€ç¥¨è¡Œçš„å‘ç¥¨è¿›è¡Œæå–æ—¶ï¼š

![](/imgs/column/springai/D03-04.webp)

ä¸Šé¢çš„ç¤ºä¾‹è¾“å‡ºä¸­ï¼Œä»å¤§æ¨¡å‹çš„è¿”å›ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œè¿”å›ç»“æœè¢«æˆªæ–­äº†ï¼Œå¯¼è‡´è¿”å›çš„æ˜¯ä¸€ä¸ªä¸å®Œæ•´çš„æ•°æ®ç»“æ„ï¼Œå› æ­¤åœ¨ç»“æ„åŒ–ä¸ºjava beanå¯¹è±¡æ—¶ï¼Œå°±æŠ¥é”™äº†

é‚£ä¹ˆæ€ä¹ˆè§£å†³å‘¢ï¼Ÿ

> æ¢ä¸Šä¸‹æ–‡çª—å£æ›´å¤§çš„æ¨¡å‹ï¼Œæ¯”å¦‚ `GLM-4.1V-Thinking-Flash` ?

è¿™å½“ç„¶æ˜¯ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯å¹¶ä¸å½»åº•ï¼Œå› ä¸ºå¤§æ¨¡å‹çš„ä¸Šä¸‹æ–‡çª—å£æ˜¯æœ‰é™çš„ï¼Œä½†æ˜¯å‘ç¥¨è¡Œå´æ˜¯ä¸å›ºå®šçš„ï¼›ç®€å•æ¥è¯´ï¼Œæˆ‘æ²¡æ³•ä¿è¯ï¼Œæ¢ä¸€ä¸ªæ¨¡å‹ä¹‹åï¼Œå°±ä¸ä¼šå†å‡ºç°è¿”å›ç»“æœè¢«æˆªæ–­çš„æƒ…å†µäº†

é‚£ä¹ˆæœ‰æ²¡æœ‰æ›´å½»åº•çš„è§£å†³æ–¹æ¡ˆå‘¢ï¼Ÿ

> åˆ†åŒºåŸŸã€åˆ†é¡µæå–

æ€ä¹ˆç†è§£è¿™ä¸ªè§£å†³æ–¹æ¡ˆå‘¢ï¼Ÿ

æˆ‘ä»¬å¯ä»¥å¥—ç”¨ä¸€ä¸‹ä¼ ç»Ÿçš„å¼€å‘æ¨¡å¼ï¼Œå½“ä¸€æ¬¡è¿”å›çš„æ•°æ®å¤ªå¤šæ—¶ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°çš„è§£å†³æ–¹æ³•æ—¶å°†ä¸€æ¬¡çš„è¿”å›

- æ”¹ä¸ºåˆ†é¡µè¿”å›ï¼Œä¸€æ¬¡è¿”å›20æ¡ï¼Œè‹¥ä½ éœ€è¦å†è¿”å›å20æ¡ â€”â€”â€”â€” è¿™ç§é€‚ç”¨äºåˆ—è¡¨çš„è¿”å›æ–¹å¼

å‚ç…§è¿™ç§æ€è·¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å…ˆå®šå¤§æ¨¡å‹ï¼Œä¸è¦ä¸€æ¬¡æå–æ‰€æœ‰çš„å¼€ç¥¨è¡Œä¿¡æ¯ï¼Œè€Œæ˜¯æŒ‰ç…§æˆ‘ç»™ä»–è¦æ±‚çš„è¿›è¡Œåˆ†é¡µæå–ï¼›å¼€ç¥¨è¡Œçš„ä¿¡æ¯æ”¹æˆåˆ†é¡µæå–ä¹‹åï¼Œä½†æ˜¯å…¶ä»–çš„ç¥¨é¢ä¿¡æ¯å®é™…ä¸Šåªéœ€è¦æå–ä¸€æ¬¡ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†ä¸€æ¬¡çš„æå–è¿‡ç¨‹ï¼Œæ”¹ä¸º

- åªæå–ç¥¨é¢ä¿¡æ¯
- åˆ†é¡µæå–å¼€ç¥¨è¡Œä¿¡æ¯

#### 5.1.2 ç¥¨é¢åŸºæœ¬ä¿¡æ¯æå–

æŒ‰ç…§è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥é‡æ–°è®¾è®¡ä¸¤ä¸ªæç¤ºè¯ï¼Œåªæå–å¼€ç¥¨ä¿¡æ¯çš„æç¤ºè¯ `prompts/invoice-basic-extract.st`

```tl
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å‘ç¥¨ä¿¡æ¯æå–ä¸“å®¶ã€‚è¯·ä»ç”¨æˆ·æä¾›çš„å‘ç¥¨å›¾ç‰‡ä¸­æå–å®Œæ•´çš„ç»“æ„åŒ–ä¿¡æ¯ã€‚

å¿…é¡»éµå¾ªï¼š
1. å‡†ç¡®è¯†åˆ«å‘ç¥¨ç±»å‹ï¼ˆå¢å€¼ç¨ä¸“ç”¨å‘ç¥¨ã€å¢å€¼ç¨æ™®é€šå‘ç¥¨ã€ç”µå­æ™®é€šå‘ç¥¨ç­‰ï¼‰
2. æå–æ‰€æœ‰å…³é”®å­—æ®µï¼šå‘ç¥¨ä»£ç ã€å‘ç¥¨å·ç ã€å¼€ç¥¨æ—¥æœŸã€æ ¡éªŒç ç­‰
3. è¯†åˆ«è´­é”€åŒæ–¹å®Œæ•´ä¿¡æ¯ï¼ˆåç§°ã€çº³ç¨äººè¯†åˆ«å·ã€åœ°å€ç”µè¯ã€å¼€æˆ·è¡ŒåŠè´¦å·ï¼‰
4. è¯†åˆ«å¤‡æ³¨ã€æ”¶æ¬¾äººã€å¤æ ¸äººã€å¼€ç¥¨äººç­‰ä¿¡æ¯
5. å¯¹äºæ¨¡ç³Šæˆ–ä¸æ¸…æ™°æˆ–æ— æ³•è¯†åˆ«çš„å­—æ®µï¼Œè¯·ä½¿ç”¨nullå€¼ã€‚
6. è¯·ç¡®ä¿æ‰€æœ‰é‡‘é¢å­—æ®µä¸ºæ•°å­—ç±»å‹ï¼Œæ—¥æœŸä¸ºå­—ç¬¦ä¸²æ ¼å¼ã€‚
7. è¯·åŠ¡å¿…è¿”å›å®Œæ•´å†…å®¹ï¼Œä¸è¦æˆªæ–­JSONã€‚

è¾“å‡ºæ ¼å¼è¦æ±‚ï¼š
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼Œä¸è¦åŒ…å«ä»»ä½•é¢å¤–æ–‡æœ¬ï¼š
```

å¯¹åº”çš„å®ç°é€»è¾‘ä¹Ÿæ¯”è¾ƒç®€å•äº†ï¼Œå› ä¸ºæˆ‘ä»¬è¿”å›ä¸è¦å¼€ç¥¨è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†å‰é¢å®šä¹‰çš„æ•°æ®ç»“æ„ `InvoiceInfo` è¿›è¡Œæ”¹é€ ï¼Œå‘ä¸Šæå–ä¸€å±‚`BaseInvoiceInfo`åŸºç¡€ç±»ï¼Œç›¸æ¯”äºä¹‹å‰çš„å®ç°ï¼Œè¿™ä¸ªåŸºç¡€ç±»ä¸­ï¼Œä¸åŒ…å«`List<InvoiceItem> items`

```java
@Data
@JsonClassDescription(value = "å‘ç¥¨åŸºæœ¬ä¿¡æ¯ï¼Œä¸åŒ…å«å•†å“è¡Œä¿¡æ¯")
public class BaseInvoiceInfo {
  // ...çœç•¥
}

@Data
@JsonClassDescription(value = "å‘ç¥¨å®Œæ•´ä¿¡æ¯")
public class InvoiceInfo extends BaseInvoiceInfo {
    @JsonPropertyDescription(value = "å•†å“/æœåŠ¡æ˜ç»†åˆ—è¡¨")
    private List<InvoiceItem> items;
}
```

ç„¶åå‚ç…§ä¸Šé¢çš„å‘ç¥¨æå–æ–¹æ¡ˆï¼Œå®ç°å¯¹åº”çš„å‘ç¥¨åŸºæœ¬ä¿¡æ¯æå–æ ¸å¿ƒé€»è¾‘

```java
@Slf4j
@Service
public class InvoiceExtractionService {
    @Value("classpath:/prompts/invoice-basic-extract.st")
    private Resource baseInvoiceSystemPrompt;


    /**
     * è¯†åˆ«å‘ç¥¨åŸºç¡€å†…å®¹ï¼ˆä¸åŒ…å«å•†å“æ˜ç»†ï¼‰
     *
     * @param imageBytes å›¾ç‰‡å­—èŠ‚
     * @param mimeType   å›¾ç‰‡ç±»å‹
     * @param msg        è¯†åˆ«æç¤ºä¿¡æ¯
     * @return
     */
    public BaseInvoiceInfo extractBaseInvoice(byte[] imageBytes, MimeType mimeType, String msg) {
        Message systemMsg = new SystemMessage(baseInvoiceSystemPrompt);
        String message = (msg != null && !msg.isEmpty()) ? msg : "è¯·å°†å‘ç¥¨å›¾ç‰‡å†…å®¹è¿›è¡Œè¯†åˆ«ï¼Œå¹¶è¿”å›ç»“æ„åŒ–çš„å‘ç¥¨ä¿¡æ¯";

        Media media = Media.builder()
                .mimeType(mimeType)
                .data(imageBytes)
                .build();
        Message userMsg = UserMessage.builder().text(message).media(media).build();
        Prompt prompt = new Prompt(List.of(systemMsg, userMsg));
        BaseInvoiceInfo invoiceInfo = chatClient.prompt(prompt).call().entity(BaseInvoiceInfo.class);
        log.info("è§£æçš„ç»“æœ: \n{}", toStr(invoiceInfo));
        return invoiceInfo;
    }
}
```

#### 5.1.3 åˆ†é¡µæå–å‘ç¥¨è¡Œ

åˆ†é¡µæå–å¼€ç¥¨è¡Œçš„æç¤ºè¯ `prompts/invoice-items-extract.st`

```tl
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å‘ç¥¨ä¿¡æ¯æå–ä¸“å®¶ã€‚è¯·ä»å‘ç¥¨å›¾ç‰‡ä¸­æå–å•†å“æ˜ç»†çš„ç¬¬$start$è¡Œåˆ°ç¬¬$end$è¡Œã€‚

æå–è¦æ±‚ï¼š
1. åªæå–æŒ‡å®šè¡Œæ•°èŒƒå›´çš„å•†å“æ˜ç»†
2. æ¯è¡Œéœ€è¦æå–ä»¥ä¸‹å­—æ®µï¼š
   - å•†å“åç§°
   - è§„æ ¼å‹å·ï¼ˆå¦‚æœ‰ï¼‰
   - å•ä½
   - æ•°é‡
   - å•ä»·
   - é‡‘é¢
   - ç¨ç‡
   - ç¨é¢
   - ä»·ç¨åˆè®¡

3. å¦‚æœæŒ‡å®šèŒƒå›´å†…æ²¡æœ‰è¶³å¤Ÿçš„è¡Œæ•°ï¼Œæå–å®é™…å­˜åœ¨çš„è¡Œæ•°
4. å¦‚æœæ— æ³•è¯†åˆ«æŸè¡Œï¼Œåˆ™è¿™ä¸€è¡Œè¿”å›ä¸€ä¸ªç©ºå¯¹è±¡è¿›è¡Œå ä½ï¼Œå§‹ç»ˆä¿è¯è¿”å›çš„è¡Œæ•°ä¸å®é™…çš„ä¸€è‡´

å§‹ç»ˆéµå¾ªä»¥ä¸‹è§„åˆ™ï¼š
- ä¸¥æ ¼æŒ‰ç…§ä»ä¸Šåˆ°ä¸‹çš„é¡ºåºè®¡æ•°ï¼Œå¹¶ä¸”æŒ‰ç…§é¡ºåºæå–ï¼Œä»ç¬¬0è¡Œå¼€å§‹è®¡æ•°
- åªæå–ç¬¬$start$è¡Œåˆ°ç¬¬$end$è¡Œå†…å®¹ï¼Œå¿…é¡»åŒ…å«ç¬¬$start$è¡Œï¼Œä¸åŒ…å«ç¬¬$end$è¡Œï¼Œä¸è¦æå–å…¶ä»–è¡Œçš„å†…å®¹

è¾“å‡ºæ ¼å¼è¦æ±‚ï¼š
è¯·è¿”å›JSONæ•°ç»„æ ¼å¼ï¼Œæ¯ä¸ªå…ƒç´ ä»£è¡¨ä¸€è¡Œï¼š
[
  {
    "rowNumber": 1,
    "itemName": "å•†å“åç§°",
    "specification": "è§„æ ¼å‹å·",
    "unit": "å•ä½",
    "quantity": 1.0,
    "unitPrice": 1000.00,
    "amount": 1000.00,
    "taxRate": 0.13,
    "taxAmount": 130.00,
    "totalAmount": 1130.00,
    "confidence": 0.95
  },
]

å¦‚æœæå–å¤±è´¥æˆ–æ²¡æœ‰æ‰¾åˆ°æŒ‡å®šè¡Œï¼Œè¿”å›ç©ºæ•°ç»„ []ã€‚
```

> æ³¨æ„ä¸Šé¢çš„æç¤ºè¯ï¼Œå› ä¸ºè¿”å›æç¤ºè¯æ¨¡æ¿ä¸­ï¼Œæä¾›äº†`json`ç¤ºä¾‹ï¼Œå¦‚æœæ­¤æ—¶æˆ‘ä»¬ä¾ç„¶ä½¿ç”¨é»˜è®¤çš„ `{}` æ¥è¡¨ç¤ºæ¨¡æ¿å˜é‡ï¼Œå°±ä¼šå¯¼è‡´è§£æå¼‚å¸¸ (SpringAIçš„æç¤ºè¯æ¨¡æ¿è§£æå™¨ä¼šå°†jsonæ ·ä¾‹ä¸­{}ä¹Ÿè®¤ä¸ºéœ€è¦è¿›è¡Œå˜é‡æ›¿æ¢)ï¼Œä¸ºäº†é¿å…è¿™ç§é—®é¢˜ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨è‡ªå®šä¹‰çš„ `$$` æ¥åŒ…è£¹æ¨¡æ¿å˜é‡

ä¸€ä¸ªåŸºç¡€çš„åˆ†é¡µæå–å‘ç¥¨è¡Œå®ç°å¦‚

```java
@Slf4j
@Service
public class InvoiceExtractionService {
    @Value("classpath:/prompts/invoice-items-extract.st")
    private Resource invoiceItemPrompt;

    private List<InvoiceItem> extractInvoiceItems(Media media, Integer start, Integer end) {
        PromptTemplate promptTemplate = PromptTemplate.builder()
                // å› ä¸ºæç¤ºè¯ä¸­è¿”å›çš„jsonå¯¹è±¡ä¸­ï¼Œæœ‰ {}ï¼Œæ‰€ä»¥ä½¿ç”¨é»˜è®¤çš„ {} æ¥æ›¿æ¢å ä½å˜é‡ï¼Œä¼šæŠ¥é”™
                .renderer(StTemplateRenderer.builder().startDelimiterToken('$').endDelimiterToken('$').build())
                .resource(invoiceItemPrompt)
                .build();
        String sys = promptTemplate.render(Map.of("start", start, "end", end));
        SystemMessage systemMsg = new SystemMessage(sys);

        UserMessage userMsg = UserMessage.builder().media(media).text("æå–" + start + "è¡Œåˆ°" + end + "è¡Œå‘ç¥¨å•†å“ä¿¡æ¯ï¼Œæ³¨æ„ä¸åŒ…å«ç¬¬" + end + "è¡Œ").build();
        Prompt prompt = new Prompt(List.of(systemMsg, userMsg));
        List<InvoiceItem> items = chatClient.prompt(prompt).call().entity(new ParameterizedTypeReference<List<InvoiceItem>>() {
        });
        return items;
    }
}
```

#### 5.1.4 å®Œæ•´çš„å¤§å‘ç¥¨æå–

ç„¶åå°±æ˜¯æä¾›ä¸€ä¸ªå¤–éƒ¨çš„è®¿é—®å…¥å£ï¼Œç›´æ¥åŸºäºä¸Šé¢çš„ä¸¤ä¸ªåŸºç¡€å®ç°ï¼Œæ¥è·å–å¤§å‘ç¥¨çš„å®Œæ•´ä¿¡æ¯æå–

```java
/**
 * è¯†åˆ«å‘ç¥¨ä¸­å•†å“è¡Œè¾ƒå¤šçš„å‘ç¥¨å†…å®¹
 * <p>
 * - å›¾ç‰‡ä¸­çš„ä¿¡æ¯ï¼Œè¶…è¿‡çª—å£ä¸Šä¸‹æ–‡çš„åœºæ™¯ï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œåˆ†æ‰¹å¤„ç†
 *
 * @param imageBytes å›¾ç‰‡å­—èŠ‚
 * @param mimeType   å›¾ç‰‡ç±»å‹
 * @param msg        è¯†åˆ«æç¤ºä¿¡æ¯
 * @return
 */
public InvoiceInfo extractInvoiceWitInhItems(byte[] imageBytes, MimeType mimeType, String msg) {
    Media media = Media.builder()
            .mimeType(mimeType)
            .data(imageBytes)
            .build();
    // æå–å‘ç¥¨åŸºæœ¬ä¿¡æ¯
    CompletableFuture<BaseInvoiceInfo> infoFuture = CompletableFuture.supplyAsync(() -> {
        BaseInvoiceInfo invoiceInfo = extractBaseInvoice(imageBytes, mimeType, msg);
        return invoiceInfo;
    });

    // åˆ†é¡µæå–å‘ç¥¨è¡Œ
    CompletableFuture<List<InvoiceItem>> itemFuture = CompletableFuture.supplyAsync(() -> {
        final int step = 5;
        int start = 0, end = step;
        List<InvoiceItem> totalItems = new ArrayList<>();
        while (true) {
            log.info("å¼€å§‹å¤„ç†ï¼š{} - {}", start, end);
            List<InvoiceItem> items = extractInvoiceItems(media, start, end);
            if (CollectionUtils.isEmpty(items)) {
                break;
            }
            totalItems.addAll(items);
            if (items.size() < end - start) {
                break;
            } else {
                start += step;
                end += step;
            }
        }
        return totalItems;
    });

    // ç­‰å¾…ä¸¤ä¸ªä»»åŠ¡å®Œæˆ
    CompletableFuture.allOf(infoFuture, itemFuture).join();

    // æ„å»ºå®Œæ•´çš„è¿”å›ç»“æœ
    InvoiceInfo invoiceInfo = new InvoiceInfo();
    try {
        BeanUtils.copyProperties(infoFuture.get(), invoiceInfo);
        invoiceInfo.setItems(itemFuture.get());
    } catch (Exception e) {
        throw new RuntimeException(e);
    }
    return invoiceInfo;
}
```

æˆ‘ä»¬ä½¿ç”¨ä¸Šä¸‹æ–‡çª—å£æ›´å°ã€å“åº”æ›´å¿«çš„ `GLM-4V-Flash` æ¨¡å‹æ¥æ¼”ç¤ºè¿™ä¸ªåˆ†é¡µæå–ï¼Œå¦‚ä½¿ç”¨é¡¹ç›®ä¸­çš„`test/resources/pupiao.jpg`ä¸ºä¾‹ï¼Œå³ä¾¿è¿™ä¸ªå‘ç¥¨ä¸­æœ‰åè¡Œï¼Œä¹Ÿå¯ä»¥ä¸€å¹¶è¾“å‡º

![](/imgs/column/springai/D03-05.webp)

#### 5.1.5 æ–¹æ¡ˆä¼˜åŒ–

è™½ç„¶å®ç°äº†åˆ†é¡µçš„å¼€ç¥¨è¡Œä¿¡æ¯æå–ï¼Œä½†æ˜¯è¿™ä¸ªå®ç°æ˜¯ä¸€ä¸ªæ˜æ˜¾çš„ä¸²è¡ŒåŒ–æ–¹æ¡ˆï¼›å¯¹åº”çš„å½“å¼€ç¥¨è¡Œæ•°æ®è¶Šå¤šï¼Œæ•´ä¸ªæœåŠ¡çš„è€—æ—¶å°±ä¼šè¶Šå¤§

è‡ªç„¶ï¼Œæˆ‘ä»¬å°±ä¼šæœ‰ä¸€ä¸ªæ”¹è¿›æ–¹æ¡ˆï¼Œåœ¨è¿”å›å‘ç¥¨åŸºæœ¬ä¿¡æ¯çš„åŒæ—¶ï¼Œè¿”å›æ€»çš„å¼€ç¥¨è¡Œæ•°ï¼Œç„¶åå°±å¯ä»¥åŸºäºè¿™ä¸ªæ€»æ•°æ¥è®¡ç®—åˆ†é¡µï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡å¹¶è¡Œçš„æ–¹æ¡ˆï¼Œå®ç°åˆ†é¡µå¼€ç¥¨è¡Œæå–ï¼Œä¸€ä¸ªå¯è¡Œçš„å®ç°æµç¨‹å›¾å¦‚ä¸‹

![](/imgs/column/springai/D03-06.png)


```java
flowchart TB
    %% å…¨å±€æ ·å¼é…ç½®ï¼šä¸“ä¸šç®€æ´ï¼Œé€‚é…æŠ€æœ¯äººå‘˜é˜…è¯»
    classDef base font-size:11px, rounded:8, stroke-width:1.5
    classDef parallel fill:#e6f4ff,stroke:#1976d2,opacity:0.9
    classDef judge fill:#fff3e0,stroke:#f57c00
    classDef process fill:#e8f5e8,stroke:#2e7d32
    classDef state fill:#f3e5f5,stroke:#7b1fa2

    %% èµ·å§‹èŠ‚ç‚¹
    Start[å¼€å§‹]
    GlobalState["åˆå§‹åŒ–å…¨å±€çŠ¶æ€<br/>ï¼ˆè®°å½•å¼€ç¥¨é¡µæå–çŠ¶æ€ï¼‰"]
    
    %% å¹¶è¡Œæ‰§è¡Œå—
    subgraph "å¹¶è¡Œæ‰§è¡Œä»»åŠ¡"
        style å¹¶è¡Œæ‰§è¡Œä»»åŠ¡ fill:#f8f9fa,stroke:#616161,stroke-width:2
        A["ä»»åŠ¡Aï¼šæå–å‘ç¥¨åŸºæœ¬ä¿¡æ¯<br/>ï¼ˆåŒ…å«æ€»å¼€ç¥¨è¡Œæ•°ï¼‰"]
        B["ä»»åŠ¡Bï¼šæå–ç¬¬ä¸€é¡µå¼€ç¥¨è¡Œ<br/>ï¼ˆè®°å½•ç¬¬ä¸€é¡µå·²æå–ï¼‰"]
    end
    
    %% æ¡ä»¶åˆ¤æ–­ä¸å¤„ç†èŠ‚ç‚¹
    JudgeA["åˆ¤æ–­ï¼šä»»åŠ¡Aæ˜¯å¦è¿”å›ï¼Ÿ"]
    CalcPage["è®¡ç®—åˆ†é¡µæ•°<br/>ï¼ˆåŸºäºæ€»å¼€ç¥¨è¡Œæ•°ï¼‰"]
    PrepareParallel["å‡†å¤‡å¹¶è¡Œæå–æ¯ä¸€é¡µå¼€ç¥¨è¡Œ"]
    CheckGlobal["åˆ¤æ–­å…¨å±€çŠ¶æ€ï¼š<br/>å½“å‰é¡µæ˜¯å¦å·²æå–ï¼Ÿ"]
    Skip["è·³è¿‡å½“å‰é¡µæå–"]
    RecordState["è®°å½•å…¨å±€çŠ¶æ€ï¼š<br/>æ ‡è®°å½“å‰é¡µå¾…æå–"]
    ExtractPage["æ‰§è¡Œæå–å½“å‰é¡µå¼€ç¥¨è¡Œ"]
    
    JudgeB["åˆ¤æ–­ï¼šä»»åŠ¡Bè¿”å›ä¸”Aæœªè¿”å›ï¼Ÿ"]
    JudgeNext["åˆ¤æ–­ï¼šæ˜¯å¦æœ‰ä¸‹ä¸€é¡µæ•°æ®ï¼Ÿ"]
    PrepareNext["å‡†å¤‡æå–ä¸‹ä¸€é¡µå¼€ç¥¨è¡Œ"]
    
    %% æµç¨‹è¿æ¥
    Start --> GlobalState
    GlobalState --> å¹¶è¡Œæ‰§è¡Œä»»åŠ¡
    å¹¶è¡Œæ‰§è¡Œä»»åŠ¡ --> JudgeA
    
    %% ä»»åŠ¡Aè¿”å›åˆ†æ”¯
    JudgeA -- æ˜¯ --> CalcPage
    CalcPage --> PrepareParallel
    PrepareParallel --> CheckGlobal
    
    %% å…¨å±€çŠ¶æ€åˆ¤æ–­åˆ†æ”¯
    CheckGlobal -- å·²æå– --> Skip
    CheckGlobal -- æœªæå– --> RecordState
    RecordState --> ExtractPage
    
    %% ä»»åŠ¡Aæœªè¿”å›ï¼ˆBè¿”å›ï¼‰åˆ†æ”¯
    JudgeA -- å¦ --> JudgeB
    JudgeB -- æ˜¯ --> JudgeNext
    JudgeNext -- æœ‰ --> PrepareNext
    PrepareNext --> CheckGlobal
    JudgeNext -- æ—  --> End
    
    %% æ”¶å°¾èŠ‚ç‚¹
    Skip --> End
    ExtractPage --> End
    End[ç»“æŸ]

    %% æ ·å¼ç»‘å®š
    class A,B parallel
    class JudgeA,JudgeB,JudgeNext,CheckGlobal judge
    class CalcPage,PrepareParallel,ExtractPage,RecordState process
    class GlobalState state
```

è‹¥æ˜¯è§‰å¾—ä¸Šé¢è¿™ä¸ªçœ‹èµ·æ¥æœ‰äº›å¤æ‚çš„è¯ï¼Œä¹Ÿå¯ä»¥çœ‹ä¸‹é¢è¿™ä¸ªç®€ç‰ˆæ–¹æ¡ˆï¼Œæ€è·¯å®é™…ä¸Šæ˜¯ä¸€è‡´çš„

![](/imgs/column/springai/D03-07.png)


```java
flowchart TB
%%{init: { "theme": "base", "themeVariables": { "primaryColor": "#ffffff", "secondaryColor": "#f9f9f9", "tertiaryColor": "#eeeeee", "textColor": "#333", "fontSize": "16px", "subgraph_border_color": "#666", "subgraph_fill": "#e0e0e0" } } }%%
graph TB
    subgraph SA["åˆ†é¡µæå–æµç¨‹"]
        style SA fill:#f0f8fb,stroke:#1976d2,stroke-width:1,opacity:0.5
        Start[å¼€å§‹] --> Step1[ç¬¬ä¸€æ¬¡è°ƒç”¨<br>æå–åŸºæœ¬ä¿¡æ¯]
        Step1 --> Step2{åˆ¤æ–­æ˜ç»†è¡Œæ•°}
        
        Step2 -->|è¡Œæ•°â‰¤é˜ˆå€¼| Step3[å•æ¬¡æå–æ‰€æœ‰æ˜ç»†]
        Step2 -->|è¡Œæ•°>é˜ˆå€¼| Step4[è®¡ç®—åˆ†é¡µæ•°]
        
        Step4 --> Step5[å¹¶è¡Œåˆ†é¡µæå–]
        
        subgraph Step5
            Page1[ç¬¬ä¸€é¡µ: è¡Œ1-5]
            Page2[ç¬¬äºŒé¡µ: è¡Œ6-10]
            PageN[ç¬¬Né¡µ]
        end
        
        Step5 --> Step6[åˆå¹¶åˆ†é¡µç»“æœ]
        Step3 --> Step7[ç»„è£…å®Œæ•´å‘ç¥¨]
        Step6 --> Step7
        
        Step7 --> End[è¿”å›ç»“æœ]
    end
    
    classDef process fill:#e1f5fe,stroke:#01579b
    classDef decision fill:#f3e5f5,stroke:#4a148c
    classDef parallel fill:#c8e6c9,stroke:#2e7d32
    classDef result fill:#fff3e0,stroke:#e65100
    
    class Start,Step1,Step3,Step4,Step6,Step7,End process
    class Step2 decision
    class Step5 parallel
    class Step7,End result
```


> å…·ä½“çš„å®ç°å°±çœç•¥äº†ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è‡ªè¡Œè¡¥å…¨ğŸ¤£


### 5.2 å›¾ç‰‡é¢„å¤„ç†

åœ¨å®é™…çš„ç”Ÿäº§åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬æ²¡åŠæ³•ä¿è¯ç”¨æˆ·ä¸Šä¼ çš„å§‹ç»ˆæ—¶æ•°ç”µå¼€å‡ºæ¥çš„ç”µå­ç¥¨åŸä»¶ï¼Œå¯èƒ½æ˜¯ç»è¿‡æ‰“å°ã€æ‹ç…§ç­‰å„ç§æ“ä½œä¹‹åä¸Šä¼ çš„å›¾ç‰‡ï¼Œæ­¤æ—¶ç›´æ¥æ‹¿æ¥è§£æä¸€èˆ¬æ•ˆæœè¾ƒå·®ï¼Œé€šå¸¸ä¸€ä¸ªå®Œæ•´å¯ç›´æ¥å•†ç”¨çš„å‘ç¥¨è¯†åˆ«ï¼Œå¾ˆå¤§æ¦‚ç‡ä¼šæœ‰ç¬¬ä¸€æ­¥çš„å›¾ç‰‡é¢„å¤„ç†é˜¶æ®µï¼Œå½“ç„¶è¿™ä¸€å—ä¸æ˜¯å¤§æ¨¡å‹æå–çš„å…³é”®ç‚¹ï¼ˆéå¤§æ¨¡å‹çš„å®ç°ä¸­ä¹Ÿä¼šæœ‰è¿™ä¸€æ­¥ï¼‰ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªå¯å‚è€ƒçš„é¢„å¤„ç†æ–¹æ¡ˆ

```java
@Component
@Slf4j
public class ImagePreprocessor {
    
    @Value("${invoice.image.quality.threshold:0.8}")
    private double qualityThreshold;
    
    @Value("${invoice.image.max-size:5242880}")
    private long maxImageSize;
    
    /**
     * å›¾ç‰‡é¢„å¤„ç†æµæ°´çº¿
     */
    public ProcessedImage preprocessImage(MultipartFile imageFile) {
        try {
            // 1. éªŒè¯å›¾ç‰‡
            validateImage(imageFile);
            
            // 2. è¯»å–å›¾ç‰‡
            BufferedImage originalImage = ImageIO.read(imageFile.getInputStream());
            
            // 3. è´¨é‡è¯„ä¼°
            double qualityScore = assessImageQuality(originalImage);
            if (qualityScore < qualityThreshold) {
                log.warn("å›¾ç‰‡è´¨é‡è¾ƒä½: {}", qualityScore);
            }
            
            // 4. å›¾åƒå¢å¼º
            BufferedImage enhancedImage = enhanceImage(originalImage);
            
            // 5. è½¬æ¢ä¸ºBase64
            String base64Image = convertToBase64(enhancedImage);
            
            // 6. ç”Ÿæˆå“ˆå¸Œ
            String imageHash = generateImageHash(originalImage);
            
            return ProcessedImage.builder()
                .originalImage(originalImage)
                .enhancedImage(enhancedImage)
                .base64Image(base64Image)
                .imageHash(imageHash)
                .qualityScore(qualityScore)
                .width(originalImage.getWidth())
                .height(originalImage.getHeight())
                .format(getImageFormat(imageFile))
                .build();
                
        } catch (Exception e) {
            throw new ImageProcessingException("å›¾ç‰‡é¢„å¤„ç†å¤±è´¥", e);
        }
    }
    
    /**
     * å›¾åƒå¢å¼ºï¼šå¯¹æ¯”åº¦å¢å¼ºã€å»å™ªã€æ—‹è½¬æ ¡æ­£
     */
    private BufferedImage enhanceImage(BufferedImage image) {
        // è½¬æ¢ä¸ºç°åº¦å›¾ï¼ˆæé«˜OCRå‡†ç¡®ç‡ï¼‰
        BufferedImage grayImage = convertToGrayscale(image);
        
        // å¯¹æ¯”åº¦å¢å¼º
        BufferedImage contrastImage = enhanceContrast(grayImage);
        
        // é™å™ªå¤„ç†
        BufferedImage denoisedImage = applyDenoising(contrastImage);
        
        // è‡ªåŠ¨æ—‹è½¬æ ¡æ­£ï¼ˆåŸºäºæ–‡æœ¬æ–¹å‘ï¼‰
        BufferedImage rotatedImage = autoRotate(denoisedImage);
        
        return rotatedImage;
    }
    
    /**
     * è‡ªåŠ¨æ—‹è½¬æ ¡æ­£
     */
    private BufferedImage autoRotate(BufferedImage image) {
        try {
            // ä½¿ç”¨Tesseractæ£€æµ‹æ–‡æœ¬æ–¹å‘
            ITesseract tesseract = new Tesseract();
            tesseract.setDatapath("tessdata");
            tesseract.setLanguage("chi_sim+eng");
            
            // è®¾ç½®PSMä¸ºè‡ªåŠ¨æ£€æµ‹æ–¹å‘
            tesseract.setPageSegMode(ITesseract.PageSegMode.PSM_AUTO_OSD);
            
            // è·å–æ–¹å‘ä¿¡æ¯
            int orientation = tesseract.getOrientations(image);
            
            // æ ¹æ®æ–¹å‘è¿›è¡Œæ—‹è½¬
            return rotateImage(image, orientation);
            
        } catch (Exception e) {
            log.warn("è‡ªåŠ¨æ—‹è½¬å¤±è´¥ï¼Œä½¿ç”¨åŸå›¾", e);
            return image;
        }
    }
    
    private double assessImageQuality(BufferedImage image) {
        // 1. æ¸…æ™°åº¦è¯„ä¼°ï¼ˆä½¿ç”¨æ‹‰æ™®æ‹‰æ–¯æ–¹å·®ï¼‰
        double sharpness = calculateSharpness(image);
        
        // 2. äº®åº¦è¯„ä¼°
        double brightness = calculateBrightness(image);
        
        // 3. å¯¹æ¯”åº¦è¯„ä¼°
        double contrast = calculateContrast(image);
        
        // 4. ç»¼åˆè´¨é‡è¯„åˆ†
        double qualityScore = sharpness * 0.4 + brightness * 0.3 + contrast * 0.3;
        
        return Math.min(Math.max(qualityScore, 0), 1);
    }
}
```

### 5.3 Function Callingå®ç°æ•°æ®éªŒè¯

å¯¹äºå¤§æ¨¡å‹çš„è¿”å›ï¼Œæˆ‘ä»¬å¯ä»¥ç»“åˆ Functino Callingçš„æœºåˆ¶ï¼Œæ¥å®ç°æ•°æ®éªŒè¯ï¼Œä»è€Œå®ç° ReAct çš„å¤šè½®äº¤äº’ï¼Œæ¯”å¦‚ä¸€ä¸ªéå¸¸åŸºç¡€çš„å­—æ®µåˆæ³•æ€§æ ¡éªŒå¦‚ä¸‹ï¼š

```java
@Component
public class InvoiceValidationService {
    @Tool(
            name = "validateInvoiceFields",
            description = "éªŒè¯å‘ç¥¨å­—æ®µçš„åˆæ³•æ€§å’Œä¸€è‡´æ€§"
    )
    public ValidationResult validateInvoice(
            @ToolParam(description = "å‘ç¥¨ä»£ç ") String invoiceCode,
            @ToolParam(description = "å‘ç¥¨å·ç ") String invoiceNumber,
            @ToolParam(description = "å¼€ç¥¨æ—¥æœŸ") String issueDate,
            @ToolParam(description = "ä¸å«ç¨é‡‘é¢") BigDecimal amountWithoutTax,
            @ToolParam(description = "ç¨é¢") BigDecimal taxAmount,
            @ToolParam(description = "ä»·ç¨åˆè®¡") BigDecimal totalAmount
    ) {
        ValidationResult result = new ValidationResult();
        List<ValidationError> errors = new ArrayList<>();

        // 1. éªŒè¯å‘ç¥¨ä»£ç æ ¼å¼ï¼ˆ12ä½æ•°å­—ï¼‰
        if (invoiceCode != null && !invoiceCode.matches("\\d{12}")) {
            errors.add(new ValidationError("invoiceCode", "å‘ç¥¨ä»£ç å¿…é¡»æ˜¯12ä½æ•°å­—"));
        }

        // 2. éªŒè¯å‘ç¥¨å·ç æ ¼å¼ï¼ˆ8ä½æ•°å­—ï¼‰
        if (invoiceNumber != null && !invoiceNumber.matches("\\d{8}")) {
            errors.add(new ValidationError("invoiceNumber", "å‘ç¥¨å·ç å¿…é¡»æ˜¯8ä½æ•°å­—"));
        }

        // 3. éªŒè¯æ—¥æœŸæ ¼å¼
        if (issueDate != null) {
            try {
                LocalDate.parse(issueDate);
            } catch (Exception e) {
                errors.add(new ValidationError("issueDate", "å¼€ç¥¨æ—¥æœŸæ ¼å¼é”™è¯¯"));
            }
        }

        // 4. éªŒè¯é‡‘é¢å…³ç³»
        if (amountWithoutTax != null && taxAmount != null && totalAmount != null) {
            BigDecimal calculatedTotal = amountWithoutTax.add(taxAmount);
            BigDecimal diff = totalAmount.subtract(calculatedTotal).abs();

            if (diff.compareTo(new BigDecimal("0.01")) > 0) {
                errors.add(new ValidationError("amounts",
                        String.format("é‡‘é¢è®¡ç®—ä¸ä¸€è‡´: ä¸å«ç¨(%.2f) + ç¨é¢(%.2f) â‰  åˆè®¡(%.2f)",
                                amountWithoutTax, taxAmount, totalAmount)));
            }
        }

        // 5. éªŒè¯çº³ç¨äººè¯†åˆ«å·ï¼ˆ15-20ä½ï¼‰
        // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„éªŒè¯é€»è¾‘

        result.setErrors(errors);
        result.setValid(errors.isEmpty());
        result.setValidationTime(LocalDateTime.now());

        return result;
    }

    @Data
    public static class ValidationResult {
        private boolean valid;
        private List<ValidationError> errors;
        private LocalDateTime validationTime;
    }

    public record ValidationError(String field, String message) {
    }
}
```


é™¤äº†ä¸Šé¢è¿™ä¸ªä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¯¹çº³é”äººè¯†åˆ«å·ã€ä¼ä¸šåç§°è¿›è¡Œåˆæ³•æ€§æ ¡éªŒï¼ˆæ¯”å¦‚é€šè¿‡å†…éƒ¨ç»´æŠ¤çš„æ˜ å°„æˆ–è€…å¤–éƒ¨çš„ä¼æŸ¥æŸ¥ä¹‹ç±»çš„æ¥å£æ¥å®ç°ï¼‰

å½“ç„¶è¿™äº›å±äºè¾…åŠ©æ‰‹æ®µï¼Œä¸åŠ è²Œä¼¼ä¹Ÿæ²¡æœ‰å¤ªå¤§çš„é—®é¢˜ğŸ¤£

### 5.4 é™çº§ç­–ç•¥ï¼šä¼ ç»ŸOCRå¤‡ç”¨æ–¹æ¡ˆ

æœ€ååœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œéš¾å…ä¼šæœ‰ä¸€äº›çªå‘æƒ…å†µï¼Œæ‰€ä»¥ä¸€ä¸ªå¥å£®çš„ç³»ç»Ÿï¼Œå¯¹åº”çš„é™çº§æ–¹æ¡ˆæ˜¯ä¸å¯ç¼ºå°‘çš„ï¼Œæ¯”å¦‚åŠ ä¸€ä¸ªocrçš„å¤‡ç”¨æ–¹æ¡ˆ

```java
@Component
@Slf4j
public class FallbackOCRExtractor {
    
    @Autowired
    private AliYunOCRClient aliYunOCRClient;
    
    @Autowired
    private InvoiceTemplateMatcher templateMatcher;
    
    /**
     * å½“å¤§æ¨¡å‹æå–å¤±è´¥æ—¶çš„é™çº§æ–¹æ¡ˆ
     */
    public InvoiceInfo extractWithOCR(ProcessedImage processedImage) {
        try {
            // 1. è°ƒç”¨é˜¿é‡Œäº‘OCR
            OCRResponse ocrResponse = aliYunOCRClient.analyzeInvoice(
                processedImage.getBase64Image()
            );
            
            // 2. ä½¿ç”¨æ¨¡æ¿åŒ¹é…æå–ç»“æ„åŒ–ä¿¡æ¯
            Map<String, String> extractedFields = templateMatcher.matchAndExtract(
                ocrResponse.getTextBlocks()
            );
            
            // 3. è½¬æ¢ä¸ºInvoiceInfoå¯¹è±¡
            InvoiceInfo invoiceInfo = convertToInvoiceInfo(extractedFields);
            
            // 4. è®¾ç½®è¾ƒä½çš„ç½®ä¿¡åº¦
            invoiceInfo.setConfidence(0.6);
            
            return invoiceInfo;
            
        } catch (Exception e) {
            log.error("OCRé™çº§æ–¹æ¡ˆä¹Ÿå¤±è´¥", e);
            throw new InvoiceExtractException("æ‰€æœ‰æå–æ–¹æ¡ˆå‡å¤±è´¥");
        }
    }
}
```

### 5.5 ç›‘æ§ä¸æŒ‡æ ‡

å¦‚æœæœ‰å¿…è¦æœ‰æ¡ä»¶ï¼ŒåŸºäºPrometheusçš„ç›‘æ§åŠ ä¸Šå¯ä»¥è¯´æ˜¯ä¸€ä¸ª`èµ„æ·±ç¨‹åºçŒ¿`çš„åŸºæœ¬ç´ å…»äº†ï¼ŒåŒæ ·ç»™ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹

```java
@Component
@Slf4j
public class InvoiceExtractMetrics {
    
    private final MeterRegistry meterRegistry;
    
    // æå–æˆåŠŸç‡
    private final Counter successCounter;
    private final Counter failureCounter;
    
    // å¤„ç†æ—¶é—´ç›´æ–¹å›¾
    private final Timer extractTimer;
    
    // å›¾ç‰‡è´¨é‡åˆ†å¸ƒ
    private final DistributionSummary qualitySummary;
    
    public InvoiceExtractMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        
        this.successCounter = Counter.builder("invoice.extract.success")
            .description("å‘ç¥¨æå–æˆåŠŸæ¬¡æ•°")
            .register(meterRegistry);
        
        this.failureCounter = Counter.builder("invoice.extract.failure")
            .description("å‘ç¥¨æå–å¤±è´¥æ¬¡æ•°")
            .register(meterRegistry);
        
        this.extractTimer = Timer.builder("invoice.extract.duration")
            .description("å‘ç¥¨æå–è€—æ—¶")
            .publishPercentiles(0.5, 0.95, 0.99)
            .register(meterRegistry);
        
        this.qualitySummary = DistributionSummary.builder("invoice.image.quality")
            .description("å‘ç¥¨å›¾ç‰‡è´¨é‡è¯„åˆ†")
            .register(meterRegistry);
    }
    
    public void recordSuccess(long duration, double quality) {
        successCounter.increment();
        extractTimer.record(duration, TimeUnit.MILLISECONDS);
        qualitySummary.record(quality);
    }
    
    public void recordFailure(String errorType) {
        failureCounter.increment();
        meterRegistry.counter("invoice.extract.error." + errorType).increment();
    }
}
```

## å…­ã€éƒ¨ç½²æ–¹æ¡ˆ

### 6.1 Dockerå®¹å™¨åŒ–

```dockerfile
# Dockerfile
FROM openjdk:17-jdk-slim as builder
WORKDIR /D04-invoice-extraction
COPY . .
RUN chmod +x ./mvnw
RUN ./mvnw clean package -DskipTests

FROM openjdk:17-jdk-slim
WORKDIR /D04-invoice-extraction

# å®‰è£…Tesseract OCRï¼ˆç”¨äºé™çº§æ–¹æ¡ˆï¼‰
RUN apt-get update && apt-get install -y \
    tesseract-ocr \
    tesseract-ocr-chi-sim \
    libtesseract-dev \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶åº”ç”¨
COPY --from=builder /D04-invoice-extraction/target/D04-invoice-extraction-0.0.1-SNAPSHOT.jar app.jar
COPY --from=builder /D04-invoice-extraction/tessdata /usr/share/tessdata

# åˆ›å»ºérootç”¨æˆ·
RUN useradd -m -u 1000 spring
USER spring

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar", "--spring.ai.zhipuai.api-key=${ZHIPU_KEY}"]
```

### 6.2 Kuberneteséƒ¨ç½²

```yaml
# invoice-extract-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: invoice-extract-service
  namespace: finance
spec:
  replicas: 3
  selector:
    matchLabels:
      app: invoice-extract
  template:
    metadata:
      labels:
        app: invoice-extract
    spec:
      containers:
      - name: invoice-extract
        image: xxx/invoice-extract:1.0.0
        ports:
        - containerPort: 8080
        env:
        - name: ZHIPU_KEY
          valueFrom:
            secretKeyRef:
              name: ai-secrets
              key: zhipu-key
        - name: ALIYUN_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: aliyun-secrets
              key: access-key-id
        - name: ALIYUN_ACCESS_KEY_SECRET
          valueFrom:
            secretKeyRef:
              name: aliyun-secrets
              key: access-key-secret
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
---
apiVersion: v1
kind: Service
metadata:
  name: invoice-extract-service
  namespace: finance
spec:
  selector:
    app: invoice-extract
  ports:
  - port: 80
    targetPort: 8080
  type: ClusterIP
```

## ä¸ƒã€å¤§æ¨¡å‹æå–æ–¹æ¡ˆ VS ä¼ ç»ŸOCRå‘ç¥¨è¯†åˆ«æ–¹æ¡ˆ

æœ€åæˆ‘ä»¬ä¸‹æ¥çœ‹ä¸€ä¸‹ï¼Œè¿™ä¸ªå¤§æ¨¡å‹çš„å®ç°æ–¹æ¡ˆï¼Œä¸ä¼ ç»Ÿçš„å‘ç¥¨è¯†åˆ«æ–¹æ¡ˆä¸¤è€…ä¹‹é—´æœ‰ä»€ä¹ˆå·®å¼‚

### 7.1 ä¼ ç»Ÿæ–¹æ¡ˆæŠ€æœ¯æ¶æ„

ä¸‹é¢æ˜¯ä¸€ä¸ªç»å…¸çš„ä¼ ç»Ÿå‘ç¥¨è¯†åˆ«æ–¹æ¡ˆ

```
%%{init: { "theme": "base", "themeVariables": { "primaryColor": "#ffffff", "secondaryColor": "#f9f9f9", "tertiaryColor": "#eeea", "textColor": "#333", "fontSize": "16px", "subgraph_border_color": "#666", "subgraph_fill": "#f0f0f0"} } }%%
graph TB
    %% å…¨å±€æ ·å¼é…ç½®ï¼šæå‡ç ”å‘è§†è§’çš„ä¸“ä¸šå¯è¯»æ€§
    style Input fill:#fafafa,stroke:#333,stroke-width:1.5px,font-weight:bold
    style Output fill:#ececff,stroke:#333,stroke-width:1.5px,font-weight:bold
    linkStyle default stroke:#666,stroke-width:1px,color:#333

    subgraph A1["ä¼ ç»ŸOCRå‘ç¥¨è¯†åˆ«ç³»ç»Ÿ"]
        
        direction TB  // æ•´ä½“æ”¹ä¸ºè‡ªä¸Šè€Œä¸‹ï¼Œç¬¦åˆç ”å‘å¯¹æµç¨‹çš„é˜…è¯»ä¹ æƒ¯
        
        %% é¢„å¤„ç†é˜¶æ®µï¼šè§†è§‰å¼ºåŒ–+å‘½åç²¾å‡†åŒ–
        subgraph A2["1. å›¾åƒé¢„å¤„ç†é˜¶æ®µ"]
            style A2 fill:#e1f5fe,stroke:#01579b,stroke-width:1px,opacity:0.5
            direction LR
            P1[å›¾åƒç°åº¦åŒ–]
            P2[äºŒå€¼åŒ–å¤„ç†]
            P3[å™ªå£°å»é™¤]
            P4[å€¾æ–œæ ¡æ­£]
            P5[ç‰ˆé¢åŒºåŸŸåˆ†æ]
            %% æµç¨‹ä¸²è”ï¼šç®€åŒ–ç®­å¤´ï¼Œæå‡è¿è´¯æ€§
            P1 --> P2 --> P3 --> P4 --> P5
        end
        
        %% OCRè¯†åˆ«é˜¶æ®µï¼šè¡¥å……é€»è¾‘æ ‡æ³¨
        subgraph A3["2. OCRå­—ç¬¦è¯†åˆ«é˜¶æ®µ"]
            style A3 fill:#f3e5f5,stroke:#4a148c,stroke-width:1px,opacity:0.5
            direction LR
            O1[å­—ç¬¦åˆ†å‰²]
            O2[ç‰¹å¾æå–<small>ï¼ˆè½®å»“/çº¹ç†ï¼‰</small>]
            O3[å­—ç¬¦è¯†åˆ«<small>ï¼ˆæ¨¡æ¿/æœºå™¨å­¦ä¹ ï¼‰</small>]
            O4[å­—ç¬¦åˆå¹¶<small>ï¼ˆè¡Œ/å­—æ®µçº§ï¼‰</small>]
            O1 --> O2 --> O3 --> O4
        end
        
        %% æ¨¡æ¿åŒ¹é…é˜¶æ®µï¼šå‘½åæ›´ç²¾å‡†
        subgraph A4["3. æ¨¡æ¿åŒ¹é…æå–é˜¶æ®µ"]
            style A4 fill:#fff3e0,stroke:#e65100,stroke-width:1px,opacity:0.5
            direction LR
            T1[åŠ è½½å‘ç¥¨å“ç±»é¢„å®šä¹‰æ¨¡æ¿]
            T2[å­—æ®µåæ ‡å®šä½]
            T3[ç›®æ ‡å­—æ®µæå–]
            T4[æ­£åˆ™è§„åˆ™åˆç­›]
            T1 --> T2 --> T3 --> T4
        end
        
        %% è§„åˆ™å¤„ç†é˜¶æ®µï¼šè¡¥å……é€»è¾‘é—­ç¯æç¤º
        subgraph A5["4. ä¸šåŠ¡è§„åˆ™æ ¡éªŒé˜¶æ®µ"]
            style A5 fill:#c8e6c9,stroke:#2e7d32,stroke-width:1px,opacity:0.5
            direction LR
            R1[è¡Œä¸šè§„åˆ™å¼•æ“]
            R2[å…³é”®å­—ç²¾å‡†åŒ¹é…]
            R3[å­—æ®µæ ¼å¼éªŒè¯<small>å¦‚ç¨å·/é‡‘é¢</small>]
            R4[è·¨å­—æ®µé€»è¾‘æ ¡éªŒ<small>ä»·ç¨åˆè®¡</small>]
            R1 --> R2 --> R3 --> R4
        end
        
        %% åå¤„ç†é˜¶æ®µï¼šè¡¥å……äººå·¥æ ¸éªŒçš„é—­ç¯é€»è¾‘ï¼ˆç ”å‘å…³æ³¨çš„å¼‚å¸¸æµç¨‹ï¼‰
        subgraph A6["5. ç»“æœåå¤„ç†é˜¶æ®µ"]
            style A6 fill:#fce4ec,stroke:#ad1457,stroke-width:1px,opacity:0.5
            direction LR
            H1[æ•°æ®æ¸…æ´—<small>å»é‡/è¡¥ç©º</small>]
            H2[æ ¼å¼æ ‡å‡†åŒ–<small>ç»Ÿä¸€JSON/DBæ ¼å¼</small>]
            H3{äººå·¥æ ¸éªŒ}
            H4[æ¨¡æ¿è¿­ä»£æ›´æ–°]
            
            H1 --> H2 --> H3
            H3 -- æ ¸éªŒé€šè¿‡ --> Output[ç»“æ„åŒ–å‘ç¥¨æ•°æ®]
            H3 -- æ ¸éªŒä¸é€šè¿‡ --> H4 --> P1  
        end
        
        %% ä¸»æµç¨‹ä¸²è”ï¼šç®€åŒ–çº¿æ¡ï¼Œé€»è¾‘æ›´é¡º
        Input[å‘ç¥¨å›¾ç‰‡è¾“å…¥] --> P1
        P5 --> O1
        O4 --> T1
        T4 --> R1
        R4 --> H1
    end
    
    %% æ ·å¼ä¼˜åŒ–ï¼šä¿ç•™åŸæœ‰é…è‰²ä½“ç³»ï¼Œå¢å¼ºè§†è§‰åŒºåˆ†åº¦
    classDef preprocess fill:#e1f5fe,stroke:#01579b,stroke-width:1.5px,font-size:12px
    classDef ocr fill:#f3e5f5,stroke:#4a148c,stroke-width:1.5px,font-size:12px
    classDef template fill:#fff3e0,stroke:#e65100,stroke-width:1.5px,font-size:12px
    classDef rule fill:#c8e6c9,stroke:#2e7d32,stroke-width:1.5px,font-size:12px
    classDef post fill:#fce4ec,stroke:#ad1457,stroke-width:1.5px,font-size:12px

    class P1,P2,P3,P4,P5 preprocess
    class O1,O2,O3,O4 ocr
    class T1,T2,T3,T4 template
    class R1,R2,R3,R4 rule
    class H1,H2,H3,H4 post
```


![](/imgs/column/springai/D03-08.png)

åœ¨ä¼ ç»Ÿçš„æ–¹æ¡ˆä¸­ï¼Œä¸»è¦åˆ†äº”éƒ¨åˆ†

1. å›¾åƒé¢„å¤„ç†
2. OCRå­—ç¬¦è¯†åˆ«
3. æ¨¡æ¿åŒ¹é…æå–
4. ä¸šåŠ¡è§„åˆ™æ ¡éªŒ
5. ç»“æœå¤„ç†


å…¶ä¸­æ ¸å¿ƒçš„å®ç°ä¼šèšç„¦åœ¨ `æ¨¡æ¿åŒ¹é… + ä¸šåŠ¡è§„åˆ™æ ¡éªŒ`ï¼ŒåŒæ ·ä¹Ÿå› ä¸ºä¸åŒçš„æ¨¡æ¿çš„å·®å¼‚æ€§ï¼Œå¯¼è‡´æ•´ä¸ªæ–¹æ¡ˆçš„æŒ‘æˆ˜ç‚¹åœ¨äº


| é—®é¢˜ç±»åˆ« |  å…·ä½“è¡¨ç° |
| --- | --- |
| æ¨¡æ¿ä¾èµ– |  æ¯æ–°å¢ä¸€ç§å‘ç¥¨ç±»å‹éœ€é…ç½®æ–°æ¨¡æ¿ |
| ä½ç½®æ•æ„Ÿ |  å‘ç¥¨ç‰ˆå¼å˜åŒ–å¯¼è‡´æå–å¤±è´¥ |
| æ³›åŒ–èƒ½åŠ›å·® | æ— æ³•å¤„ç†æœªè§è¿‡çš„å‘ç¥¨æ ¼å¼ |
| è§„åˆ™å¤æ‚ |  ç»´æŠ¤å¤§é‡æ­£åˆ™è¡¨è¾¾å¼å’Œè§„åˆ™ |
| å®¹é”™æ€§å·® |  OCRè¯†åˆ«é”™è¯¯ç›´æ¥å¯¼è‡´æå–é”™è¯¯ |
| è¯­ä¹‰ç†è§£ç¼ºå¤± |  æ— æ³•ç†è§£å­—æ®µé—´çš„å…³ç³»å’Œå«ä¹‰ |
| ç»´æŠ¤æˆæœ¬é«˜ | éœ€è¦æŒç»­ç»´æŠ¤æ¨¡æ¿å’Œè§„åˆ™åº“ |


### 7.2 å¤§æ¨¡å‹æ–¹æ¡ˆ VS ä¼ ç»Ÿæ–¹æ¡ˆ

åŸºäºæŠ€æœ¯æ–¹æ¡ˆçš„å¯¹æ¯”

| ç»´åº¦ |  ä¼ ç»ŸOCRæ–¹æ¡ˆ  | å¤§æ¨¡å‹æ™ºèƒ½ä½“æ–¹æ¡ˆ |
| --- | --- | --- |
| æ ¸å¿ƒæŠ€æœ¯ |  å›¾åƒå¤„ç† + è§„åˆ™å¼•æ“  | å¤šæ¨¡æ€å¤§æ¨¡å‹ + è¯­ä¹‰ç†è§£ |
| å¤„ç†é€»è¾‘ |  "å¦‚æœ-é‚£ä¹ˆ"è§„åˆ™é“¾   | ç«¯åˆ°ç«¯è¯­ä¹‰ç†è§£ |
| æ¨¡æ¿ä¾èµ– |  å¼ºä¾èµ–ï¼Œæ¯æ¬¾å‘ç¥¨éœ€æ¨¡æ¿  | é›¶æ¨¡æ¿ï¼Œé€šç”¨å¤„ç† |
| æ³›åŒ–èƒ½åŠ› |  å·®ï¼Œåªèƒ½å¤„ç†å·²çŸ¥æ ¼å¼   | å¼ºï¼Œèƒ½å¤„ç†æœªè§æ ¼å¼ |
| è¯­ä¹‰ç†è§£ |  æ— ï¼Œä»…æ–‡æœ¬åŒ¹é…  | å¼ºï¼Œç†è§£å­—æ®µå«ä¹‰å’Œå…³ç³» |
| å®¹é”™èƒ½åŠ› |  å·®ï¼ŒOCRé”™è¯¯å³å¤±è´¥   | å¼ºï¼Œèƒ½æ ¹æ®ä¸Šä¸‹æ–‡çº æ­£ |
| ç»´æŠ¤æˆæœ¬ |  é«˜ï¼Œéœ€æŒç»­ç»´æŠ¤æ¨¡æ¿è§„åˆ™  | ä½ï¼ŒåŸºæœ¬æ— éœ€ç»´æŠ¤ |
| æ‰©å±•æ€§ | å·®ï¼Œæ–°å¢ç±»å‹éœ€å¼€å‘  | å¼ºï¼Œé€šè¿‡Promptè°ƒæ•´å³å¯ |
| å‡†ç¡®æ€§ | é«˜ | ä½ï¼Œç›¸è¾ƒäºä¼ ç»Ÿæ–¹æ¡ˆæ¯ä¸€æ¬¡çš„è¾“å‡ºéƒ½å­˜åœ¨ä¸ç¡®å®šæ€§ |

ä»æ€§èƒ½ã€å®ç°è§’åº¦è¿›è¡Œå¯¹æ¯”

|æŒ‡æ ‡ |ä¼ ç»ŸOCRæ–¹æ¡ˆ  |å¤§æ¨¡å‹æ™ºèƒ½ä½“æ–¹æ¡ˆ|
| --- | --- | --- |
|é¦–æ¬¡éƒ¨ç½²æ—¶é—´ |2-4å‘¨ï¼ˆæ¨¡æ¿å¼€å‘ï¼‰ |1-3å¤©ï¼ˆPromptè°ƒä¼˜ï¼‰|
|æ–°å¢æ¨¡æ¿æ—¶é—´ |1-3å¤©/æ¨¡æ¿  |å‡ ä¹ä¸º0|
|å¤„ç†å‡†ç¡®ç‡  |70-85%ï¼ˆå¤æ‚åœºæ™¯ï¼‰ |90-98%|
|æ³›åŒ–èƒ½åŠ› |åªèƒ½å¤„ç†å·²çŸ¥æ¨¡æ¿ |å¯å¤„ç†æœªçŸ¥æ ¼å¼|
|ç»´æŠ¤äººåŠ› |å…¨èŒ1-2äºº |å…¼èŒ0.5äºº|
|å®¹é”™èƒ½åŠ› |ä½ï¼ˆä¸¥æ ¼ä¾èµ–OCRè´¨é‡ï¼‰ |é«˜ï¼ˆè¯­ä¹‰çº é”™ï¼‰|
|å¤„ç†é€Ÿåº¦ |å¿«ï¼ˆ2-5ç§’ï¼‰  |ä¸­ç­‰ï¼ˆ3-10ç§’ï¼‰|
|ç¡¬ä»¶æˆæœ¬ |ä½ï¼ˆCPUå³å¯ï¼‰ |é«˜ï¼ˆéœ€è¦GPU/APIï¼‰|


ä»ç®€å•çš„æ–¹æ¡ˆå¯¹æ¯”ï¼ŒåŸºäºå¤§æ¨¡å‹çš„å‘ç¥¨æå–æ™ºèƒ½ä½“ï¼Œå…¶**çµæ´»æ€§ã€å¯ç»´æŠ¤æ€§ã€æœªæ¥é€‚åº”æ€§ï¼ˆå¦‚å›½é™…ä¸šåŠ¡ï¼‰**æ–¹é¢æ˜æ˜¾ç”±äºä¼ ç»Ÿçš„OCRæ–¹æ¡ˆï¼Œå½“ç„¶åœ¨å‡†ç¡®åº¦ä¸Šï¼Œè‹¥æœ‰å®šå‘è°ƒæ•™çš„å°æ¨¡å‹ï¼Œå…¶å‡†ç¡®ç‡å®Œå…¨æœ‰å¯èƒ½ä¼˜äºä¼ ç»Ÿçš„OCRæ–¹æ¡ˆï¼Œå½“ç„¶å®ƒçš„æˆæœ¬æ¯”ä¼ ç»Ÿçš„è¦é«˜ï¼Œä½†è‹¥æ˜¯è€ƒè™‘åˆ°ç»´æŠ¤çš„å‘˜å·¥æˆæœ¬ï¼Œé‚£æ˜¾ç„¶å¤§æ¨¡å‹çš„ä¼˜åŠ¿è¿˜æ˜¯å¾ˆæ˜æ˜¾çš„ï¼ˆå½“ç„¶å¦‚æœå·²ç»æœ‰æˆç†Ÿå¯ç”¨çš„æ–¹æ¡ˆï¼Œèƒ½ä¸æ”¹å°±ä¸è¦æ”¹ğŸ˜Šï¼‰


## å…«ã€å°ç»“

æœ¬æ–‡ä»¥å‘ç¥¨æå–ä¸ºåˆ‡å…¥ç‚¹ï¼Œæ„å»ºäº†ä¸€ä¸ªå¯ç”Ÿäº§ä½¿ç”¨çš„åŸºäºå¤§æ¨¡å‹çš„å‘ç¥¨æå–æ™ºèƒ½ä½“ï¼Œä»å…·ä½“çš„è·¯å¾„æ¥çœ‹ï¼Œè¿™ä¸ªç³»ç»Ÿçš„æ™®é€‚æ€§å¾ˆé«˜ï¼ŒåŒæ ·å¯ä»¥ç”¨äºå…¶ä»–åŸºäºå›¾ç‰‡çš„ç»“æ„åŒ–ä¿¡æ¯æå–åœºæ™¯ï¼ˆæ¯”å¦‚å¿«é€’é¢å•çš„ä¿¡æ¯æå–ã€èº«ä»½è¯ä¿¡æ¯æå–ã€ç®€å†ä¿¡æ¯æå–ç­‰ï¼‰

### ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½å•å…ƒï¼š

1. **å¤šæ¨¡æ€ç†è§£**ï¼šåŸºäºå¤§æ¨¡å‹å‡†ç¡®ç†è§£å›¾ç‰‡å†…å®¹
2. **æ™ºèƒ½æå–**ï¼šé›¶é…ç½®æå–ä»»æ„ç‰ˆå¼å‘ç¥¨ä¿¡æ¯
3. **æ•°æ®éªŒè¯**ï¼šé€šè¿‡Function Callingå®ç°å­—æ®µéªŒè¯
4. **é™çº§ç­–ç•¥**ï¼šä¼ ç»ŸOCRå¤‡ç”¨æ–¹æ¡ˆä¿è¯æœåŠ¡å¯ç”¨æ€§
5. **ç”Ÿäº§å°±ç»ª**ï¼šåŒ…å«ç¼“å­˜ã€ç›‘æ§ã€æ‰¹é‡å¤„ç†ç­‰ä¼ä¸šçº§åŠŸèƒ½

### æŠ€æœ¯çŸ¥è¯†ç‚¹

ä¸‹é¢æ˜¯æœ¬æ–‡ä¸­æ¶‰åŠåˆ°çš„ç›¸å…³æŠ€æœ¯ç‚¹ï¼ˆé‡ç‚¹åœ¨å¤§æ¨¡å‹é¢†åŸŸï¼‰

- å¤šæ¨¡æ€
- å›¾æ–‡è¯†åˆ«
- æç¤ºè¯å·¥ç¨‹
- å¤§æ¨¡å‹çš„åˆ†é¡µäº¤äº’å¦‚ä½•å®ç°
- Function Call
- ç»“æ„åŒ–è¾“å‡º
- ä¸Šä¸‹æ–‡çª—å£


å¯¹äºå¤§æ¨¡å‹åº”ç”¨å¼€å‘æ„Ÿå…´è¶£çš„å°ä¼™ä¼´ï¼Œæˆ–è€…å¯¹ä¸Šé¢æåˆ°çš„çŸ¥è¯†ç‚¹æœ‰ç–‘æƒ‘çš„å°ä¼™ä¼´ï¼Œä¸å¦¨çœ‹çœ‹ä»¥ä¸‹å‡ ç¯‡å†…å®¹ï¼ˆæ¯ç¯‡è€—æ—¶ä¸è¶…è¿‡äº”åˆ†é’ŸğŸ˜Šï¼‰

- [LLM åº”ç”¨å¼€å‘æ˜¯ä»€ä¹ˆï¼šé›¶åŸºç¡€ä¹Ÿå¯ä»¥è¯»æ‡‚çš„ç§‘æ™®æ–‡(æç®€ç‰ˆ)](https://mp.weixin.qq.com/s/qCn8x2XO2shA8MheYbHq0w)
- [å¤§æ¨¡å‹åº”ç”¨å¼€å‘ç³»åˆ—æ•™ç¨‹ï¼šåº-ä¸ºä»€ä¹ˆä½ â€œä¼šç”¨ LLMâ€ï¼Œä½†åšä¸å‡ºå¤æ‚åº”ç”¨ï¼Ÿ](https://mp.weixin.qq.com/s/2GXBNOUq3jlysipftz8TpA)
- [å¤§æ¨¡å‹åº”ç”¨å¼€å‘ç³»åˆ—æ•™ç¨‹ï¼šç¬¬ä¸€ç« LLMåˆ°åº•åœ¨åšä»€ä¹ˆï¼Ÿ](https://mp.weixin.qq.com/s/v-z6EHY300ElOxdGPdzc0w)
- [å¤§æ¨¡å‹åº”ç”¨å¼€å‘ç³»åˆ—æ•™ç¨‹ï¼šç¬¬äºŒç«  æ¨¡å‹ä¸æ˜¯é‡ç‚¹ï¼Œå‚æ•°æ‰æ˜¯ä½ çœŸæ­£çš„æ§åˆ¶é¢æ¿](https://mp.weixin.qq.com/s/t_BuAW9i0npcaJdua3Am2Q)
- [å¤§æ¨¡å‹åº”ç”¨å¼€å‘ç³»åˆ—æ•™ç¨‹ï¼šç¬¬ä¸‰ç«  ä¸ºä»€ä¹ˆæˆ‘çš„Promptè¡¨ç°å¾ˆç³Ÿï¼Ÿ](https://mp.weixin.qq.com/s/vzt0bGwcfnASOiBa0Kc7VQ)
- [å¤§æ¨¡å‹åº”ç”¨å¼€å‘ç³»åˆ—æ•™ç¨‹ï¼šç¬¬å››ç« Prompt çš„å·¥ç¨‹åŒ–ç»“æ„è®¾è®¡](https://mp.weixin.qq.com/s/Nk-N34TLJVCTI5F4k5rGaQ)
- [å¤§æ¨¡å‹åº”ç”¨å¼€å‘ç³»åˆ—æ•™ç¨‹ï¼šç¬¬äº”ç«  ä» Prompt åˆ° Prompt æ¨¡æ¿ä¸å·¥ç¨‹æ²»ç†](https://mp.weixin.qq.com/s/ZQbztqBq7_PzynG06N4-mg)
- [å¤§æ¨¡å‹åº”ç”¨å¼€å‘ç³»åˆ—æ•™ç¨‹ï¼šç¬¬å…­ç«  ä¸Šä¸‹æ–‡çª—å£çš„çœŸå®è¾¹ç•Œ](https://mp.weixin.qq.com/s/nnKspRO87xbrn4-LBV3RNA)
- [å¤§æ¨¡å‹åº”ç”¨å¼€å‘å®æˆ˜ï¼šä¸¤ç™¾è¡Œå®ç°ä¸€ä¸ªè‡ªç„¶è¯­è¨€åœ°å€æå–æ™ºèƒ½ä½“](https://mp.weixin.qq.com/s/96rHyp_gBUgmA2dhSbzNww)
